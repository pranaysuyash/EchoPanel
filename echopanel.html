<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EchoPanel – Prototype</title>
    <style>
      :root {
        --bg0: #0b0c10;
        --bg1: #0f1117;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.09);
        --stroke: rgba(255, 255, 255, 0.1);
        --stroke2: rgba(255, 255, 255, 0.16);
        --text: rgba(255, 255, 255, 0.9);
        --muted: rgba(255, 255, 255, 0.62);
        --muted2: rgba(255, 255, 255, 0.42);
        --accent: #7dd3fc;
        --accent2: #a78bfa;
        --good: #34d399;
        --warn: #fbbf24;
        --bad: #fb7185;

        --r12: 12px;
        --r16: 16px;
        --r20: 20px;

        --shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        --shadow2: 0 2px 10px rgba(0, 0, 0, 0.35);
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'SF Pro Display',
          'SF Pro Text',
          'Segoe UI',
          Roboto,
          Helvetica,
          Arial;
        color: var(--text);
        background:
          radial-gradient(
            1200px 700px at 20% 10%,
            rgba(167, 139, 250, 0.22),
            transparent 60%
          ),
          radial-gradient(
            900px 600px at 80% 30%,
            rgba(125, 211, 252, 0.18),
            transparent 60%
          ),
          radial-gradient(
            700px 500px at 50% 90%,
            rgba(52, 211, 153, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow: hidden;
      }

      body:before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
        mix-blend-mode: overlay;
        pointer-events: none;
        opacity: 0.35;
      }

      .app {
        height: 100%;
        display: grid;
        grid-template-columns: 290px 1fr 420px;
        grid-template-rows: 64px 1fr 92px;
        gap: 14px;
        padding: 14px;
        box-sizing: border-box;
      }

      .glass {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: var(--r20);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(18px) saturate(140%);
        -webkit-backdrop-filter: blur(18px) saturate(140%);
        overflow: hidden;
        position: relative;
      }

      .topbar {
        grid-column: 1 / 4;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 10px;
        border-radius: 14px;
        min-width: 0;
      }
      .logo {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        background:
          radial-gradient(
            circle at 30% 30%,
            rgba(255, 255, 255, 0.25),
            transparent 55%
          ),
          linear-gradient(
            135deg,
            rgba(125, 211, 252, 0.95),
            rgba(167, 139, 250, 0.95)
          );
        box-shadow: 0 10px 25px rgba(125, 211, 252, 0.14);
        position: relative;
      }
      .logo:after {
        content: '';
        position: absolute;
        inset: 8px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        opacity: 0.9;
      }
      .brand .title {
        display: flex;
        flex-direction: column;
        line-height: 1.05;
        min-width: 0;
      }
      .brand .title strong {
        font-size: 14px;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .brand .title span {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.04);
        transition:
          transform 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease;
        user-select: none;
      }
      .pill:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
      }
      .seg {
        display: flex;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.03);
      }
      .seg button {
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        transition:
          background 0.15s ease,
          color 0.15s ease;
      }
      .seg button.active {
        background: rgba(255, 255, 255, 0.09);
        color: var(--text);
      }
      .btn {
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition:
          transform 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.07);
      }

      .sidebar {
        grid-row: 2 / 4;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .search {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        border-radius: 16px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.04);
      }
      .search input {
        background: transparent;
        border: 0;
        outline: none;
        color: var(--text);
        width: 100%;
        font-size: 13px;
      }
      .search .k {
        font-size: 11px;
        color: var(--muted2);
        border: 1px solid var(--stroke);
        padding: 4px 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
      }

      .sectionTitle {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.22px;
        padding: 2px 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow: auto;
        padding-right: 4px;
      }
      .session {
        padding: 10px 10px;
        border-radius: 16px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        transition:
          transform 0.18s ease,
          background 0.18s ease,
          border-color 0.18s ease;
      }
      .session:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
      }
      .session.active {
        border-color: rgba(125, 211, 252, 0.45);
        background: rgba(125, 211, 252, 0.1);
      }
      .session .name {
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .badge {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.75);
        border: 1px solid var(--stroke);
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
      }
      .session .meta {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
      }

      .main {
        grid-column: 2;
        grid-row: 2;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }
      .mainHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-bottom: 1px solid var(--stroke);
      }
      .mainHeader .hgroup {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }
      .mainHeader .hgroup strong {
        font-size: 14px;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .mainHeader .hgroup span {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .speakers {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .avatar {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.78);
        position: relative;
        transition:
          transform 0.18s ease,
          border-color 0.18s ease,
          box-shadow 0.18s ease;
        cursor: pointer;
        user-select: none;
      }
      .avatar.active {
        border-color: rgba(125, 211, 252, 0.55);
        box-shadow: 0 0 0 4px rgba(125, 211, 252, 0.1);
        transform: translateY(-1px);
      }

      .transcript {
        flex: 1;
        overflow: auto;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 0;
        position: relative;
      }

      .liveChip {
        position: sticky;
        bottom: 10px;
        align-self: flex-end;
        display: none;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(125, 211, 252, 0.35);
        background: rgba(125, 211, 252, 0.12);
        color: rgba(255, 255, 255, 0.92);
        cursor: pointer;
        user-select: none;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
        margin-top: 6px;
      }
      .liveChip.show {
        display: inline-flex;
      }
      .liveChip .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(52, 211, 153, 0.9);
        box-shadow: 0 0 0 5px rgba(52, 211, 153, 0.12);
      }
      .liveChip .hint {
        color: rgba(255, 255, 255, 0.7);
      }

      .utter {
        display: grid;
        grid-template-columns: 40px 1fr;
        gap: 10px;
        align-items: start;
        padding: 10px 10px;
        border-radius: 18px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        transition:
          transform 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease;
        position: relative;
      }
      .utter:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.055);
      }
      .utter.active {
        border-color: rgba(167, 139, 250, 0.55);
        background: rgba(167, 139, 250, 0.1);
      }
      .utter.focused {
        border-color: rgba(125, 211, 252, 0.55);
        box-shadow: 0 0 0 4px rgba(125, 211, 252, 0.1);
      }
      .utter.lens {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.18);
        box-shadow: var(--shadow2);
      }
      .utter.dim {
        opacity: 0.45;
        filter: saturate(0.9);
      }

      .metaCol {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
        padding-top: 2px;
      }
      .tstamp {
        font-size: 11px;
        color: var(--muted2);
        border: 1px solid var(--stroke);
        padding: 3px 7px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.02);
        user-select: none;
        font-variant-numeric: tabular-nums;
      }
      .who {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.04);
        user-select: none;
      }
      .contentCol {
        min-width: 0;
      }
      .lineTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 6px;
      }
      .name {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .name .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: rgba(125, 211, 252, 0.75);
        box-shadow: 0 0 0 4px rgba(125, 211, 252, 0.12);
      }
      .actions {
        display: flex;
        gap: 8px;
        align-items: center;
        opacity: 0.92;
      }
      .iconbtn {
        width: 32px;
        height: 28px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        color: rgba(255, 255, 255, 0.82);
        transition:
          transform 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
      }
      .iconbtn:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
      }

      .text {
        position: relative;
        font-size: 14px;
        line-height: 1.45;
        color: rgba(255, 255, 255, 0.92);
        word-wrap: break-word;
        overflow-wrap: anywhere;
      }

      .mark {
        padding: 2px 6px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.04);
        cursor: pointer;
        transition:
          transform 0.15s ease,
          border-color 0.15s ease,
          background 0.15s ease;
      }
      .mark:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.07);
      }
      .mark.person {
        border-color: rgba(125, 211, 252, 0.35);
        background: rgba(125, 211, 252, 0.12);
      }
      .mark.org {
        border-color: rgba(167, 139, 250, 0.35);
        background: rgba(167, 139, 250, 0.12);
      }
      .mark.topic {
        border-color: rgba(251, 191, 36, 0.35);
        background: rgba(251, 191, 36, 0.1);
      }

      .chips {
        display: none;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .utter.lens .chips {
        display: flex;
      }
      .chip {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.84);
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
        transition:
          background 0.15s ease,
          border-color 0.15s ease,
          transform 0.15s ease;
        user-select: none;
      }
      .chip:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
      }
      .chip.good {
        border-color: rgba(52, 211, 153, 0.35);
        background: rgba(52, 211, 153, 0.1);
      }
      .chip.warn {
        border-color: rgba(251, 191, 36, 0.35);
        background: rgba(251, 191, 36, 0.1);
      }
      .chip.bad {
        border-color: rgba(251, 113, 133, 0.35);
        background: rgba(251, 113, 133, 0.1);
      }

      .lensPanel {
        margin-top: 10px;
        padding: 10px 10px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.03);
      }
      .lensPanel .row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }
      .lensPanel strong {
        font-size: 12px;
        letter-spacing: 0.2px;
      }
      .lensPanel .mini {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .miniBtn {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        user-select: none;
        transition:
          transform 0.15s ease,
          border-color 0.15s ease,
          background 0.15s ease;
      }
      .miniBtn:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
      }

      .right {
        grid-column: 3;
        grid-row: 2 / 4;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }
      .rightHeader {
        padding: 12px 14px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .rightHeader strong {
        font-size: 13px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        padding: 12px 14px;
        border-bottom: 1px solid var(--stroke);
        flex-wrap: wrap;
      }
      .tab {
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        font-size: 12px;
        color: var(--muted);
        cursor: pointer;
        user-select: none;
      }
      .tab.active {
        color: var(--text);
        background: rgba(255, 255, 255, 0.09);
      }

      .rightBody {
        flex: 1;
        overflow: auto;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .card {
        border-radius: 18px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        padding: 12px 12px;
      }
      .card h4 {
        margin: 0 0 8px 0;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.2px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .item {
        display: flex;
        gap: 10px;
        padding: 10px 10px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        margin-top: 8px;
      }
      .item .tag {
        min-width: 46px;
        height: 22px;
        border-radius: 999px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        color: rgba(255, 255, 255, 0.78);
      }
      .item .body {
        min-width: 0;
      }
      .item .body .headline {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.92);
        margin-bottom: 4px;
      }
      .item .body .sub {
        font-size: 12px;
        color: var(--muted);
      }
      .pinRow {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .pin {
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        padding: 8px 10px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.86);
        cursor: pointer;
        user-select: none;
        transition:
          transform 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease;
      }
      .pin:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
      }
      .dropzone {
        margin-top: 10px;
        border-radius: 16px;
        border: 1px dashed rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.02);
        padding: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .dropzone.drag {
        border-color: rgba(125, 211, 252, 0.55);
        background: rgba(125, 211, 252, 0.08);
        color: rgba(255, 255, 255, 0.86);
      }

      .timeline {
        grid-column: 2;
        grid-row: 3;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        gap: 12px;
      }
      .scrub {
        flex: 1;
        height: 46px;
        border-radius: 18px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        position: relative;
        overflow: hidden;
        cursor: grab;
      }
      .scrub:active {
        cursor: grabbing;
      }
      .scrub .field {
        position: absolute;
        inset: 0;
        background:
          radial-gradient(
            500px 120px at var(--x, 40%) 60%,
            rgba(125, 211, 252, 0.2),
            transparent 55%
          ),
          radial-gradient(
            480px 120px at calc(var(--x, 40%) + 10%) 60%,
            rgba(167, 139, 250, 0.16),
            transparent 55%
          );
        opacity: 0.9;
      }
      .scrub .ticks {
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.1) 0px,
          rgba(255, 255, 255, 0.1) 1px,
          transparent 1px,
          transparent 24px
        );
        mask-image: linear-gradient(
          90deg,
          transparent,
          black 12%,
          black 88%,
          transparent
        );
        opacity: 0.12;
      }
      .scrub .pos {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        left: var(--x, 40%);
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.08);
      }
      .scrub .beads {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        padding: 0 14px;
        gap: 16px;
        pointer-events: none;
      }
      .bead {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.35);
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.04);
        opacity: 0.8;
      }
      .bead.hot {
        background: rgba(125, 211, 252, 0.85);
        box-shadow: 0 0 0 6px rgba(125, 211, 252, 0.1);
        opacity: 1;
      }
      .timeReadout {
        width: 120px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: flex-end;
      }
      .timeReadout strong {
        font-size: 13px;
        letter-spacing: 0.2px;
      }
      .timeReadout span {
        font-size: 12px;
        color: var(--muted);
      }

      .hint {
        font-size: 11px;
        color: var(--muted2);
      }

      .toastHost {
        position: fixed;
        left: 50%;
        top: 16px;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 999;
        pointer-events: none;
      }
      .toast {
        pointer-events: none;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(20, 22, 30, 0.62);
        backdrop-filter: blur(14px) saturate(140%);
        -webkit-backdrop-filter: blur(14px) saturate(140%);
        color: rgba(255, 255, 255, 0.92);
        font-size: 12px;
        letter-spacing: 0.1px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      }

      .kbdOverlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        z-index: 999;
      }
      .kbdOverlay.show {
        display: flex;
      }
      .kbdCard {
        width: min(620px, 92vw);
        border-radius: 22px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(20, 22, 30, 0.62);
        backdrop-filter: blur(18px) saturate(140%);
        -webkit-backdrop-filter: blur(18px) saturate(140%);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
        padding: 14px;
      }
      .kbdCard h3 {
        margin: 0 0 10px 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.92);
        letter-spacing: 0.2px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .kbdGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .kbdRow {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.03);
        border-radius: 16px;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
      }
      .kbdKey {
        font-variant-numeric: tabular-nums;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.03);
        padding: 4px 8px;
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.88);
        white-space: nowrap;
      }

      .transcript::-webkit-scrollbar,
      .list::-webkit-scrollbar,
      .rightBody::-webkit-scrollbar {
        width: 10px;
      }
      .transcript::-webkit-scrollbar-thumb,
      .list::-webkit-scrollbar-thumb,
      .rightBody::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        border: 3px solid rgba(0, 0, 0, 0);
        background-clip: padding-box;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          transition: none !important;
          animation: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="toastHost" id="toastHost" aria-live="polite"></div>

    <div class="kbdOverlay" id="kbdOverlay" role="dialog" aria-modal="true">
      <div class="kbdCard">
        <h3>
          <span>Keyboard</span>
          <span class="hint">Esc to close</span>
        </h3>
        <div class="kbdGrid">
          <div class="kbdRow">
            <span>Move focus</span><span class="kbdKey">↑ / ↓</span>
          </div>
          <div class="kbdRow">
            <span>Toggle Focus Lens</span><span class="kbdKey">Enter</span>
          </div>
          <div class="kbdRow">
            <span>Pin line</span><span class="kbdKey">P</span>
          </div>
          <div class="kbdRow">
            <span>Jump to Live</span><span class="kbdKey">J</span>
          </div>
          <div class="kbdRow">
            <span>Toggle Follow Live</span><span class="kbdKey">Space</span>
          </div>
          <div class="kbdRow">
            <span>Search</span><span class="kbdKey">Cmd / Ctrl + K</span>
          </div>
          <div class="kbdRow">
            <span>Close / back</span><span class="kbdKey">Esc</span>
          </div>
          <div class="kbdRow">
            <span>Help</span><span class="kbdKey">?</span>
          </div>
          <div class="kbdRow">
            <span>Recording demo</span><span class="kbdKey">Option + R</span>
          </div>
        </div>
      </div>
    </div>

    <div class="app">
      <div class="glass topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <strong>EchoPanel</strong>
            <span>Live transcript, memory pins, and decision beads</span>
          </div>
        </div>

        <div class="controls">
          <div class="seg" id="modeSeg">
            <button class="active" data-mode="live">Live</button>
            <button data-mode="review">Review</button>
            <button data-mode="brief">Brief</button>
          </div>

          <div class="pill" id="statusPill" title="Recording status">
            <span
              id="statusDot"
              style="
                width: 8px;
                height: 8px;
                border-radius: 999px;
                background: rgba(52, 211, 153, 0.9);
                box-shadow: 0 0 0 5px rgba(52, 211, 153, 0.12);
              "
            ></span>
            <span
              id="statusText"
              style="font-size: 12px; color: rgba(255, 255, 255, 0.85)"
              >Listening</span
            >
            <span class="hint">⌥R</span>
          </div>

          <button class="btn" id="newSessionBtn">New Session</button>
          <button class="btn" id="openCompactBtn">Open Compact</button>
        </div>
      </div>

      <aside class="glass sidebar">
        <div class="search">
          <span style="opacity: 0.75">⌘</span>
          <input id="q" placeholder="Search sessions, speakers, keywords" />
          <span class="k">⌘K</span>
        </div>

        <div class="sectionTitle">
          <span>Sessions</span>
          <span class="hint" id="sessionCount">3</span>
        </div>

        <div class="list" id="sessionList"></div>

        <div class="sectionTitle">
          <span>Shortcuts</span>
          <span class="hint">Focus</span>
        </div>

        <div class="card" style="padding: 10px 12px">
          <div class="hint">↑/↓ focus, Enter lens, P pin</div>
          <div class="hint">Space follow, J live, ? help</div>
          <div class="hint">Click highlight: filter (NER)</div>
          <div class="hint">Drag line into Pins</div>
        </div>
      </aside>

      <main class="glass main">
        <div class="mainHeader">
          <div class="hgroup">
            <strong id="sessionTitle">Design Sync</strong>
            <span id="sessionMeta"
              >4 speakers · 18 min · “ship vs polish” tension</span
            >
          </div>
          <div class="speakers" id="speakerRow"></div>
        </div>

        <div class="transcript" id="transcript" aria-label="Transcript">
          <div class="liveChip" id="liveChip" title="Jump to live (J)">
            <span class="dot"></span>
            <span>LIVE</span>
            <span class="hint">J</span>
          </div>
        </div>
      </main>

      <aside class="glass right">
        <div class="rightHeader">
          <strong>Insight Surface</strong>
          <span class="hint" id="rightHint">Live</span>
        </div>

        <div class="tabs" id="rightTabs">
          <div class="tab active" data-tab="summary">Summary</div>
          <div class="tab" data-tab="actions">Actions</div>
          <div class="tab" data-tab="pins">Pins</div>
          <div class="tab" data-tab="context">Context</div>
          <div class="tab" data-tab="entities">Entities</div>
          <div class="tab" data-tab="raw">Raw</div>
        </div>

        <div class="rightBody" id="rightBody"></div>
      </aside>

      <div class="glass timeline">
        <div class="scrub" id="scrub" aria-label="Timeline scrubber">
          <div class="field"></div>
          <div class="ticks"></div>
          <div class="beads" id="beads"></div>
          <div class="pos"></div>
        </div>
        <div class="timeReadout">
          <strong id="timeNow">07:12</strong>
          <span id="timeLabel">Scrub to jump</span>
        </div>
      </div>
    </div>

    <script>
      (() => {
        const sessions = [
          {
            id: 's1',
            name: 'Design Sync',
            badge: 'Live',
            when: 'Today',
            dur: '18m',
            active: true,
          },
          {
            id: 's2',
            name: 'Customer Call: Finch',
            badge: 'Done',
            when: 'Yesterday',
            dur: '42m',
          },
          {
            id: 's3',
            name: 'Hiring Debrief',
            badge: 'Done',
            when: 'Jan 30',
            dur: '31m',
          },
        ];

        const speakers = [
          { id: 'A', name: 'Pranay', short: 'P', color: 'var(--accent)' },
          { id: 'B', name: 'Diksha', short: 'D', color: 'var(--accent2)' },
          { id: 'C', name: 'Ravi', short: 'R', color: 'rgba(251,191,36,.9)' },
          { id: 'D', name: 'Nina', short: 'N', color: 'rgba(52,211,153,.9)' },
        ];

        let lines = [
          {
            t: '06:58',
            s: 'A',
            text: 'If EchoPanel feels like a dashboard, people will abandon it. It has to feel like an instrument panel.',
          },
          {
            t: '07:04',
            s: 'B',
            text: 'Also it has to look native on macOS. Not “web app but with blur”. The blur must feel like material.',
          },
          {
            t: '07:10',
            s: 'C',
            text: 'What’s the one interaction that makes it obviously EchoPanel? Like Figma has the canvas.',
          },
          {
            t: '07:18',
            s: 'A',
            text: 'A Focus Lens on any line. It expands in place with entities, decisions, and actions.',
          },
          {
            t: '07:26',
            s: 'D',
            text: 'And pins as a running brief. Drag a line into pins, then it auto-updates as the meeting evolves.',
          },
          {
            t: '07:35',
            s: 'B',
            text: 'Make the timeline show decision beads. Scrubbing should snap to those beads.',
          },
          {
            t: '07:44',
            s: 'A',
            text: 'Yes. Also, speakers as orbits. Active speaker subtly pulls the transcript field.',
          },
        ];

        const rightModel = {
          summary: [
            {
              tag: 'Now',
              headline: 'Tension: ship vs polish',
              sub: 'Users forgive missing features, not ugly UX.',
            },
            {
              tag: 'Idea',
              headline: 'Focus Lens for any line',
              sub: 'Expand in place: entities, actions, context.',
            },
            {
              tag: 'UI',
              headline: 'Decision beads on timeline',
              sub: 'Scrub snaps to moments that matter.',
            },
          ],
          actions: [
            {
              tag: 'A1',
              headline: 'Define signature interaction spec',
              sub: 'Focus Lens + Pins rail behaviors.',
            },
            {
              tag: 'A2',
              headline: 'Create motion tokens',
              sub: 'Durations, springs, hover lift, snap.',
            },
            {
              tag: 'A3',
              headline: 'Map transcript schema',
              sub: 'speaker, time, confidence, labels.',
            },
          ],
          pins: [],
          pinsIndex: [],
          context: {
            docs: [
              {
                id: 'd1',
                name: 'PRD – EchoPanel v0.3',
                kind: 'PDF',
                status: 'Indexed',
              },
              {
                id: 'd2',
                name: 'Finch – Contract Notes',
                kind: 'DOC',
                status: 'Indexed',
              },
              { id: 'd3', name: 'Brand Voice', kind: 'MD', status: 'Local' },
            ],
            snippets: [
              {
                tag: 'RAG',
                headline: '“Instrument panel” matches PRD North Star',
                sub: 'PRD – EchoPanel v0.3 · North Star',
              },
              {
                tag: 'RAG',
                headline: 'Pins-as-brief maps to “Live Brief” concept',
                sub: 'PRD – EchoPanel v0.3 · Live Brief',
              },
              {
                tag: 'Doc',
                headline: 'Finch wants weekly summaries + action owners',
                sub: 'Finch – Contract Notes · Reporting cadence',
              },
            ],
          },
          entities: {
            people: ['Pranay', 'Diksha', 'Ravi', 'Nina'],
            orgs: ['Finch'],
            products: ['EchoPanel'],
            topics: [
              'Focus Lens',
              'Pins',
              'Decision beads',
              'macOS native feel',
            ],
            tasks: [
              'Define interaction spec',
              'Create motion tokens',
              'Map transcript schema',
            ],
          },
        };

        let activeSpeaker = 'A';
        let lensIndex = -1;
        let focusedIndex = 0;
        let rightTab = 'summary';
        let scrubX = 40;
        let filterQ = '';
        let followLive = true;
        let recording = true;

        const sessionList = document.getElementById('sessionList');
        const speakerRow = document.getElementById('speakerRow');
        const transcript = document.getElementById('transcript');
        const rightBody = document.getElementById('rightBody');
        const rightHint = document.getElementById('rightHint');
        const beads = document.getElementById('beads');
        const scrub = document.getElementById('scrub');
        const timeNow = document.getElementById('timeNow');
        const timeLabel = document.getElementById('timeLabel');
        const modeSeg = document.getElementById('modeSeg');
        const q = document.getElementById('q');
        const liveChip = document.getElementById('liveChip');
        const toastHost = document.getElementById('toastHost');
        const kbdOverlay = document.getElementById('kbdOverlay');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        function escapeHTML(s) {
          return String(s).replace(
            /[&<>"']/g,
            (c) =>
              ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
              })[c],
          );
        }

        function toast(msg) {
          const el = document.createElement('div');
          el.className = 'toast';
          el.textContent = msg;
          toastHost.appendChild(el);
          setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(-2px)';
          }, 900);
          setTimeout(() => el.remove(), 1200);
        }

        function highlightText(text) {
          const rules = [
            { re: /\bPranay\b/g, cls: 'person' },
            { re: /\bDiksha\b/g, cls: 'person' },
            { re: /\bRavi\b/g, cls: 'person' },
            { re: /\bNina\b/g, cls: 'person' },
            { re: /\bFinch\b/g, cls: 'org' },
            { re: /\bEchoPanel\b/g, cls: 'org' },
            { re: /\bFocus Lens\b/g, cls: 'topic' },
            { re: /\bPins\b/g, cls: 'topic' },
            { re: /\bDecision beads\b/g, cls: 'topic' },
            { re: /\bmacOS\b/g, cls: 'topic' },
          ];

          let html = escapeHTML(text);
          rules.forEach((r) => {
            html = html.replace(
              r.re,
              (m) => `<span class="mark ${r.cls}" data-mark="${m}">${m}</span>`,
            );
          });
          return html;
        }

        function shorten(s, n) {
          const str = String(s);
          if (str.length <= n) return str;
          return str.slice(0, n - 1) + '…';
        }

        function matchesFilter(ln) {
          const f = filterQ.trim().toLowerCase();
          if (!f) return true;
          const sp = speakers.find((x) => x.id === ln.s)?.name || '';
          return (
            ln.text.toLowerCase().includes(f) ||
            sp.toLowerCase().includes(f) ||
            ln.t.toLowerCase().includes(f)
          );
        }

        function atBottom(container) {
          const threshold = 26;
          return (
            container.scrollHeight -
              container.scrollTop -
              container.clientHeight <
            threshold
          );
        }

        function updateLiveChip() {
          liveChip.classList.toggle('show', !followLive);
        }

        function scrollToLine(i, behavior = 'smooth') {
          const el = transcript.querySelector(`[data-idx="${i}"]`);
          if (!el) return;
          el.scrollIntoView({ behavior, block: 'center' });
        }

        function jumpToLive() {
          followLive = true;
          updateLiveChip();
          focusedIndex = Math.max(0, lines.length - 1);
          lensIndex = lensIndex === focusedIndex ? lensIndex : lensIndex;
          renderTranscript();
          const last = Math.max(0, lines.length - 1);
          scrollToLine(last, 'smooth');
          toast('Jumped to Live');
        }

        function renderSessions() {
          sessionList.innerHTML = '';
          document.getElementById('sessionCount').textContent = String(
            sessions.length,
          );

          sessions.forEach((s) => {
            const el = document.createElement('div');
            el.className = 'session' + (s.active ? ' active' : '');
            el.innerHTML = `
              <div class="name">
                <span>${escapeHTML(s.name)}</span>
                <span class="badge">${escapeHTML(s.badge)}</span>
              </div>
              <div class="meta">
                <span>${escapeHTML(s.when)}</span>
                <span>${escapeHTML(s.dur)}</span>
              </div>
            `;
            el.addEventListener('click', () => {
              sessions.forEach((x) => (x.active = false));
              s.active = true;
              renderSessions();
              toast('Session: ' + s.name);
            });
            sessionList.appendChild(el);
          });
        }

        function renderSpeakers() {
          speakerRow.innerHTML = '';
          speakers.forEach((sp) => {
            const a = document.createElement('div');
            a.className = 'avatar' + (sp.id === activeSpeaker ? ' active' : '');
            a.title = sp.name;
            a.textContent = sp.short;
            a.style.setProperty(
              'border-color',
              sp.id === activeSpeaker ? sp.color : 'var(--stroke)',
            );
            a.addEventListener('click', () => {
              activeSpeaker = sp.id;
              renderSpeakers();
              renderTranscript();
              toast('Speaker: ' + sp.name);
            });
            speakerRow.appendChild(a);
          });
        }

        function setRightTab(tab) {
          rightTab = tab;
          [...document.querySelectorAll('.tab')].forEach((t) =>
            t.classList.toggle('active', t.dataset.tab === rightTab),
          );
          renderRight();
        }

        function pinLine(i) {
          const txt = shorten(lines[i].text, 52);
          const idx = rightModel.pins.indexOf(txt);
          if (idx === -1) {
            rightModel.pins.unshift(txt);
            rightModel.pinsIndex.unshift(i);
            if (rightModel.pins.length > 12) {
              rightModel.pins.pop();
              rightModel.pinsIndex.pop();
            }
            toast('Pinned');
          } else {
            rightModel.pins.splice(idx, 1);
            rightModel.pinsIndex.splice(idx, 1);
            toast('Unpinned');
          }
          renderRight();
        }

        function jumpTo(i) {
          scrubX = 30 + i * 9;
          scrubX = Math.max(5, Math.min(95, scrubX));
          updateScrub(scrubX);
          focusedIndex = i;
          lensIndex = i;
          followLive = false;
          updateLiveChip();
          renderTranscript();
          scrollToLine(i);
        }

        function renderTranscript() {
          // preserve liveChip node
          const chipNode = liveChip;
          transcript.innerHTML = '';
          transcript.appendChild(chipNode);

          lines.forEach((ln, i) => {
            const sp = speakers.find((x) => x.id === ln.s);
            const isActive = ln.s === activeSpeaker;
            const isLens = i === lensIndex;
            const isMatch = matchesFilter(ln);
            const isFocused = i === focusedIndex;

            const el = document.createElement('div');
            el.className =
              'utter' +
              (isActive ? ' active' : '') +
              (isLens ? ' lens' : '') +
              (isFocused ? ' focused' : '') +
              (!isMatch ? ' dim' : '');

            el.dataset.idx = String(i);
            el.draggable = true;
            el.addEventListener('dragstart', (e) => {
              try {
                e.dataTransfer.setData(
                  'text/plain',
                  JSON.stringify({ type: 'EP_PIN_LINE', index: i }),
                );
                e.dataTransfer.effectAllowed = 'copy';
              } catch {}
            });

            el.innerHTML = `
              <div class="metaCol">
                <div class="tstamp">${escapeHTML(ln.t)}</div>
                <div class="who" style="border-color:${sp.color}">${escapeHTML(sp.short)}</div>
              </div>
              <div class="contentCol">
                <div class="lineTop">
                  <div class="name">
                    <span class="dot" style="background:${sp.color}; box-shadow:0 0 0 4px rgba(125,211,252,0.12)"></span>
                    ${escapeHTML(sp.name)}
                  </div>
                  <div class="actions">
                    <div class="iconbtn" data-act="pin" title="Pin (P)">✦</div>
                    <div class="iconbtn" data-act="jump" title="Jump to time">↦</div>
                  </div>
                </div>
                <div class="text">${highlightText(ln.text)}</div>

                ${
                  isLens
                    ? `
                <div class="lensPanel">
                  <div class="row">
                    <strong>Focus Lens</strong>
                    <span class="hint">Enter toggles · Esc closes</span>
                  </div>
                  <div class="mini">
                    <div class="miniBtn" data-lens="summary">Summary</div>
                    <div class="miniBtn" data-lens="actions">Actions</div>
                    <div class="miniBtn" data-lens="pins">Pins</div>
                    <div class="miniBtn" data-lens="context">Context</div>
                    <div class="miniBtn" data-lens="entities">Entities</div>
                    <div class="miniBtn" data-lens="raw">Raw</div>
                  </div>
                </div>
                `
                    : ''
                }

                <div class="chips">
                  <div class="chip good">Decision</div>
                  <div class="chip warn">Trade-off</div>
                  <div class="chip">Entities</div>
                  <div class="chip bad">Risk</div>
                </div>
              </div>
            `;

            el.addEventListener('click', (e) => {
              const mark = e.target?.dataset?.mark;
              if (mark) {
                e.stopPropagation();
                q.value = mark;
                filterQ = mark;
                renderTranscript();
                toast('Filter: ' + mark);
                return;
              }

              const act = e.target?.dataset?.act;
              if (act === 'pin') {
                e.stopPropagation();
                pinLine(i);
                return;
              }
              if (act === 'jump') {
                e.stopPropagation();
                jumpTo(i);
                return;
              }

              const lens = e.target?.dataset?.lens;
              if (lens) {
                e.stopPropagation();
                setRightTab(lens);
                toast('Lens → ' + lens);
                return;
              }

              focusedIndex = i;
              lensIndex = lensIndex === i ? -1 : i;
              followLive = false;
              updateLiveChip();
              renderTranscript();
            });

            transcript.appendChild(el);
          });

          // Active speaker subtle pull
          const pull = speakers.findIndex((x) => x.id === activeSpeaker);
          const shift = (pull - 1.5) * 3;
          transcript.style.transform = `translateX(${shift}px)`;
          transcript.style.transition = 'transform 220ms ease';

          updateLiveChip();

          if (followLive) {
            const last = Math.max(0, lines.length - 1);
            requestAnimationFrame(() => scrollToLine(last, 'auto'));
          }
        }

        function renderRight() {
          rightHint.textContent =
            rightTab.charAt(0).toUpperCase() + rightTab.slice(1);
          rightBody.innerHTML = '';

          if (rightTab === 'pins') {
            const c = document.createElement('div');
            c.className = 'card';
            c.innerHTML = `<h4>Pinned moments <span class="hint">${rightModel.pins.length}</span></h4>`;

            const dz = document.createElement('div');
            dz.className = 'dropzone';
            dz.id = 'pinsDrop';
            dz.textContent = 'Drop transcript lines here to pin (or press P).';
            c.appendChild(dz);

            const row = document.createElement('div');
            row.className = 'pinRow';

            if (rightModel.pins.length === 0) {
              const empty = document.createElement('div');
              empty.className = 'hint';
              empty.textContent = 'No pins yet. Use ✦ or P on a focused line.';
              c.appendChild(empty);
            } else {
              rightModel.pins.forEach((p, idx) => {
                const pin = document.createElement('div');
                pin.className = 'pin';
                pin.textContent = p;
                pin.title = 'Click to jump';
                pin.addEventListener('click', () => {
                  const i = rightModel.pinsIndex[idx];
                  focusedIndex = i;
                  lensIndex = i;
                  followLive = false;
                  updateLiveChip();
                  renderTranscript();
                  scrollToLine(i);
                });
                row.appendChild(pin);
              });
              c.appendChild(row);
            }

            rightBody.appendChild(c);
            hookPinsDropzone();
            return;
          }

          if (rightTab === 'context') {
            const docsCard = document.createElement('div');
            docsCard.className = 'card';
            docsCard.innerHTML = `<h4>Context Library <span class="hint">${rightModel.context.docs.length}</span></h4>`;

            rightModel.context.docs.forEach((d) => {
              const it = document.createElement('div');
              it.className = 'item';
              it.innerHTML = `
                <div class="tag">${escapeHTML(d.kind)}</div>
                <div class="body">
                  <div class="headline">${escapeHTML(d.name)}</div>
                  <div class="sub">${escapeHTML(d.status)} · drag-drop to add more</div>
                </div>
              `;
              docsCard.appendChild(it);
            });

            const dz = document.createElement('div');
            dz.className = 'dropzone';
            dz.id = 'dropzone';
            dz.textContent =
              'Drop docs here (PDF/DOC/MD). Real Mac app: index locally, embed, stream RAG snippets during the meeting.';
            docsCard.appendChild(dz);

            const snipCard = document.createElement('div');
            snipCard.className = 'card';
            snipCard.innerHTML = `<h4>Realtime Snippets <span class="hint">${rightModel.context.snippets.length}</span></h4>`;

            rightModel.context.snippets.forEach((x) => {
              const it = document.createElement('div');
              it.className = 'item';
              it.innerHTML = `
                <div class="tag">${escapeHTML(x.tag)}</div>
                <div class="body">
                  <div class="headline">${escapeHTML(x.headline)}</div>
                  <div class="sub">${escapeHTML(x.sub)}</div>
                </div>
              `;
              snipCard.appendChild(it);
            });

            rightBody.appendChild(docsCard);
            rightBody.appendChild(snipCard);

            hookDropzone();
            return;
          }

          if (rightTab === 'entities') {
            const c = document.createElement('div');
            c.className = 'card';
            c.innerHTML = `<h4>Named Entities <span class="hint">NER</span></h4>`;

            const blocks = [
              { title: 'People', arr: rightModel.entities.people },
              { title: 'Organizations', arr: rightModel.entities.orgs },
              { title: 'Products', arr: rightModel.entities.products },
              { title: 'Topics', arr: rightModel.entities.topics },
              { title: 'Tasks', arr: rightModel.entities.tasks },
            ];

            blocks.forEach((b) => {
              const sub = document.createElement('div');
              sub.style.marginTop = '10px';
              sub.innerHTML = `<div class="hint" style="margin:0 0 8px 2px;">${escapeHTML(b.title)}</div>`;
              const row = document.createElement('div');
              row.className = 'pinRow';
              (b.arr || []).forEach((name) => {
                const chip = document.createElement('div');
                chip.className = 'pin';
                chip.textContent = name;
                chip.title = 'Click to filter transcript';
                chip.addEventListener('click', () => {
                  q.value = name;
                  filterQ = name;
                  renderTranscript();
                  toast('Filter: ' + name);
                });
                row.appendChild(chip);
              });
              sub.appendChild(row);
              c.appendChild(sub);
            });

            rightBody.appendChild(c);
            return;
          }

          if (rightTab === 'raw') {
            const c = document.createElement('div');
            c.className = 'card';
            c.innerHTML = `<h4>Raw Transcript <span class="hint">verbatim</span></h4>`;

            const row = document.createElement('div');
            row.className = 'pinRow';

            const pre = document.createElement('pre');
            pre.style.margin = '0';
            pre.style.whiteSpace = 'pre-wrap';
            pre.style.wordBreak = 'break-word';
            pre.style.fontSize = '12px';
            pre.style.lineHeight = '1.45';
            pre.style.color = 'rgba(255,255,255,.86)';
            pre.style.background = 'rgba(255,255,255,.03)';
            pre.style.border = '1px solid var(--stroke)';
            pre.style.borderRadius = '14px';
            pre.style.padding = '10px';

            pre.textContent = lines
              .map((ln) => {
                const sp = speakers.find((x) => x.id === ln.s);
                return `[${ln.t}] ${sp?.name || ln.s}: ${ln.text}`;
              })
              .join('\n');

            const copy = document.createElement('div');
            copy.className = 'pin';
            copy.textContent = 'Copy';
            copy.addEventListener('click', async () => {
              try {
                await navigator.clipboard.writeText(pre.textContent);
                copy.textContent = 'Copied';
                setTimeout(() => (copy.textContent = 'Copy'), 900);
              } catch {
                copy.textContent = 'Copy failed';
                setTimeout(() => (copy.textContent = 'Copy'), 900);
              }
            });

            row.appendChild(copy);
            c.appendChild(row);
            c.appendChild(pre);
            rightBody.appendChild(c);
            return;
          }

          const arr = rightModel[rightTab] || [];
          arr.forEach((x) => {
            const card = document.createElement('div');
            card.className = 'item';
            card.innerHTML = `
              <div class="tag">${escapeHTML(x.tag)}</div>
              <div class="body">
                <div class="headline">${escapeHTML(x.headline)}</div>
                <div class="sub">${escapeHTML(x.sub)}</div>
              </div>
            `;
            rightBody.appendChild(card);
          });

          const pinsCard = document.createElement('div');
          pinsCard.className = 'card';
          pinsCard.innerHTML = `<h4>Pins <span class="hint">${rightModel.pins.length}</span></h4>`;

          const row = document.createElement('div');
          row.className = 'pinRow';

          rightModel.pins.slice(0, 6).forEach((p, idx) => {
            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.textContent = p;
            pin.addEventListener('click', () => {
              const i = rightModel.pinsIndex[idx];
              focusedIndex = i;
              lensIndex = i;
              followLive = false;
              updateLiveChip();
              renderTranscript();
              scrollToLine(i);
            });
            row.appendChild(pin);
          });

          if (rightModel.pins.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'hint';
            empty.textContent = 'No pins yet. Use ✦ or P on a focused line.';
            pinsCard.appendChild(empty);
          } else {
            pinsCard.appendChild(row);
          }

          rightBody.appendChild(pinsCard);
        }

        function renderBeads() {
          beads.innerHTML = '';
          const hotIdx = 3;
          for (let i = 0; i < 7; i++) {
            const b = document.createElement('div');
            b.className = 'bead' + (i === hotIdx ? ' hot' : '');
            beads.appendChild(b);
          }
        }

        function updateScrub(x) {
          scrub.style.setProperty('--x', x + '%');
          const baseMin = 6 * 60 + 50;
          const span = 12;
          const total = baseMin + Math.round((x / 100) * span);
          const hh = Math.floor(total / 60);
          const mm = total % 60;
          timeNow.textContent = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
        }

        function hookScrub() {
          let dragging = false;

          function setFromEvent(e) {
            const rect = scrub.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = ((clientX - rect.left) / rect.width) * 100;
            scrubX = Math.max(2, Math.min(98, x));
            updateScrub(scrubX);

            const snapPoints = [12, 26, 40, 54, 68, 82, 92];
            const nearest = snapPoints.reduce(
              (a, p) => (Math.abs(p - scrubX) < Math.abs(a - scrubX) ? p : a),
              snapPoints[0],
            );
            if (Math.abs(nearest - scrubX) < 2.2) {
              scrubX = nearest;
              updateScrub(scrubX);
              timeLabel.textContent = 'Snapped to moment';
            } else {
              timeLabel.textContent = 'Scrub to jump';
            }
          }

          scrub.addEventListener('mousedown', (e) => {
            dragging = true;
            setFromEvent(e);
          });
          window.addEventListener('mousemove', (e) => {
            if (dragging) setFromEvent(e);
          });
          window.addEventListener('mouseup', () => {
            dragging = false;
          });

          scrub.addEventListener(
            'touchstart',
            (e) => {
              dragging = true;
              setFromEvent(e);
            },
            { passive: true },
          );
          scrub.addEventListener(
            'touchmove',
            (e) => {
              if (dragging) setFromEvent(e);
            },
            { passive: true },
          );
          scrub.addEventListener(
            'touchend',
            () => {
              dragging = false;
            },
            { passive: true },
          );
        }

        function hookTabs() {
          document
            .getElementById('rightTabs')
            .addEventListener('click', (e) => {
              const tab = e.target.closest('.tab');
              if (!tab) return;
              setRightTab(tab.dataset.tab);
            });
        }

        function hookModeSeg() {
          modeSeg.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            [...modeSeg.querySelectorAll('button')].forEach((b) =>
              b.classList.toggle('active', b === btn),
            );
            const mode = btn.dataset.mode;
            toast('Mode: ' + mode);
          });
        }

        function hookCmdK() {
          window.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
              e.preventDefault();
              q.focus();
            }
          });
        }

        function hookSearch() {
          q.addEventListener('input', () => {
            filterQ = q.value;
            renderTranscript();
          });
        }

        function hookNewSession() {
          document
            .getElementById('newSessionBtn')
            .addEventListener('click', () => {
              const pill = document.getElementById('statusPill');
              pill.animate(
                [
                  { transform: 'translateY(0)' },
                  { transform: 'translateY(-2px)' },
                  { transform: 'translateY(0)' },
                ],
                {
                  duration: 240,
                  easing: 'ease-out',
                },
              );
              toast('New session (demo)');
            });
        }

        function hookOpenCompact() {
          const btn = document.getElementById('openCompactBtn');
          btn.addEventListener('click', () => {
            window.open(
              'echopanel_sidepanel.html',
              'EchoPanelCompact',
              'width=460,height=860',
            );
          });
        }

        function hookDropzone() {
          const dz = document.getElementById('dropzone');
          if (!dz) return;

          function prevent(e) {
            e.preventDefault();
            e.stopPropagation();
          }

          ['dragenter', 'dragover'].forEach((ev) =>
            dz.addEventListener(ev, (e) => {
              prevent(e);
              dz.classList.add('drag');
            }),
          );

          ['dragleave', 'drop'].forEach((ev) =>
            dz.addEventListener(ev, (e) => {
              prevent(e);
              dz.classList.remove('drag');
            }),
          );

          dz.addEventListener('drop', (e) => {
            const files = [...(e.dataTransfer?.files || [])];
            if (!files.length) return;

            files.slice(0, 8).forEach((f) => {
              rightModel.context.docs.unshift({
                id: 'u_' + Math.random().toString(16).slice(2),
                name: f.name,
                kind: (f.name.split('.').pop() || 'DOC').toUpperCase(),
                status: 'Indexing…',
              });
            });

            setTimeout(() => {
              rightModel.context.docs.forEach((d) => {
                if (d.status === 'Indexing…') d.status = 'Indexed';
              });
              renderRight();
              toast('Indexed (demo)');
            }, 700);

            renderRight();
          });
        }

        function hookPinsDropzone() {
          const dz = document.getElementById('pinsDrop');
          if (!dz) return;

          function prevent(e) {
            e.preventDefault();
            e.stopPropagation();
          }

          ['dragenter', 'dragover'].forEach((ev) =>
            dz.addEventListener(ev, (e) => {
              prevent(e);
              dz.classList.add('drag');
            }),
          );

          ['dragleave', 'drop'].forEach((ev) =>
            dz.addEventListener(ev, (e) => {
              prevent(e);
              dz.classList.remove('drag');
            }),
          );

          dz.addEventListener('drop', (e) => {
            const raw = e.dataTransfer?.getData('text/plain') || '';
            try {
              const msg = JSON.parse(raw);
              if (msg?.type === 'EP_PIN_LINE' && Number.isFinite(msg.index)) {
                pinLine(msg.index);
                setRightTab('pins');
              }
            } catch {}
          });
        }

        function hookCompactMessages() {
          window.addEventListener('message', (e) => {
            const msg = e.data;
            if (!msg || !msg.type) return;

            if (msg.type === 'EP_JUMP_TO_LINE') {
              const i = Number(msg.index);
              if (!Number.isFinite(i)) return;
              focusedIndex = Math.max(0, Math.min(lines.length - 1, i));
              lensIndex = focusedIndex;
              followLive = false;
              updateLiveChip();
              renderTranscript();
              scrollToLine(focusedIndex);
              toast('From compact: jump');
              return;
            }

            if (msg.type === 'EP_FOCUS_FULL') {
              window.focus();
              toast('Focused full view');
              return;
            }
          });
        }

        function hookFollowLiveScroll() {
          transcript.addEventListener(
            'scroll',
            () => {
              if (followLive && !atBottom(transcript)) {
                followLive = false;
                updateLiveChip();
                toast('Exploring (follow off)');
              }
              if (!followLive && atBottom(transcript)) {
                // do not auto-enable follow. user must press J or click LIVE.
              }
            },
            { passive: true },
          );

          liveChip.addEventListener('click', () => jumpToLive());
        }

        function toggleRecording() {
          recording = !recording;
          if (recording) {
            statusDot.style.background = 'rgba(52, 211, 153, 0.9)';
            statusDot.style.boxShadow = '0 0 0 5px rgba(52, 211, 153, 0.12)';
            statusText.textContent = 'Listening';
            toast('Recording: on');
          } else {
            statusDot.style.background = 'rgba(251, 191, 36, 0.92)';
            statusDot.style.boxShadow = '0 0 0 5px rgba(251, 191, 36, 0.12)';
            statusText.textContent = 'Paused';
            toast('Recording: paused');
          }
        }

        function hookKeyboard() {
          window.addEventListener('keydown', (e) => {
            if (e.key === '?' && !e.metaKey && !e.ctrlKey && !e.altKey) {
              e.preventDefault();
              kbdOverlay.classList.toggle('show');
              return;
            }

            if (e.key === 'Escape') {
              if (kbdOverlay.classList.contains('show')) {
                kbdOverlay.classList.remove('show');
                return;
              }
              if (lensIndex !== -1) {
                lensIndex = -1;
                renderTranscript();
                toast('Lens closed');
                return;
              }
              if (filterQ) {
                filterQ = '';
                q.value = '';
                renderTranscript();
                toast('Filter cleared');
                return;
              }
              return;
            }

            if (e.altKey && (e.key === 'r' || e.key === 'R')) {
              e.preventDefault();
              toggleRecording();
              return;
            }

            // Don't steal keys when typing in input
            const ae = document.activeElement;
            if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA'))
              return;

            if (e.key === 'ArrowDown') {
              e.preventDefault();
              focusedIndex = Math.min(lines.length - 1, focusedIndex + 1);
              followLive = false;
              updateLiveChip();
              renderTranscript();
              scrollToLine(focusedIndex);
              return;
            }
            if (e.key === 'ArrowUp') {
              e.preventDefault();
              focusedIndex = Math.max(0, focusedIndex - 1);
              followLive = false;
              updateLiveChip();
              renderTranscript();
              scrollToLine(focusedIndex);
              return;
            }
            if (e.key === 'Enter') {
              e.preventDefault();
              lensIndex = lensIndex === focusedIndex ? -1 : focusedIndex;
              followLive = false;
              updateLiveChip();
              renderTranscript();
              toast(lensIndex === -1 ? 'Lens closed' : 'Lens opened');
              return;
            }
            if (e.key === 'p' || e.key === 'P') {
              e.preventDefault();
              pinLine(focusedIndex);
              setRightTab('pins');
              return;
            }
            if (e.key === 'j' || e.key === 'J') {
              e.preventDefault();
              jumpToLive();
              return;
            }
            if (e.key === ' ') {
              e.preventDefault();
              followLive = !followLive;
              updateLiveChip();
              toast(followLive ? 'Follow Live: on' : 'Follow Live: off');
              if (followLive) jumpToLive();
              return;
            }
          });

          kbdOverlay.addEventListener('click', (e) => {
            if (e.target === kbdOverlay) kbdOverlay.classList.remove('show');
          });
        }

        function simulateLiveInserts() {
          // Demo: every ~6s add a new line, only auto-scroll if followLive is true.
          setInterval(() => {
            const sp = speakers[Math.floor(Math.random() * speakers.length)];
            const lastT = lines[lines.length - 1]?.t || '07:44';
            const mm = Number(lastT.split(':')[1] || 44);
            const next = (mm + 6) % 60;
            const t = '07:' + String(next).padStart(2, '0');

            const demoText = [
              'We should treat the compact roll as the product, not a preview.',
              'The Lens should route to Actions and Pins without changing context.',
              'RAG needs a strict model: local index, streaming snippets, zero UI jank.',
              'If follow-live jitters, users will stop trusting the tool.',
            ][Math.floor(Math.random() * 4)];

            lines = lines.concat([{ t, s: sp.id, text: demoText }]);
            if (followLive) {
              focusedIndex = lines.length - 1;
            }
            renderTranscript();
          }, 6000);
        }

        function hookTabsRoutingFromLensChips() {
          // Lens chips are in transcript rows, handled by click delegate already via data-lens.
        }

        function hookLiveChip() {
          // already wired in hookFollowLiveScroll
        }

        function hookRightTabsKeyboardOptional() {
          // Keep minimal. Power user can click, lens mini buttons, or future: ←/→ could cycle tabs.
        }

        // Init
        renderSessions();
        renderSpeakers();
        renderTranscript();
        renderRight();
        renderBeads();
        updateScrub(scrubX);

        hookTabs();
        hookScrub();
        hookModeSeg();
        hookCmdK();
        hookSearch();
        hookNewSession();
        hookOpenCompact();
        hookCompactMessages();
        hookFollowLiveScroll();
        hookKeyboard();
        simulateLiveInserts();
      })();
    </script>
  </body>
</html>
