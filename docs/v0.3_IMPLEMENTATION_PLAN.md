# Implementation Plan: EchoPanel v0.3 (Evidence-First Memory)

This plan moves EchoPanel from keyword-based lookup to a local-first, evidence-anchored RAG and Hybrid NER system.

## User Review Required

> [!IMPORTANT]
> **Licensing**: Standardizes on **Apache-2.0** models (Ministral, BGE) for core redistribution, with the **Gemma ecosystem** (EmbeddingGemma, Gemma 3) as high-performance local alternatives.
> [!NOTE]
> **Eval-First**: PR-2 now includes an offline eval harness to measure Recall@K and MRR before finalizing the model stack.

## Proposed Changes

### [PR-1] Memory Schema & Invariants
**Goal**: Establish the "Evidence Pointer" as the core data contract.
- **[NEW] schema.py**: Define Pydantic models for `Segment`, `Chunk`, `Entity`, `Event`, and `Frame`.
- **Validation**: Implement strict timestamp inheritance (child spans must be contained within parent segments).

### [PR-2] Ingestion & Offline Eval Harness
**Goal**: Build the measurement foundation before final model bake-offs.
- **Offline Eval Harness**: Create a script to measure Recall@K and MRR against a "gold set" of meeting queries.
- **[MODIFY] rag_store.py**: Integrate **LanceDB** with hybrid search (dense + sparse) and **EmbeddingGemma/BGE-M3** adapters.

### [PR-3] Retrieval API
**Goal**: Optimize retrieval density.
- **Hybrid Search**: Implement RRF (Reciprocal Rank Fusion) combining keyword and vector scores.
- **Measurement**: Use the PR-2 harness to tune chunk sizes and overlap.

### [PR-4] Synthesis API (Grounded or Silent)
**Goal**: Evidence-backed summarization with zero hallucinations.
- **Ollama/MLX Adapter**: Unified interface for **Ministral-3B** (Apache) and **Gemma 3** (Multimodal).
- **Grounded synthesis**: Prompt enforcement to cite evidence pointers (meeting_id, t0/t1).

### [PR-5] Hybrid NER Layer
**Goal**: Structured entity anchors for precision retrieval.
- **Analysis Stream**: Integrate **GLiNER** (via modular interface) for semantic labels (Decision, Action Item).
- **Routing**: Query detects entities → hits entity index → narrows candidate chunks for vector search.

### [PR-6] Visual Memory Path
**Goal**: Incorporating screen evidence into RAG for "Visual Memory."
- **Capture**: Native macOS capture via **ScreenCaptureKit** with 1fps sampling.
- **Change Detection**: Efficient **pHash** or **SSIM** loop to gate analysis.
- **Extraction**: Three-tier approach: **Apple Vision** (Always-on) + **LightOnOCR-2-1B** (Doc Structure) + **SmolVLM2** (Semantic Summary).
- **Retrieval**: Unified retrieval engine using **Temporal Fusion** (Text + Vision).

## Verification Plan

### Automated Tests
- `pytest tests/test_schema_invariants.py`: Verify timestamp containment.
- `pytest tests/test_retrieval_metrics.py`: Recall@10 must be >0.85 on test corpus.
- `pytest tests/test_citation_integrity.py`: Verify citations map to actual segment IDs.

### Manual Verification
- Run a live meeting, share a slide.
- Ask: "What was the decision on that pricing slide?"
- Result: Retrieval must find both the transcript chunk and the frame OCR, with synthesis citing both pointers.
