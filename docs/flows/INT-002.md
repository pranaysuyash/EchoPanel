# INT-002 Real-Time Card Extraction Flow

## Flow Overview

This internal flow continuously analyzes live transcript segments to extract action items, decisions, and risks (collectively called "cards") in real-time. It uses a sliding 10-minute window to maintain context and performs deduplication to avoid spam while ensuring important insights are captured.

## Happy Path Sequence

1. Transcript segment received from ASR processing
   - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: streamer.onASRFinal = { [weak self] text, t0, t1, confidence, source in ... handleFinal(text: text, t0: t0, t1: t1, confidence: confidence, source: source) }

2. Segment added to transcriptSegments array with final status
   - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: transcriptSegments.append(segment) ... bumpTranscriptRevision()

3. Transcript revision triggers analysis update via WebSocket
   - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: sessionStore.appendTranscriptSegment(payload)

4. Server-side analysis triggered on transcript update
   - Evidence: server/services/analysis_stream.py :: extract_cards(transcript: List[dict], window_seconds: float = ANALYSIS_WINDOW_SECONDS)

5. 10-minute sliding window applied to filter recent segments
   - Evidence: server/services/analysis_stream.py :: windowed = \_filter_window(transcript, window_seconds) ... max_t1 = max(seg.get("t1", 0.0) for seg in transcript)

6. Keyword-based card extraction for actions, decisions, risks
   - Evidence: server/services/analysis_stream.py :: if any(kw in lower for kw in action_keywords): ... actions.append(Card(...))

7. Fuzzy deduplication applied to prevent duplicate cards
   - Evidence: server/services/analysis_stream.py :: actions = \_deduplicate_cards(actions)[:7] ... \_fuzzy_match(text1, text2, threshold: 0.7)

8. Cards ranked by recency (most recent first)
   - Evidence: server/services/analysis_stream.py :: result.sort(key=lambda c: c.t1, reverse=True)

9. Analysis results sent to client via WebSocket cards_update message
   - Evidence: server/services/asr_stream.py :: await websocket.send_json({"type": "cards_update", "actions": actions, "decisions": decisions, "risks": risks})

10. Client updates UI with new cards using animation
    - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: streamer.onCardsUpdate = { [weak self] actions, decisions, risks in ... withAnimation(.easeInOut(duration: 0.2)) { self?.actions = actions ... } }

## Failure Modes

1. **Empty transcript window**: No segments in 10-minute window
   - Detection: \_filter_window returns empty list
   - Handling: Returns empty card lists
   - User impact: No cards shown, expected for new sessions

2. **Memory exhaustion**: Large transcript causes analysis slowdown
   - Detection: Analysis takes >100ms per segment
   - Handling: Window size limits processing scope
   - User impact: Slight delay in card updates

3. **WebSocket disconnect**: Cards update fails to reach client
   - Detection: WebSocket send fails
   - Handling: Cards cached server-side, resent on reconnect
   - User impact: Temporary card freeze, recovers on reconnection

4. **Keyword false positives**: Non-action text matches keywords
   - Detection: Manual review shows irrelevant cards
   - Handling: Keyword refinement and confidence scoring
   - User impact: Occasional irrelevant cards, can be ignored

5. **Deduplication over-aggressive**: Legitimate cards removed as duplicates
   - Detection: Important cards missing from UI
   - Handling: Fuzzy threshold tuning (currently 0.7)
   - User impact: Rare missing cards, manual addition possible

6. **Unicode processing errors**: Special characters in transcript
   - Detection: String processing exceptions
   - Handling: Graceful fallback to ASCII-only processing
   - User impact: Cards may miss accented keywords

7. **Analysis backlog**: Real-time analysis falls behind live transcription
   - Detection: Cards appear with delay >5 seconds
   - Handling: Analysis runs in background thread
   - User impact: Cards appear slightly delayed but complete

## Observability

- **Analysis latency**: Time to extract cards from transcript update
- **Card counts**: Number of actions/decisions/risks generated
- **Deduplication rate**: Percentage of cards removed as duplicates
- **WebSocket metrics**: Cards update message delivery success
- **Window size**: Number of segments in 10-minute analysis window

## Evidence Citations

- Code: server/services/analysis_stream.py (lines 80-140) - Card extraction logic and windowing
- Code: server/services/analysis_stream.py (lines 40-70) - Fuzzy deduplication implementation
- Code: macapp/MeetingListenerApp/Sources/AppState.swift (lines 380-420) - WebSocket cards update handling
- Code: server/services/asr_stream.py (lines 200-250) - Cards update message sending
