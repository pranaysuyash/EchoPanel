# AUD-008 Device Hot-Swap Recovery

## Summary

- Origin: Code-only
- Status: Implemented
- 1â€“2 sentence description: Detects USB audio device disconnection during active sessions and attempts automatic recovery by restarting audio capture with minimal interruption.
- Boundaries crossed: OS (AVCaptureDevice notifications), UI (status updates), Process (recovery callbacks)
- Primary components (coarse list): DeviceHotSwapManager, BroadcastFeatureManager, AppState

## Triggers and Preconditions

- Triggers: AVCaptureDeviceWasConnected/Disconnected notifications, periodic device verification (2s timer), manual recovery trigger
- Preconditions: Broadcast mode enabled (useDeviceHotSwap=true), hot-swap monitoring started, audio capture active

## Sequence (Happy Path)

1. **Monitoring initialization**
   - DeviceHotSwapManager.startMonitoring() called during app setup
   - Registers NSNotification observers for device connect/disconnect
   - Starts 2s periodic timer for device verification
   - Evidence:
     - Code: DeviceHotSwapManager.swift:68-83
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:440-450

2. **Device registration**
   - registerCurrentDevice() stores current default audio device ID
   - Sets initial status to .connected
   - Evidence:
     - Code: DeviceHotSwapManager.swift:84-91
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:451

3. **Disconnect detection**
   - NSNotification.Name.AVCaptureDeviceWasDisconnected received
   - Checks if disconnected device matches lastDeviceID
   - Sets deviceStatus = .disconnected
   - Calls onDeviceDisconnected?() callback
   - Evidence:
     - Code: DeviceHotSwapManager.swift:159-172
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:452-453

4. **Periodic verification**
   - Timer fires every 2s, calls verifyDeviceConnection()
   - Checks AVCaptureDevice.default(for: .audio) availability
   - If device missing when status=.connected, triggers disconnect
   - Evidence:
     - Code: DeviceHotSwapManager.swift:175-203
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:454

5. **Recovery initiation**
   - On disconnect detection, calls attemptRecovery()
   - Sets isRecovering=true, deviceStatus=.recovering
   - Waits recoveryDelay=1.0s before attempting restart
   - Evidence:
     - Code: DeviceHotSwapManager.swift:205-255
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:455-456

6. **Recovery attempt loop**
   - Tries up to maxRecoveryAttempts=3 times
   - Calls onShouldRestartCapture?() callback (external)
   - If callback succeeds, breaks loop
   - If fails, waits 0.5s, retries
   - Evidence:
     - Code: DeviceHotSwapManager.swift:220-235
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:457

7. **Recovery success**
   - Sets deviceStatus=.connected
   - Calls registerCurrentDevice() to update lastDeviceID
   - Calls onDeviceReconnected?() callback
   - Logs success with attempt count
   - Evidence:
     - Code: DeviceHotSwapManager.swift:236-243
     - Docs: docs/audit/audio-pipeline-deep-dive-20260211.md:458

## Inputs and Outputs

- Inputs:
  - NSNotification device connect/disconnect events
  - Timer events (2s intervals)
  - User manual recovery trigger
- Outputs:
  - @Published deviceStatus changes (.connected/.disconnected/.recovering/.failed)
  - @Published isRecovering boolean
  - @Published lastError string
  - Callback invocations (onDeviceDisconnected, onDeviceReconnected)
  - StructuredLogger events
- Side effects: Audio capture restart, device ID updates, UI status updates

## Failure Modes

- Failure: Recovery timeout - onShouldRestartCapture callback hangs indefinitely
  - Where detected: attemptRecovery() async loop
  - Current handling: Recovery callback is wrapped in explicit timeout (`restartCaptureWithTimeout`), and timeout is treated as failed attempt
  - User-visible outcome: Recovery exits `.recovering` and transitions to `.failed` after max attempts
  - Evidence: DeviceHotSwapManager.swift :: restartCaptureWithTimeout(), attemptRecovery()

- Failure: Max recovery attempts exceeded
  - Where detected: attemptRecovery() after 3 failed attempts
  - Current handling: Sets deviceStatus=.failed, logs error
  - User-visible outcome: UI shows failed status, manual retry button appears
  - Evidence: DeviceHotSwapManager.swift:244-250

- Failure: Callback not registered - onShouldRestartCapture is nil
  - Where detected: attemptRecovery() when calling callback
  - Current handling: Throws error, logged as recovery failure
  - User-visible outcome: Recovery fails immediately
  - Evidence: DeviceHotSwapManager.swift:226, docs/audit/audio-pipeline-deep-dive-20260211.md:505

- Failure: Concurrent recovery attempts
  - Where detected: attemptRecovery() guard check
  - Current handling: Ignores additional triggers while recovering
  - User-visible outcome: No visible indication, logged
  - Evidence: DeviceHotSwapManager.swift:206

- Failure: Device reconnected but different device
  - Where detected: verifyDeviceConnection() finds new default device
  - Current handling: Attempts recovery assuming it's the same device
  - User-visible outcome: May succeed or fail depending on device compatibility
  - Evidence: DeviceHotSwapManager.swift:190-196

- Failure: Notification observer leak
  - Where detected: App termination without calling stopMonitoring()
  - Current handling: Both connect/disconnect observers are explicitly tracked and removed by `stopMonitoring()`
  - User-visible outcome: No residual observer registration after explicit stop
  - Evidence: DeviceHotSwapManager.swift :: deviceConnectedObserver/deviceDisconnectedObserver, removeDeviceObservers()

## Data and Storage

- What data is produced/consumed: Device IDs, connection status, error messages
- Where it is stored: In-memory @Published properties, UserDefaults for settings
- Retention / deletion controls: No explicit cleanup, data persists until app restart

## Observability

- Logs/events emitted: StructuredLogger events for connect/disconnect/recovery attempts/success/failure
- Correlation IDs / session IDs: None specific to hot-swap
- Metrics/traces: Recovery attempt counts, success/failure rates
- Evidence: DeviceHotSwapManager.swift:59,71,82,90,96,154,168,189,196,223,229,236,244

## Open Questions and Follow-up Tasks

- Questions: Is hot-swap actually integrated into session flow? Callbacks appear unset.
- Documentation gaps: Integration with AppState/BroadcastFeatureManager not documented
- Test gaps: End-to-end hot-swap during active session
