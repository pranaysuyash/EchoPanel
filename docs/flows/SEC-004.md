# SEC-004 HuggingFace Token Keychain Storage

## Summary

- Origin: Code-only
- Status: Implemented
- Secure storage of HuggingFace API authentication token in macOS Keychain Services, with automatic migration from insecure UserDefaults.
- Boundaries crossed: OS (macOS Keychain)
- Primary components (coarse list): KeychainHelper, OnboardingView, BackendManager

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): User enters HF token in onboarding, app launch (migration), backend startup
- Preconditions (permissions, settings flags, availability, model cached, etc.): macOS Keychain available

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User enters HF token in onboarding UI
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: KeychainHelper.saveHFToken(newToken)
   - Notes: UI-triggered save

1. App launch triggers migration check
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: migrateFromUserDefaults()
   - Notes: Checks for legacy UserDefaults token

1. If legacy token found, migrate to Keychain
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: saveHFToken(legacyToken)
   - Notes: Secure storage

1. HF token saved securely
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: saveHFToken() uses SecItemAdd
   - Notes: Encrypted with kSecAttrAccessibleAfterFirstUnlock

1. Token loaded for model downloads/auth
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: KeychainHelper.loadHFToken()
   - Notes: Retrieved for HF API access

## Inputs and Outputs

- Inputs:
  - HuggingFace API token string
  - Migration trigger on app launch
- Outputs:
  - Secure token storage confirmation
  - Retrieved token for API auth
- Side effects (writes, network calls, model loads, UI state changes): Keychain write, UserDefaults cleanup

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Keychain save fails
  - Where detected: SecItemAdd returns error
  - Current handling (as evidenced): Returns false, logged
  - User-visible outcome (if any): Token not saved, model downloads fail
  - Evidence: Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: status != errSecSuccess

- Failure: Migration fails
  - Where detected: saveHFToken returns false
  - Current handling (as evidenced): Migration incomplete, UserDefaults retained
  - User-visible outcome (if any): Insecure storage remains
  - Evidence: Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: migrateFromUserDefaults()

- Failure: Token load fails
  - Where detected: SecItemCopyMatching returns error
  - Current handling (as evidenced): Returns nil, API auth fails
  - User-visible outcome (if any): Model access denied
  - Evidence: Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: loadHFToken()

- Failure: Keychain locked
  - Where detected: Device locked
  - Current handling (as evidenced): Load returns nil
  - User-visible outcome (if any): Auth fails until unlock
  - Evidence: Code: macOS Keychain behavior

- Failure: Token corrupted
  - Where detected: Load returns invalid data
  - Current handling (as evidenced): Treated as missing
  - User-visible outcome (if any): Auth fails
  - Evidence: Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: String(data: data, encoding: .utf8)

## Data and Storage

- What data is produced/consumed: HuggingFace API token string
- Where it is stored (DB/files/userData/etc.): macOS Keychain with service "com.echopanel.app"
- Retention / deletion controls (if documented): Persistent until deleted, accessible after first unlock

## Observability

- Logs/events emitted: Migration success/failure logged
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
- Evidence: Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: NSLog in migrateFromUserDefaults

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: None
- Documentation gaps to fill: None
- Test gaps to add (note only, no implementation): Test HF token storage and retrieval
