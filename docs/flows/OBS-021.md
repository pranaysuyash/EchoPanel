# OBS-021 Log File Rotation Flow

## Summary

- Origin: Code-only
- Status: Implemented
- Automatic log file rotation when size exceeds 10MB limit, maintaining up to 5 historical log files for structured logging system.
- Boundaries crossed: Storage
- Primary components (coarse list): StructuredLogger

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Logger initialization (application startup)
- Preconditions (permissions, settings flags, availability, model cached, etc.): enableFileOutput = true in logger configuration

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Logger initializes and calls setupLogFile()
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: init() calls setupLogFile() if enableFileOutput
   - Notes: Happens on application startup

1. setupLogFile() checks current log file size against maxFileSizeBytes (10MB)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: rotateLogsIfNeeded() checks fileSize >= configuration.maxFileSizeBytes
     - Docs: docs/WORKLOG_TICKETS.md :: Log rotation (5 files, 10MB each)

1. If size exceeds limit, rotateLogs() executes file rotation
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: rotateLogs() moves echopanel.log.N to .N+1, deletes oldest

1. Creates new empty log file for continued logging
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: FileManager.createFile(atPath: logFileURL.path, contents: nil)

## Inputs and Outputs

- Inputs: Current log file (echopanel.log) size and contents
- Outputs: Rotated historical files (echopanel.log.1 through .5), new empty echopanel.log
- Side effects (writes, network calls, model loads, UI state changes): File system writes to Application Support directory, file moves and deletions

## Failure Modes

List 5â€“10 realistic failures:

- Failure: File size check fails (file access error)
  - Where detected: rotateLogsIfNeeded()
  - Current handling (as evidenced): try? attributesOfItem, catch ignores error
  - User-visible outcome (if any): No rotation occurs, logging continues to growing file
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? FileManager.default.attributesOfItem

- Failure: File move operations fail during rotation
  - Where detected: rotateLogs()
  - Current handling (as evidenced): try? fileManager.moveItem, continues with other operations
  - User-visible outcome (if any): Partial rotation, some historical files may be lost
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? fileManager.moveItem

- Failure: File creation fails for new log file
  - Where detected: setupLogFile()
  - Current handling (as evidenced): FileManager.createFile, error logged to NSLog
  - User-visible outcome (if any): Logging disabled for session
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: NSLog("StructuredLogger: Failed to setup log file")

- Failure: Application Support directory not accessible
  - Where detected: setupLogFile()
  - Current handling (as evidenced): guard let appSupport, logs to NSLog
  - User-visible outcome (if any): File logging disabled
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: "Failed to get Application Support directory"

- Failure: File handle creation fails
  - Where detected: setupLogFile()
  - Current handling (as evidenced): try? FileHandle, error logged
  - User-visible outcome (if any): File logging disabled
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? FileHandle(forWritingTo: logFileURL)

## Data and Storage

- What data is produced/consumed: JSON-formatted log entries with timestamps, levels, messages, correlation IDs
- Where it is stored (DB/files/userData/etc.): ~/Library/Application Support/com.echopanel/logs/echopanel.log and rotated files
- Retention / deletion controls (if documented): Automatic deletion of files beyond maxFileCount (5), no explicit retention policy documented

## Observability

- Logs/events emitted: Errors logged to NSLog on setup failures
- Correlation IDs / session IDs (if any): Included in log entries via correlation context
- Metrics/traces (if any): None evidenced
  Evidence required: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: NSLog calls

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Why is rotation only checked on startup and not during ongoing logging?
- Documentation gaps to fill: Runtime rotation triggers, if any
- Test gaps to add (note only, no implementation): Rotation during active logging, file permission scenarios</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/OBS-021.md
