# STO-006 Keychain Secrets Storage

## Summary

- Origin: Code-only
- Status: Implemented
- Secure storage of sensitive authentication tokens (HuggingFace API token, backend WebSocket token) in macOS Keychain Services, replacing insecure UserDefaults storage.
- Boundaries crossed: UI / OS
- Primary components (coarse list): KeychainHelper, OnboardingView, BackendManager, AppState, MeetingListenerApp

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): App launch (migration), user enters token in onboarding/settings, backend startup requiring tokens
- Preconditions (permissions, settings flags, availability, model cached, etc.): macOS Keychain available (always true on macOS), no specific permissions required beyond app access

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Migration from UserDefaults on app launch
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: migrateFromUserDefaults()
     - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: KeychainHelper.migrateFromUserDefaults()
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: KeychainHelper.migrateFromUserDefaults()
   - Notes: Automatic migration on first launch after update

1. User enters HuggingFace token in onboarding UI
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: KeychainHelper.saveHFToken(newToken)
   - Notes: UI-triggered save

1. KeychainHelper saves token using SecItemAdd
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: saveHFToken()
   - Notes: Uses kSecAttrAccessibleAfterFirstUnlock for security

1. BackendManager loads HF token for model access
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: KeychainHelper.loadHFToken()
   - Notes: Loaded on backend startup if needed

1. AppState loads backend token for WebSocket auth
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: KeychainHelper.loadBackendToken()
   - Notes: Loaded when establishing WS connection

## Inputs and Outputs

- Inputs: Token strings (HF token, backend token)
- Outputs: Success boolean (true/false for save/delete operations), loaded token string or nil
- Side effects (writes, network calls, model loads, UI state changes): Keychain write operations, UserDefaults cleanup during migration

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Keychain storage full
  - Where detected: KeychainHelper.save\*()
  - Current handling (as evidenced): Returns false
  - User-visible outcome (if any): Token save fails silently, user may retry
  - Evidence: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: SecItemAdd status check

- Failure: Keychain permission denied
  - Where detected: KeychainHelper.save\*()
  - Current handling (as evidenced): Returns false
  - User-visible outcome (if any): Token not saved, no UI feedback
  - Evidence: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: SecItemAdd status != errSecSuccess

- Failure: Migration from UserDefaults fails
  - Where detected: KeychainHelper.migrateFromUserDefaults()
  - Current handling (as evidenced): Returns false, keeps legacy in UserDefaults
  - User-visible outcome (if any): None, tokens still work from UserDefaults
  - Evidence: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: migrateFromUserDefaults() success flag

- Failure: Token data encoding fails
  - Where detected: KeychainHelper.save\*()
  - Current handling (as evidenced): Returns false
  - User-visible outcome (if any): Save fails
  - Evidence: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: token.data(using: .utf8)

- Failure: Keychain item not found on load
  - Where detected: KeychainHelper.load\*()
  - Current handling (as evidenced): Returns nil
  - User-visible outcome (if any): Auth fails, user prompted to re-enter token
  - Evidence: macapp/MeetingListenerApp/Sources/KeychainHelper.swift :: SecItemCopyMatching status check

## Data and Storage

- What data is produced/consumed: HuggingFace API tokens, backend WebSocket authentication tokens
- Where it is stored (DB/files/userData/etc.): macOS Keychain Services (secure OS-level storage)
- Retention / deletion controls (if documented): Tokens persist until explicitly deleted or app removed; delete functions available but not exposed in UI

## Observability

- Logs/events emitted: None evidenced in code
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
  Evidence: No logger calls in KeychainHelper or callers for keychain operations

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Are keychain operations logged anywhere? Is there UI feedback for save failures?
- Documentation gaps to fill: Keychain security model, accessibility attributes
- Test gaps to add (note only, no implementation): Unit tests for KeychainHelper, integration tests for migration</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/STO-006.md
