# EXT-001 First Launch Onboarding

## Summary

- Origin: Code-only
- Status: Implemented
- First-run onboarding wizard that guides users through permissions, audio source selection, and optional diarization setup before enabling the main listening functionality.
- Boundaries crossed: UI / OS (permissions) / Process (backend)
- Primary components: OnboardingView, AppState, BackendManager

## Triggers and Preconditions

- Triggers: Application first launch (UserDefaults key "onboardingCompleted" is false)
- Preconditions: None (backend starts automatically on app launch)

## Sequence (Happy Path)

1. App launches and initializes AppState, BackendManager starts server
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: init() { BackendManager.shared.startServer() }
     - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: @State private var showOnboarding = !UserDefaults.standard.bool(forKey: "onboardingCompleted")

2. Onboarding window opens automatically
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: .onChange(of: showOnboarding) { if newValue { openWindow(id: "onboarding") } }

3. Welcome step displays introduction and app description
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: private var welcomeStep

4. User clicks "Next" to permissions step
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: Button("Next") { withAnimation { nextStep() } }

5. Permissions step checks screen recording and microphone permissions, allows opening System Settings
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: private var permissionsStep
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: appState.refreshPermissionStatuses()

6. User clicks "Next" to source selection step
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: private var sourceSelectionStep

7. User selects audio source (system/microphone/both)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: SourceOptionRow action: { appState.audioSource = source }

8. User clicks "Next" to diarization step
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: private var diarizationStep

9. User optionally enters HuggingFace token for speaker diarization
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: SecureField("hf\_...", text: $hfToken)
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: .onChange(of: hfToken) { \_ = KeychainHelper.saveHFToken(newToken) }

10. User clicks "Next" to ready step
    - Evidence:
      - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: private var readyStep

11. Ready step shows server status and configuration summary
    - Evidence:
      - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: backendStatusText, appState.serverStatus

12. User clicks "Start Listening" to complete onboarding and begin first session
    - Evidence:
      - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: Button("Start Listening") { completeOnboarding() }
      - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: private func completeOnboarding() { UserDefaults.standard.set(true, forKey: "onboardingCompleted"); onStartListening() }

## Inputs and Outputs

- Inputs:
  - User selections: audio source preference
  - Optional: HuggingFace API token for diarization
- Outputs:
  - UserDefaults: onboardingCompleted = true
  - Keychain: HF token (if provided)
  - AppState: audioSource set
- Side effects:
  - Backend server started
  - Permission statuses refreshed
  - Onboarding window closed
  - First listening session initiated

## Failure Modes

- Permission denied (screen recording or microphone):
  - Where detected: permissionsStep view checks appState.permission statuses
  - Current handling: Shows denied status, provides "Open Settings" button, allows retry with "Check Again"
  - User-visible outcome: Cannot proceed to next step until permissions granted
  - Evidence: Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: PermissionRow status checks

- Backend server fails to start:
  - Where detected: readyStep checks appState.serverStatus
  - Current handling: Shows error message, provides "Retry" button and "Collect Diagnostics" button
  - User-visible outcome: Cannot start listening, diagnostic bundle can be exported
  - Evidence: Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: if appState.serverStatus == .error

- User closes onboarding window prematurely:
  - Where detected: .onDisappear modifier
  - Current handling: Sets isPresented = false, but does not mark onboarding as completed
  - User-visible outcome: Onboarding can be reopened from the menu bar via "Show Onboarding"
  - Evidence:
    - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: .onDisappear { isPresented = false }
    - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: menu action "Show Onboarding"

- Insufficient OS version for screen recording:
  - Where detected: Assumed in permission checks
  - Current handling: Not explicitly handled
  - User-visible outcome: Permission appears as not granted
  - Evidence: Hypothesized - no explicit check found

## Data and Storage

- UserDefaults: Stores onboardingCompleted flag
- Keychain: Stores HuggingFace token (via KeychainHelper)
- No session data produced during onboarding

## Observability

- No explicit logs or metrics for onboarding flow
- Backend server status visible in UI
- Permission statuses refreshed and displayed

## Open Questions and Follow-up Tasks

- Should onboarding persist partial progress across app restarts?
- Validation of HF token format before saving?
- Test gaps: Automated testing of permission flows, backend failure scenarios</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-001.md
