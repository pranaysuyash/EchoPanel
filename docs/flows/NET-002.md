# NET-002 WebSocket Authentication Flow

## Summary

- Origin: Code-only
- Status: Hypothesized
- Client includes authentication token in WebSocket URL query parameter for backend access control.
- Boundaries crossed: Network
- Primary components (coarse list): BackendConfig, KeychainHelper, WebSocketStreamer

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): WebSocket connection establishment
- Preconditions (permissions, settings flags, availability, model cached, etc.): Backend token stored in keychain, ECHOPANEL_WS_AUTH_TOKEN not set

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. BackendConfig.webSocketURL calls buildURL with includeToken: true
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: static var webSocketURL: URL { buildURL(path: "/ws/live-listener", includeToken: true) }
   - Notes: Always includes token for WS

1. buildURL loads token from KeychainHelper
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: if includeToken, let token = KeychainHelper.loadBackendToken()
   - Notes: KeychainHelper.loadBackendToken()

1. Token added as query parameter ?token=...
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: components.queryItems = [URLQueryItem(name: "token", value: token)]
   - Notes: Only if token exists and not empty

1. WebSocket connects with authenticated URL
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: task = session.webSocketTask(with: url)
   - Notes: URL includes token in query

1. Backend validates token from query parameter
   - Evidence:
     - Docs: docs/WS_CONTRACT.md :: Accepted token inputs (priority order): 1) ?token=... query parameter
   - Notes: Server-side validation

1. If valid, connection proceeds; if invalid, server closes with 1008
   - Evidence:
     - Docs: docs/WS_CONTRACT.md :: Unauthorized websocket behavior: sends error status, closes with 1008
   - Notes: Client detects closure and may retry

## Inputs and Outputs

- Inputs: Backend token from keychain
- Outputs: Authenticated WebSocket URL
- Side effects (writes, network calls, model loads, UI state changes): Token included in network request

## Failure Modes

List 5â€“10 realistic failures:

- Failure: No token in keychain
  - Where detected: KeychainHelper.loadBackendToken()
  - Current handling (as evidenced): Returns nil, no query param added
  - User-visible outcome (if any): Connection succeeds if server allows unauthenticated
  - Evidence: Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: let token = KeychainHelper.loadBackendToken()

- Failure: Token invalid/expired
  - Where detected: Backend server validation
  - Current handling (as evidenced): Server closes connection with 1008
  - User-visible outcome (if any): Connection fails, client retries
  - Evidence: Docs: docs/WS_CONTRACT.md :: Unauthorized websocket behavior

- Failure: Token empty string
  - Where detected: BackendConfig.buildURL
  - Current handling (as evidenced): !token.isEmpty check, no query param
  - User-visible outcome (if any): No authentication sent
  - Evidence: Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: !token.isEmpty

## Data and Storage

- What data is produced/consumed: Backend token string
- Where it is stored (DB/files/userData/etc.): macOS Keychain via KeychainHelper
- Retention / deletion controls (if documented): None evidenced

## Observability

- Logs/events emitted: None evidenced for auth specifically
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None evidenced

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: How is token initially set in keychain?
- Documentation gaps to fill: Token provisioning flow
- Test gaps to add (note only, no implementation): Test connection with invalid token</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/NET-002.md
