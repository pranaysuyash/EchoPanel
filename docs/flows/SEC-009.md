# SEC-009 Debug Audio Dump (Privacy Risk)

## Summary

- Origin: Code-only
- Status: Implemented
- Environment-gated debug feature that writes raw PCM audio data to disk for troubleshooting, with automatic cleanup limits to mitigate privacy risks from persistent sensitive audio storage.
- Boundaries crossed: Process / Storage
- Primary components (coarse list): FastAPI WebSocket handler, filesystem

## Triggers and Preconditions

- Triggers: WebSocket audio message received when debug dump enabled
- Preconditions: ECHOPANEL_DEBUG_AUDIO_DUMP=1 environment variable set, audio session started

## Sequence (Happy Path)

1. Server receives audio message with new source
   - Evidence:
     - Code: server/api/ws_live_listener.py :: msg_type == "audio" (line 775)
2. Server checks if debug dump enabled and source not already initialized
   - Evidence:
     - Code: server/api/ws_live_listener.py :: if source not in state.started_sources (line 780)
3. Server calls \_init_audio_dump to create per-source PCM file
   - Evidence:
     - Code: server/api/ws_live_listener.py :: \_init_audio_dump(state, source) (line 783)
4. \_init_audio_dump creates timestamped filename and opens file handle
   - Evidence:
     - Code: server/api/ws*live_listener.py :: filename = f"{session_id}*{source}\_{timestamp}.pcm" (line 212)
5. Server writes each audio chunk to corresponding dump file
   - Evidence:
     - Code: server/api/ws_live_listener.py :: \_write_audio_dump(state, source, chunk) (line 788)
6. \_write_audio_dump flushes raw PCM bytes to disk
   - Evidence:
     - Code: server/api/ws_live_listener.py :: file_handle.write(chunk) and flush() (lines 227-228)
7. Periodic cleanup removes old/excess files based on configurable limits
   - Evidence:
     - Code: server/api/ws_live_listener.py :: \_cleanup_audio_dump_dir() (line 209)

## Inputs and Outputs

- Inputs: Raw PCM audio chunks from WebSocket
- Outputs: PCM files written to disk
- Side effects (writes, network calls, model loads, UI state changes): Disk I/O for audio writing, file system storage consumption

## Failure Modes

- Failure: Debug dump directory creation fails
  - Where detected: server/api/ws_live_listener.py :: \_init_audio_dump
  - Current handling (as evidenced): Exception caught, logged, dump disabled for source
  - User-visible outcome (if any): No debug dump for that source, normal operation continues
  - Evidence: server/api/ws_live_listener.py :: try/except in \_init_audio_dump
- Failure: File write fails (disk full, permissions)
  - Where detected: server/api/ws_live_listener.py :: \_write_audio_dump
  - Current handling (as evidenced): Exception caught, logged, dump continues attempting
  - User-visible outcome (if any): Gaps in debug dump, normal operation continues
  - Evidence: server/api/ws_live_listener.py :: try/except in \_write_audio_dump
- Failure: Cleanup fails (file locked, permissions)
  - Where detected: server/api/ws_live_listener.py :: \_cleanup_audio_dump_dir
  - Current handling (as evidenced): Individual file errors logged, process continues
  - User-visible outcome (if any): Debug files may accumulate beyond limits
  - Evidence: server/api/ws_live_listener.py :: try/except blocks in cleanup

## Data and Storage

- What data is produced/consumed: Raw PCM16 audio data (unprocessed, unredacted)
- Where it is stored (DB/files/userData/etc.): Filesystem at configurable path (default /tmp/echopanel_audio_dump)
- Retention / deletion controls (if documented): Automatic cleanup by age (24h default), file count (200 default), total size (512MB default)

## Observability

- Logs/events emitted: File creation/deletion events logged
- Correlation IDs / session IDs (if any): Session ID and source in filename
- Metrics/traces (if any): None
  Evidence: server/api/ws_live_listener.py :: logger.info for dump operations

## Open Questions and Follow-up Tasks

- Questions: Is /tmp appropriate for sensitive audio data? Should use app-specific directory?
- Documentation gaps: Privacy implications not explicitly documented
- Test gaps: Integration tests for cleanup limits
- Follow-up: Consider encryption of debug dumps or user consent requirement
