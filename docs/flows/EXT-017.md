# EXT-017 Menu Bar Quick Actions

## Flow Overview

This flow provides quick access to core EchoPanel functionality through the macOS menu bar. Users can start/stop recording sessions, export data, access settings windows, and manage the application lifecycle without opening the main interface.

## Happy Path Sequence

1. User clicks EchoPanel icon in macOS menu bar to open menu
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: MenuBarExtra { menuContent }

2. Menu displays current session status and available actions
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: Text(appState.sessionState == .listening ? "Listening" : "Idle") ... Text("Timer: \(appState.timerText)")

3. User selects "Start Listening" or "Stop Listening" action
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: Button(appState.sessionState == .listening ? "Stop Listening" : "Start Listening") { toggleSession() }

4. toggleSession() validates backend readiness and permissions
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: if !backendManager.isServerReady { ... return }

5. For start: Initiates session with side panel display
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: sidePanelController.show(appState: appState) ... appState.startSession()

6. For stop: Ends current session and hides side panel
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: appState.stopSession() ... sidePanelController.hide()

7. User selects export action (JSON/Markdown)
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: Button("Export JSON") { appState.exportJSON() } ... Button("Export Markdown") { appState.exportMarkdown() }

8. Export validates content availability and opens save dialog
   - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: var exportDisabled: Bool { ... } ... func exportJSON()

9. User saves file to chosen location
   - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: panel.begin { response in ... try jsonData.write(to: url) }

10. User selects window action (Summary/History/Diagnostics)
    - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: Button("Session Summary...") { openWindow(id: "summary") }

11. Window opens with requested content
    - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: Window("Session Summary", id: "summary") { SummaryView(appState: appState) }

## Failure Modes

1. **Backend not ready for start**: Server health check fails
   - Detection: backendManager.isServerReady == false
   - Handling: Action disabled, error surfaced in side panel
   - User impact: Cannot start session, guided to diagnostics

2. **Permission denied for start**: Screen/mic permissions missing
   - Detection: Permission checks in startSession()
   - Handling: Session fails with error state
   - User impact: Cannot record, permissions banner shown

3. **Export with no content**: Attempted when transcript empty
   - Detection: exportDisabled computed property
   - Handling: Export buttons disabled in menu
   - User impact: Cannot export, buttons grayed out

4. **File save failure**: Disk full or permission denied
   - Detection: File write throws error
   - Handling: User notice with error message
   - User impact: Export fails, can retry with different location

5. **Window already open**: Attempt to open duplicate window
   - Detection: macOS handles duplicate window IDs
   - Handling: Brings existing window to front
   - User impact: No failure, existing window activated

6. **Session start during existing session**: Double-click start
   - Detection: sessionState validation in toggleSession
   - Handling: No-op, session continues
   - User impact: Safe, no duplicate sessions created

7. **Quit during active session**: User selects quit while recording
   - Detection: No special handling, standard quit
   - Handling: Session auto-stops via app lifecycle
   - User impact: Clean shutdown with session finalization

## Observability

- **Menu state updates**: Real-time status display via @ObservedObject
- **Action logging**: StructuredLogger for export successes/failures
- **Window lifecycle**: openWindow() calls tracked by SwiftUI
- **Session state changes**: Published properties update menu content
- **Error notifications**: UserNotice for export failures

## Evidence Citations

- Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift (lines 120-200) - Menu bar implementation and actions
- Code: macapp/MeetingListenerApp/Sources/AppState.swift (lines 900-1100) - Export functionality
- Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift (lines 240-280) - toggleSession logic
- Code: macapp/MeetingListenerApp/Sources/AppState.swift (lines 600-700) - Session start/stop validation
  - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: sidePanelController.show(appState: appState) { ... }

- Failure: Session recovery data corrupted
  - Where detected: JSONSerialization.data() throws
  - Current handling (as evidenced): Caught in do/catch, logged to NSLog
  - User-visible outcome (if any): Silent failure, session not recovered
  - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: } catch { NSLog("Recovery export failed: %@", error.localizedDescription) }

- Failure: NSSavePanel cancelled
  - Where detected: panel.begin response != .OK
  - Current handling (as evidenced): Guard returns early
  - User-visible outcome (if any): No action taken
  - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: guard response == .OK, let url = panel.url else { return }

- Failure: File write fails during export
  - Where detected: jsonData.write(to: url) throws
  - Current handling (as evidenced): Caught, logged
  - User-visible outcome (if any): Export fails silently
  - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: } catch { NSLog("Recovery export failed: %@", error.localizedDescription) }

## Data and Storage

- What data is produced/consumed: Session state, transcript data, export files
- Where it is stored (DB/files/userData/etc.): Export files saved to user-selected locations, session recovery data in SessionStore
- Retention / deletion controls (if documented): Export files persist until user deletes, recovery data discarded after use

## Observability

- Logs/events emitted: NSLog for recovery export failures
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
  Evidence required: Limited logging in menu actions

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: How are export file names generated?
- Documentation gaps to fill: Export file naming conventions
- Test gaps to add (note only, no implementation): Menu bar interaction in different app states, export with various data combinations</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-017.md
