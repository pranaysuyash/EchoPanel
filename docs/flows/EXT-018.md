# EXT-018 Side Panel View Mode Switching

## Flow Overview

This flow allows users to switch between different view modes in the side panel (Roll, Compact, Full) to adapt the interface to their workflow needs. Each mode provides different levels of detail and interaction capabilities for transcript viewing and meeting management.

## Happy Path Sequence

1. User opens side panel during or after recording session
   - Evidence: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: sidePanelController.show(appState: appState)

2. Side panel initializes in stored view mode (defaults to Roll)
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanelView.swift :: @AppStorage("sidePanel.viewMode") var storedViewModeRaw = ViewMode.roll.rawValue

3. User locates view mode picker in top bar (Full mode) or bottom section (narrow screens)
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanel/Shared/SidePanelLayoutViews.swift :: Picker("View mode", selection: $viewMode)

4. User selects new view mode (Roll/Compact/Full)
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanel/Shared/SidePanelLayoutViews.swift :: ForEach(ViewMode.allCases) { mode in Text(mode.rawValue).tag(mode) }

5. View mode change triggers state updates and UI reconfiguration
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanelView.swift :: .onChange(of: viewMode) { newValue in ... storedViewModeRaw = newValue.rawValue }

6. Transcript rendering adapts to new mode's spacing and layout
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanel/Shared/SidePanelTranscriptSurfaces.swift :: var rowSpacing: CGFloat { switch self { case .roll: ... } }

7. Surface overlays and interactions adjust for mode capabilities
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanelView.swift :: if viewMode == .full { showSurfaceOverlay = false }

8. Follow-live behavior adjusts based on mode (auto-enabled in Roll/Compact)
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanel/Shared/SidePanelLayoutViews.swift :: Toggle("Follow Live", isOn: $followLive)

9. Mode preference persists across app restarts
   - Evidence: macapp/MeetingListenerApp/Sources/SidePanelView.swift :: @AppStorage("sidePanel.viewMode") var storedViewModeRaw

10. Optional mode change callback notifies parent controllers
    - Evidence: macapp/MeetingListenerApp/Sources/SidePanelView.swift :: onModeChange?(viewMode)

## Failure Modes

1. **Invalid stored mode**: Corrupt UserDefaults value
   - Detection: ViewMode(rawValue:) returns nil
   - Handling: Falls back to .roll mode
   - User impact: Safe default, no data loss

2. **Mode switch during surface overlay**: Lens or surface active
   - Detection: showSurfaceOverlay == true
   - Handling: Overlay closes automatically on mode change
   - User impact: Overlay dismissed, mode switch succeeds

3. **Memory pressure during mode switch**: Large transcript re-rendering
   - Detection: UI becomes unresponsive during switch
   - Handling: SwiftUI handles view recycling automatically
   - User impact: Temporary UI freeze, recovers automatically

4. **Accessibility mode conflicts**: Screen reader with mode changes
   - Detection: VoiceOver announces mode changes
   - Handling: Proper accessibility labels on picker
   - User impact: Screen reader provides feedback

5. **Window resize conflicts**: Mode picker hidden during resize
   - Detection: panelWidth < 600 hides full mode picker
   - Handling: Alternative picker shown at bottom
   - User impact: Picker still accessible, different location

6. **State corruption during switch**: Pending operations interrupted
   - Detection: pendingNewSegments or scroll operations
   - Handling: State sanitized in sanitizeStateForTranscript()
   - User impact: UI state resets cleanly

7. **Performance degradation**: Full mode with large transcripts
   - Detection: UI lag during scrolling/filtering
   - Handling: Virtualized scrolling in transcript views
   - User impact: Smooth performance maintained

## Observability

- **Mode persistence**: UserDefaults tracking of selected mode
- **State change logging**: onChange handlers for mode switches
- **Performance monitoring**: UI render time for mode transitions
- **Accessibility events**: VoiceOver announcements for mode changes
- **Error tracking**: Invalid mode fallbacks logged

## Evidence Citations

- Code: macapp/MeetingListenerApp/Sources/SidePanelView.swift (lines 130-150) - ViewMode enum and storage
- Code: macapp/MeetingListenerApp/Sources/SidePanel/Shared/SidePanelLayoutViews.swift (lines 15-50) - Top bar picker implementation
- Code: macapp/MeetingListenerApp/Sources/SidePanel/Shared/SidePanelTranscriptSurfaces.swift (lines 30-60) - Mode-specific styling
- Code: macapp/MeetingListenerApp/Sources/SidePanelView.swift (lines 220-240) - Mode change handlers
