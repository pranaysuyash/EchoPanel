# STO-011 Session History Listing

## Summary
- Origin: Code-only
- Status: Implemented
- Lists all stored sessions from filesystem, extracting metadata and transcript availability for display in session history UI.
- Boundaries crossed: Storage, UI
- Primary components (coarse list): SessionStore, SessionHistoryView

## Triggers and Preconditions
- Triggers (user action, event, schedule, startup, etc.): SessionHistoryView appears, refresh button clicked, sessionHistoryShouldRefresh notification
- Preconditions (permissions, settings flags, availability, model cached, etc.): Application Support/sessions directory exists

## Sequence (Happy Path)
Use numbered sequence. Each step must include evidence.
For each step:
1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. listSessions() enumerates subdirectories in sessions directory
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift :: let contents = try fileManager.contentsOfDirectory(at: sessionsDir)

2. For each session directory, reads metadata.json to extract started_at timestamp
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift :: let metadataData = try? Data(contentsOf: metadataURL), JSONSerialization.jsonObject

3. Checks if transcript.jsonl file exists to determine hasTranscript flag
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift :: let hasTranscript = fileManager.fileExists(atPath: transcriptURL.path)

4. Builds tuple (id, date, hasTranscript) for each valid session
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift :: sessions.append((id: sessionId, date: date, hasTranscript: hasTranscript))

5. Returns sessions sorted by date descending (newest first)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift :: return sessions.sorted { $0.date > $1.date }

## Inputs and Outputs
- Inputs: None (reads from filesystem)
- Outputs: Array of (id: String, date: Date, hasTranscript: Bool) tuples
- Side effects (writes, network calls, model loads, UI state changes): File system directory listing and file existence checks

## Failure Modes
List 5â€“10 realistic failures:
- Failure: Sessions directory does not exist
  - Where detected: listSessions()
  - Current handling (as evidenced): guard let sessionsDir returns empty array
  - User-visible outcome (if any): Empty session list in UI
  - Evidence: macapp/MeetingListenerApp/Sources/SessionStore.swift :: guard let sessionsDir = sessionsDirectory else { return [] }

- Failure: Directory contentsOfDirectory fails
  - Where detected: listSessions()
  - Current handling (as evidenced): do/catch logs error, returns empty array
  - User-visible outcome (if any): Empty session list, error logged
  - Evidence: macapp/MeetingListenerApp/Sources/SessionStore.swift :: do { ... } catch { NSLog("SessionStore: Failed to list sessions: \(error)") }

- Failure: Metadata.json file missing or unreadable
  - Where detected: listSessions()
  - Current handling (as evidenced): try? Data(contentsOf:) uses default Date()
  - User-visible outcome (if any): Session shows current date as fallback
  - Evidence: macapp/MeetingListenerApp/Sources/SessionStore.swift :: if let metadataData = try? Data(contentsOf: metadataURL)

- Failure: Metadata JSON parsing fails
  - Where detected: listSessions()
  - Current handling (as evidenced): try? JSONSerialization uses default Date()
  - User-visible outcome (if any): Session shows current date
  - Evidence: macapp/MeetingListenerApp/Sources/SessionStore.swift :: let metadata = try? JSONSerialization.jsonObject(with: metadataData) as? [String: Any]

- Failure: started_at field missing or invalid format
  - Where detected: listSessions()
  - Current handling (as evidenced): ISO8601DateFormatter().date(from:) may return nil, uses default Date()
  - User-visible outcome (if any): Session shows current date
  - Evidence: macapp/MeetingListenerApp/Sources/SessionStore.swift :: let startedDate = ISO8601DateFormatter().date(from: startedStr)

## Data and Storage
- What data is produced/consumed: Session metadata (started_at timestamps), transcript file existence
- Where it is stored (DB/files/userData/etc.): ~/Library/Application Support/com.echopanel/sessions/<session_id>/metadata.json and transcript.jsonl
- Retention / deletion controls (if documented): Sessions retained until manually deleted, no automatic cleanup

## Observability
- Logs/events emitted: Error log on directory listing failure
- Correlation IDs / session IDs (if any): Session IDs in logged errors
- Metrics/traces (if any): None evidenced
Evidence required: macapp/MeetingListenerApp/Sources/SessionStore.swift :: NSLog("SessionStore: Failed to list sessions: \(error)")

## Open Questions and Follow-up Tasks
- Questions that cannot be answered from current evidence: How does UI handle empty session list?
- Documentation gaps to fill: Session directory structure, metadata schema
- Test gaps to add (note only, no implementation): Corrupted metadata files, permission issues, large session counts</content>
<parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/STO-011.md