# OBS-012 Exponential Backoff Restart Flow

## Summary
- Origin: Code-only
- Status: Implemented
- Automatic restart of backend server after crashes or failures using exponential backoff (1s, 2s, 4s, 8s, 10s max) with attempt limiting.
- Boundaries crossed: Process (server restart) / OS (process management)
- Primary components (coarse list): BackendManager, Timer, process monitoring

## Triggers and Preconditions
- Triggers: Backend process termination detected (crash, exit code != 0)
- Preconditions: Restart attempts < maxRestartAttempts (3), server not manually stopped

## Sequence (Happy Path)
Use numbered sequence. Each step must include evidence.
For each step:
1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Backend process termination detected
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: process.terminationHandler
     - Docs: docs/flows/OBS-005.md :: Client monitors backend process termination

2. Check if termination was expected (exit code 0)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: if process.terminationStatus != 0
     - Docs: docs/flows/OBS-005.md :: detects crashes (non-zero exit codes)

3. Increment restart attempts counter
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: restartAttempts += 1

4. Calculate exponential backoff delay (min(restartDelay, 10.0))
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: let delay = min(restartDelay, maxRestartDelay); restartDelay *= 2
     - Docs: docs/flow-atlas-20260211.md :: Exponential backoff unbounded → max cap (currently 10s)

5. Schedule restart timer with calculated delay
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: restartTimer = Timer.scheduledTimer(withTimeInterval: delay, repeats: false)
     - Docs: docs/flows/OBS-005.md :: Schedule restart with exponential backoff

6. Update server status to starting with attempt info
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: serverStatus = .starting; healthDetail = "Restarting (attempt \(restartAttempts)/\(maxRestartAttempts))..."

7. Timer fires, call startServer(isRecoveryAttempt: true)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: self?.startServer(isRecoveryAttempt: true)

## Inputs and Outputs
- Inputs: Process termination status, current restart attempts
- Outputs: Scheduled restart timer, updated server status
- Side effects (writes, network calls, model loads, UI state changes): Server process restarted, UI status updated

## Failure Modes
List 5–10 realistic failures:
- Failure: Max restart attempts exceeded
  - Where detected: macapp/MeetingListenerApp/Sources/BackendManager.swift :: guard restartAttempts < maxRestartAttempts
  - Current handling: Give up, set status to error, reset counters
  - User-visible outcome: Server marked as failed, manual restart required
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: serverStatus = .error; recoveryPhase = .failed

- Failure: Restart timer fails to schedule
  - Where detected: Timer.scheduledTimer
  - Current handling: Exception propagates, restart aborted
  - User-visible outcome: Server remains down
  - Evidence: Assumed from timer API

- Failure: Server fails to start after backoff
  - Where detected: startServer returns failure
  - Current handling: Another restart attempt scheduled
  - User-visible outcome: Continued retry attempts
  - Evidence: docs/flows/OBS-005.md :: attempts automatic restart with exponential backoff up to 3 attempts

- Failure: Process monitoring fails
  - Where detected: terminationHandler not called
  - Current handling: No restart triggered
  - User-visible outcome: Silent failure, server down
  - Evidence: Assumed from process monitoring

- Failure: Backoff delay calculation overflow
  - Where detected: restartDelay *= 2
  - Current handling: min() caps at maxRestartDelay
  - User-visible outcome: Consistent 10s delays after cap
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: let delay = min(restartDelay, maxRestartDelay)

## Data and Storage
- What data is produced/consumed: Restart attempts counter, backoff delay
- Where it is stored (DB/files/userData/etc.): In-memory instance variables
- Retention / deletion controls (if documented): Reset on successful start or max attempts

## Observability
- Logs/events emitted: Restart attempt logs, status updates
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): Restart attempt counts, delay times
Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: NSLog("BackendManager: Attempting restart...")

## Open Questions and Follow-up Tasks
- Questions that cannot be answered from current evidence: What happens if timer is invalidated? Is there jitter added?
- Documentation gaps to fill: Backoff algorithm details, failure recovery paths
- Test gaps to add (note only, no implementation): Test backoff timing, max attempts behavior, timer failure scenarios