# STO-005 RAG Document Indexing

## Summary

- Origin: Code-only
- Status: Implemented
- Indexing of user documents into local JSON store with text chunking and tokenization for lexical retrieval in RAG system.
- Boundaries crossed: Storage / Pipeline
- Primary components (coarse list): LocalRAGStore, JSON store file, chunking algorithm, BM25 scoring

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Document indexing request, app startup (store load)
- Preconditions (permissions, settings flags, availability, model cached, etc.): Store path accessible, document text provided

## Sequence (Happy Path)

1. Initialize RAG store with default path and chunk parameters
   - Evidence:
     - Code: server/services/rag_store.py:23-30
     - Docs: docs/STORAGE_AND_EXPORTS.md:22-27
2. Load existing store from JSON file on init
   - Evidence:
     - Code: server/services/rag_store.py:95-109
     - Docs: docs/STORAGE_AND_EXPORTS.md:22-27
3. Index document: chunk text, tokenize, store with metadata
   - Evidence:
     - Code: server/services/rag_store.py:37-62
     - Docs: docs/RAG_PIPELINE_ARCHITECTURE.md:1-50
4. Persist store to JSON file with atomic write
   - Evidence:
     - Code: server/services/rag_store.py:111-116
     - Docs: docs/STORAGE_AND_EXPORTS.md:22-27
5. Query documents using BM25 scoring on chunks
   - Evidence:
     - Code: server/services/rag_store.py:64-75
     - Docs: docs/RAG_PIPELINE_ARCHITECTURE.md:1-50

## Inputs and Outputs

- Inputs: Document title, text, source, chunk parameters
- Outputs: Indexed document metadata, query results with scored chunks
- Side effects (writes, network calls, model loads, UI state changes): JSON file writes, document storage

## Failure Modes

- Failure: Store path not accessible
  - Where detected: Path operations
  - Current handling (as evidenced): Use default path
  - User-visible outcome (if any): Documents stored elsewhere
  - Evidence: rag_store.py:24-25
- Failure: Store load fails (corrupt JSON)
  - Where detected: JSON parsing
  - Current handling (as evidenced): Start with empty store
  - User-visible outcome (if any): Lost indexed documents
  - Evidence: rag_store.py:104-109
- Failure: Document text empty
  - Where detected: Validation
  - Current handling (as evidenced): Raise ValueError
  - User-visible outcome (if any): Indexing fails
  - Evidence: rag_store.py:38-40
- Failure: Persist write fails
  - Where detected: File write
  - Current handling (as evidenced): Exception propagates
  - User-visible outcome (if any): Document not indexed
  - Evidence: rag_store.py:111-116
- Failure: Query tokenization fails
  - Where detected: \_tokenize()
  - Current handling (as evidenced): Return empty results
  - User-visible outcome (if any): No search results
  - Evidence: rag_store.py:65-67

## Data and Storage

- What data is produced/consumed: Document metadata, chunked text with tokens, indexed timestamps
- Where it is stored (DB/files/userData/etc.): Local JSON file (~/.echopanel/rag_store.json)
- Retention / deletion controls (if documented): Manual deletion, no auto-cleanup

## Observability

- Logs/events emitted: None direct
- Correlation IDs / session IDs (if any): Document IDs
- Metrics/traces (if any): None specific
- Evidence: No logging in code

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Is there vector storage or just lexical?
- Documentation gaps: Store format versioning, backup procedures
- Test gaps to add (note only, no implementation): Test chunking quality, scoring accuracy

