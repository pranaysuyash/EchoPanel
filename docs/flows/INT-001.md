# INT-001 Real-Time Entity Extraction Flow

## Summary

- Origin: Code-only
- Status: Implemented
- Periodic extraction of named entities (people, organizations, dates, projects, topics) from live transcript using heuristic regex patterns, with deduplication and recency tracking sent to client every 40 seconds.
- Boundaries crossed: Process / Network
- Primary components (coarse list): FastAPI analysis loop, regex-based entity extraction

## Triggers and Preconditions

- Triggers: Analysis loop timer (every 40 seconds during active session)
- Preconditions: WebSocket session active, transcript has content

## Sequence (Happy Path)

1. Analysis loop timer triggers every 40 seconds
   - Evidence:
     - Code: server/api/ws_live_listener.py :: await asyncio.sleep(12) then await asyncio.sleep(28) (lines 481, 500)
2. Snapshot current transcript segments
   - Evidence:
     - Code: server/api/ws_live_listener.py :: snapshot = list(state.transcript) (line 483)
3. Run extract_entities in thread pool with 10s timeout
   - Evidence:
     - Code: server/api/ws_live_listener.py :: asyncio.wait_for(asyncio.to_thread(extract_entities, snapshot), timeout=10.0) (lines 486-489)
4. extract_entities filters 10-minute sliding window
   - Evidence:
     - Code: server/services/analysis_stream.py :: \_filter_window(transcript, window_seconds) (line 181)
5. Regex patterns extract capitalized tokens and classify by type
   - Evidence:
     - Code: server/services/analysis_stream.py :: re.findall for titles, two-word names, single names, capitalized tokens (lines 222-320)
6. Deduplicate and track counts/recency for each entity
   - Evidence:
     - Code: server/services/analysis_stream.py :: entity_map with count/last_seen updates (lines 250-330)
7. Send entities_update WebSocket message to client
   - Evidence:
     - Code: server/api/ws_live_listener.py :: await ws_send(state, websocket, {"type": "entities_update", \*\*entities}) (line 492)

## Inputs and Outputs

- Inputs: Transcript segments with text and timestamps
- Outputs: WebSocket entities_update message with categorized entity lists
- Side effects (writes, network calls, model loads, UI state changes): WebSocket message sent to client

## Failure Modes

- Failure: Entity extraction times out after 10 seconds
  - Where detected: server/api/ws_live_listener.py :: asyncio.wait_for timeout
  - Current handling (as evidenced): TimeoutError caught, warning logged, cycle skipped
  - User-visible outcome (if any): Entities not updated for this cycle, status warning sent
  - Evidence: server/api/ws_live_listener.py :: except asyncio.TimeoutError (lines 493-496)
- Failure: Regex patterns miss entities or create false positives
  - Where detected: server/services/analysis_stream.py :: pattern matching
  - Current handling (as evidenced): Heuristic filtering with common words/orgs lists
  - User-visible outcome (if any): Incomplete or inaccurate entity extraction
  - Evidence: server/services/analysis_stream.py :: common_words, known_orgs filters (lines 185-220)
- Failure: Thread pool execution fails
  - Where detected: asyncio.to_thread call
  - Current handling (as evidenced): Exception propagates to timeout handler
  - User-visible outcome (if any): Analysis cycle skipped with warning
  - Evidence: No explicit exception handling around to_thread

## Data and Storage

- What data is produced/consumed: Entity objects with name, type, count, timestamps, quotes
- Where it is stored (DB/files/userData/etc.): In-memory during analysis, sent over WebSocket
- Retention / deletion controls (if documented): 10-minute sliding window for analysis

## Observability

- Logs/events emitted: Timeout warnings, extraction completion
- Correlation IDs / session IDs (if any): Session ID in WebSocket message
- Metrics/traces (if any): None
  Evidence: server/api/ws_live_listener.py :: logger.warning for timeouts

## Open Questions and Follow-up Tasks

- Questions: How accurate are the regex-based entity patterns compared to ML models?
- Documentation gaps: No documentation of regex patterns and their limitations
- Test gaps: Integration tests for entity extraction accuracy
- Follow-up: Consider upgrading to ML-based NER when quality becomes limiting
