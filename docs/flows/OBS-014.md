# OBS-014 Session Bundle Creation & Export Flow

## Summary
- Origin: Code-only
- Status: Implemented
- Creates session debugging bundle at session start, records all session data throughout, and allows user-initiated export of the complete bundle for troubleshooting.
- Boundaries crossed: Storage (file writes) / UI (export dialog) / Process (data collection)
- Primary components (coarse list): SessionBundleManager, SessionBundle, NSSavePanel

## Triggers and Preconditions
- Triggers: Session start (creation), user clicks export (export)
- Preconditions: Session ID available, storage permissions

## Sequence (Happy Path)
Use numbered sequence. Each step must include evidence.
For each step:
1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Session starts, bundle created with privacy-safe configuration
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: SessionBundleManager.shared.createBundle(for: id, configuration: .privacySafe)
     - Docs: docs/flow-atlas-20260211.md :: OBS-014 Session Bundle Creation & Export Flow

2. Session start event recorded in bundle
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: bundle.recordSessionStart(audioSource: audioSource.rawValue)

3. Throughout session, events recorded to bundle
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: SessionBundleManager.shared.bundle(for: sessionId)?.recordMetrics(metrics)
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: bundle.recordWebSocketStatus(...)

4. User initiates export via UI
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportDebugBundle()
     - Docs: docs/flows/STO-007.md :: User clicks "Export Debug Bundle"

5. Bundle retrieved from manager
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: SessionBundleManager.shared.bundle(for: sessionId)

6. NSSavePanel prompts for destination
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: NSSavePanel() :: savePanel.allowedContentTypes = [UTType.zip]

7. Bundle generates and zips files asynchronously
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: generateBundle() :: Process() :: /usr/bin/zip
     - Docs: docs/flows/STO-007.md :: Bundle is zipped using system zip command

## Inputs and Outputs
- Inputs: Session ID, configuration, user data throughout session
- Outputs: ZIP file containing receipt.json, events.ndjson, metrics.ndjson, transcripts, logs
- Side effects (writes, network calls, model loads, UI state changes): File writes to bundle directory, UI save dialog

## Failure Modes
List 5â€“10 realistic failures:
- Failure: Bundle creation fails
  - Where detected: createBundle call
  - Current handling: Not currently a throwing path (in-memory object creation)
  - User-visible outcome: None
  - Evidence: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: SessionBundleManager.createBundle(for:configuration:)

- Failure: File writes fail during session
  - Where detected: bundle generation/export (`generateBundle`, `exportBundle`)
  - Current handling: Throwing write/copy errors are surfaced via `recordExportFailure`
  - User-visible outcome: Incomplete bundle
  - Evidence: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: generate*() / exportBundle(to:)
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: recordExportFailure(format:error:)

- Failure: Export when no bundle exists
  - Where detected: bundle(for:) returns nil
  - Current handling: Falls back to `exportLegacyDebugBundle()`
  - User-visible outcome: Legacy bundle flow executes with success/cancel/failure user notice
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: exportDebugBundle() else { try await exportLegacyDebugBundle() }

- Failure: Zip creation fails
  - Where detected: Process /usr/bin/zip
  - Current handling: Non-zero zip exit is converted to explicit error and routed to `recordExportFailure`
  - User-visible outcome: Export fails with error
  - Evidence: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: ExportError.zipFailed(exitCode:)
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: DebugBundleExportError.zipFailed(exitCode:)

- Failure: Save panel cancelled
  - Where detected: NSSavePanel
  - Current handling: Operation cancelled and info notice recorded
  - User-visible outcome: "Debug bundle export cancelled."
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: recordExportCancelled(format:)

## Data and Storage
- What data is produced/consumed: Session events, metrics, transcripts, logs
- Where it is stored (DB/files/userData/etc.): Temporary bundle directory, exported to user-selected location
- Retention / deletion controls (if documented): Active session bundle is cleared on `resetSession()`, exported copy persists until user deletes

## Observability
- Logs/events emitted: Session start/end events, export attempts
- Correlation IDs / session IDs (if any): Session ID in bundle metadata
- Metrics/traces (if any): Bundle size, export duration
Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger.shared.info

## Open Questions and Follow-up Tasks
- Questions that cannot be answered from current evidence: What happens to bundle on app crash? Is bundle data encrypted?
- Documentation gaps to fill: Bundle format specification, privacy controls
- Test gaps to add (note only, no implementation): Test bundle integrity, export with missing data, large bundle handling
