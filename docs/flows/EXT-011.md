# EXT-011 Session Recovery from Crash

## Summary

- Origin: Code-only
- Status: Implemented
- Detects unfinished sessions on app restart via recovery.json marker, offers recovery UI in menu bar and history view, allows export of recovered session data or discard.
- Boundaries crossed: UI (recovery menu items) / Storage (recovery marker file, session snapshots)
- Primary components (coarse list): SessionStore, MeetingListenerApp menu, SessionHistoryView

## Triggers and Preconditions

- Triggers: App restart with existing recovery.json marker
- Preconditions: Previous session ended abnormally (crash/kill), recovery marker exists

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. App starts, SessionStore checks for recovery.json on init
   - Evidence:
     - Code: SessionStore :: init() :: checkForRecoverableSession()
     - Docs: flow-atlas-20260211.md :: EXT-011 Session Recovery from Crash

1. If recovery.json exists, loads session_id and timestamp
   - Evidence:
     - Code: SessionStore :: checkForRecoverableSession() :: let data = try Data(contentsOf: recoveryURL)
     - Code: SessionStore :: checkForRecoverableSession() :: recoverableSessionId = sessionId; hasRecoverableSession = true

1. Recovery options appear in menu bar ("Recover Last Session...", "Discard Last Session")
   - Evidence:
     - Code: MeetingListenerApp :: if sessionStore.hasRecoverableSession { Button("Recover Last Session...") }
     - Code: MeetingListenerApp :: Button("Discard Last Session") { sessionStore.discardRecoverableSession() }

1. User selects "Recover Last Session...", loads snapshot from session directory
   - Evidence:
     - Code: MeetingListenerApp :: if let data = sessionStore.loadRecoverableSession()
     - Code: SessionStore :: loadRecoverableSession() :: let data = try Data(contentsOf: snapshotURL)

1. App shows save panel for exporting recovered JSON data
   - Evidence:
     - Code: MeetingListenerApp :: let panel = NSSavePanel(); panel.nameFieldStringValue = "recovered-session.json"
     - Code: MeetingListenerApp :: try jsonData.write(to: url); sessionStore.discardRecoverableSession()

1. On successful export, recovery marker is cleared
   - Evidence:
     - Code: MeetingListenerApp :: sessionStore.discardRecoverableSession()
     - Code: SessionStore :: discardRecoverableSession() :: clearRecoveryMarker()

## Inputs and Outputs

- Inputs: User selection of recovery action
- Outputs: Exported JSON file with recovered session data
- Side effects (writes, network calls, model loads, UI state changes): Recovery marker file removed, session directory may be deleted

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Recovery marker file corrupted
  - Where detected: JSONSerialization.jsonObject fails in checkForRecoverableSession
  - Current handling (as evidenced): Logs error, no recovery offered
  - User-visible outcome (if any): No recovery options shown
  - Evidence: SessionStore :: catch { NSLog("SessionStore: Failed to read recovery marker: \(error)") }

- Failure: Recoverable session snapshot missing
  - Where detected: loadRecoverableSession finds no snapshot.json
  - Current handling (as evidenced): Returns nil, recovery button does nothing
  - User-visible outcome (if any): Recovery button appears but export fails silently
  - Evidence: SessionStore :: guard fileManager.fileExists(atPath: snapshotURL.path) else { return nil }

- Failure: Export save panel cancelled
  - Where detected: panel.begin response != .OK
  - Current handling (as evidenced): Early return, recovery marker persists
  - User-visible outcome (if any): Recovery options remain available
  - Evidence: MeetingListenerApp :: guard response == .OK, let url = panel.url else { return }

- Failure: JSON write fails
  - Where detected: jsonData.write(to: url) throws
  - Current handling (as evidenced): Exception logged, recovery marker persists
  - User-visible outcome (if any): Error logged, recovery options remain
  - Evidence: MeetingListenerApp :: catch { NSLog("Recovery export failed: %@", error.localizedDescription) }

## Data and Storage

- What data is produced/consumed: Session snapshot (transcript, entities, etc.), recovery marker
- Where it is stored (DB/files/userData/etc.): recovery.json marker file, session snapshot.json
- Retention / deletion controls (if documented): Marker cleared on successful recovery or discard

## Observability

- Logs/events emitted: Recovery marker read/write errors, successful discard
- Correlation IDs / session IDs (if any): session_id in recovery marker and logs
- Metrics/traces (if any): None
  Evidence: SessionStore :: NSLog("SessionStore: Found recoverable session \(sessionId) from \(timestamp)")

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: When is recovery marker created? What data is in snapshot vs final snapshot?
- Documentation gaps to fill: Recovery marker format and timing
- Test gaps to add (note only, no implementation): Test recovery with corrupted marker, test recovery after normal session end</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-011.md
