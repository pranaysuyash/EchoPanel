# AUD-009 Clock Drift Compensation

## Summary

- Origin: Mixed (audit hypothesis + code-grounded telemetry)
- Status: Partial
- Clock-drift compensation behavior is still unimplemented, but staged client flags and cross-source drift telemetry are now wired end-to-end.
- Boundaries crossed: Client start contract / server ASR metrics / observability
- Primary components (coarse list): WebSocketStreamer, BackendConfig, BroadcastFeatureManager, ws_live_listener.py

## Triggers and Preconditions

- Triggers: session `start` handshake and ongoing ASR final events in multi-source sessions
- Preconditions: websocket session started; at least two active sources for non-zero spread metrics

## Sequence (Current Behavior)

1. Client start payload now includes staged clock-drift flags under `client_features`.
   - Evidence:
     - Code: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `sendStart()` includes `client_features.clock_drift_compensation_enabled`
     - Code: `macapp/MeetingListenerApp/Sources/BackendConfig.swift` :: `clockDriftCompensationEnabled`
2. Server parses and stores client feature flags at session start.
   - Evidence:
     - Code: `server/api/ws_live_listener.py` :: `_extract_client_features(...)`, start-message assignment to `SessionState`
3. Server tracks latest ASR `t1` per source and computes spread telemetry.
   - Evidence:
     - Code: `server/api/ws_live_listener.py` :: `state.asr_last_t1_by_source`, `_update_source_clock_spread(...)`
4. Metrics stream now emits `source_clock_spread_ms` and `max_source_clock_spread_ms`.
   - Evidence:
     - Code: `server/api/ws_live_listener.py` :: `_metrics_loop` payload fields
5. Final summary includes drift telemetry snapshot and client feature flags.
   - Evidence:
     - Code: `server/api/ws_live_listener.py` :: `final_summary.json.clock_spread_ms`, `final_summary.json.client_features`

## Inputs and Outputs

- Inputs:
  - ASR segment timestamps (`t1`) by source
  - Client feature flags from start payload
- Outputs:
  - Runtime spread metrics (`source_clock_spread_ms`, `max_source_clock_spread_ms`)
  - Final summary drift snapshot
- Side effects: observability improvements only; no timestamp correction/reordering logic added

## Failure Modes

- Failure: Single-source session
  - Where detected: spread computation
  - Current handling: spread metrics stay `0.0`
  - User-visible outcome: no drift signal (expected)
  - Evidence: `server/api/ws_live_listener.py` :: `_update_source_clock_spread`

- Failure: Client omits `client_features`
  - Where detected: feature extraction
  - Current handling: safe defaults to `False`
  - User-visible outcome: unchanged behavior
  - Evidence: `server/api/ws_live_listener.py` :: `_extract_client_features`

## Data and Storage

- What data is produced/consumed: per-source latest ASR timestamp and spread metrics
- Where it is stored: in-memory `SessionState`; included in metrics events/final summary
- Retention / deletion controls: session-scoped

## Observability

- Logs/events emitted: session-start log now includes staged feature flags
- Correlation IDs / session IDs: existing websocket/session IDs unchanged
- Metrics/traces: `source_clock_spread_ms`, `max_source_clock_spread_ms`

## Open Questions and Follow-up Tasks

- Questions: what drift threshold should trigger compensation action?
- Documentation gaps: compensation algorithm choice (linear offset vs resampling), rollback policy
- Test gaps: long-running dual-source drift benchmarks and threshold validation
