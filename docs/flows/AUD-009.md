# AUD-009 Clock Drift Compensation

## Summary

- Origin: Hypothesized
- Status: Hypothesized
- 1â€“2 sentence description: Compensates for clock drift between multiple audio sources (system + microphone) to maintain timestamp synchronization in dual-source sessions.
- Boundaries crossed: OS (CACurrentMediaTime), Process (timestamp adjustment), Model (timestamp correction)
- Primary components (coarse list): ws_live_listener.py, provider_faster_whisper.py, RedundantAudioCaptureManager

## Triggers and Preconditions

- Triggers: Dual-source session start, periodic timestamp validation, drift detection threshold exceeded
- Preconditions: Redundant audio enabled, both system and microphone sources active, session duration > threshold

## Sequence (Happy Path)

1. **Shared monotonic clock initialization**
   - At session start, capture CACurrentMediaTime as session_start_time
   - Initialize source-relative timestamp offsets
   - Evidence:
     - Code: Hypothesized - would require new timestamp manager
     - Docs: docs/audit/streaming-reliability-dual-pipeline-20260210.md:70

2. **Per-source timestamp tracking**
   - Each source maintains processed_samples counter
   - Convert to absolute timestamps using session_start_time + source_offset
   - Evidence:
     - Code: provider_faster_whisper.py:125,154-157
     - Docs: docs/audit/audio-industry-code-review-20260211.md:175

3. **Drift detection**
   - Compare absolute timestamps between sources periodically
   - Calculate drift rate (samples/second difference)
   - Evidence:
     - Code: Hypothesized - no drift monitoring implemented
     - Docs: docs/flow-atlas-20260211.md:719

4. **Offset adjustment**
   - Apply linear correction to slower source timestamps
   - Update source_offset to compensate accumulated drift
   - Evidence:
     - Code: Hypothesized - CACurrentMediaTime usage needed
     - Docs: docs/audit/streaming-reliability-dual-pipeline-20260210.md:70

5. **Transcript reordering**
   - Sort transcript segments by corrected absolute timestamps
   - Maintain source attribution for diarization
   - Evidence:
     - Code: Hypothesized - would modify ws_live_listener.py:773
     - Docs: docs/audit/asr-provider-performance-20260211.md:558

## Inputs and Outputs

- Inputs:
  - CACurrentMediaTime readings
  - Per-source processed_samples counters
  - Session start timestamp
- Outputs:
  - Corrected t0/t1 timestamps in ASR segments
  - Drift metrics for observability
- Side effects: Transcript segment reordering, timestamp adjustments

## Failure Modes

- Failure: Drift exceeds correction threshold
  - Where detected: Drift calculation exceeds configurable limit
  - Current handling: Hypothesized - no implementation
  - User-visible outcome: Transcript segments out of chronological order
  - Evidence: docs/audit/audio-industry-code-review-20260211.md:499

- Failure: Clock source instability
  - Where detected: CACurrentMediaTime readings become non-monotonic
  - Current handling: Hypothesized - no validation
  - User-visible outcome: Timestamp jumps, transcript corruption
  - Evidence: docs/audit/streaming-reliability-dual-pipeline-20260210.md:70

- Failure: Source restart during session
  - Where detected: Audio source failover resets processed_samples
  - Current handling: Hypothesized - no continuity tracking
  - User-visible outcome: Timestamp discontinuity after failover
  - Evidence: docs/audit/AUDIT_04_BROADCAST_READINESS.md:97

- Failure: NTP timestamp conflicts
  - Where detected: NTP sync changes session reference time
  - Current handling: Hypothesized - no NTP integration with audio timestamps
  - User-visible outcome: Absolute timestamps become inconsistent
  - Evidence: docs/IMPLEMENTATION_PLAN_Audio_Hardening.md:24

## Data and Storage

- What data is produced/consumed: Session start time, source offsets, drift measurements
- Where it is stored: In-memory session state, potentially persisted for debugging
- Retention / deletion controls: Session-scoped, cleared on session end

## Observability

- Logs/events emitted: Drift measurements, correction applications, threshold violations
- Correlation IDs / session IDs: Session ID for tracking across sources
- Metrics/traces: Drift rate, correction magnitude, timestamp discontinuities
- Evidence: Hypothesized - no current implementation

## Open Questions and Follow-up Tasks

- Questions: What is acceptable drift threshold before correction? How to handle NTP sync during session?
- Documentation gaps: Detailed timestamp math, CACurrentMediaTime integration
- Test gaps: Long-duration dual-source sessions, NTP sync during recording, source failover timing
