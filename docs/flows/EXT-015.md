# EXT-015 Context Document Indexing (RAG)

## Summary

- Origin: Mixed
- Status: Implemented
- 1â€“2 sentence description: Upload and index local text documents (txt/md/json/csv) for retrieval-augmented generation context, using lexical chunking without embeddings.
- Boundaries crossed: UI / Process / Storage
- Primary components (coarse list): NSOpenPanel (Swift), AppState.indexContextDocumentAsync (Swift), documents/index API (Python), LocalRAGStore (Python)

## Triggers and Preconditions

- Triggers: User clicks "Upload Document..." button in side panel context section
- Preconditions: Backend server running and healthy, user has read access to selected file

## Sequence (Happy Path)

1. User clicks "Upload Document..." button
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SidePanel/Full/SidePanelFullViews.swift :: Button("Upload Document...") { pickContextFileForIndexing() }
     - Docs: docs/flow-atlas-v2-20260212.md :: "Index document", "Documents API"
   - Notes: Triggers NSOpenPanel file picker

2. NSOpenPanel shows file picker with supported formats
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SidePanel/Full/SidePanelFullViews.swift :: panel.allowedContentTypes = [.text, .plainText, .commaSeparatedText, .json, .sourceCode]
   - Notes: Filters to text-based files only

3. User selects file, AppState.indexContextDocumentAsync() called
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SidePanel/Full/SidePanelFullViews.swift :: panel.begin { response in ... appState.indexContextDocument(from: url) }
   - Notes: Async operation with busy state

4. Load text file content with size validation
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: let text = try loadTextFile(fileURL) ... if text.count > 250_000 { ... return }
   - Notes: 250k character limit enforced

5. POST to /documents/index API with document data
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: let request = makeAuthorizedRequest(url: BackendConfig.documentsIndexURL, method: "POST", body: body)
     - Docs: docs/FLOW_ATLAS.md :: DocumentsAPI | `api/documents.py` | RAG document API
   - Notes: Includes title, source path, and text content

6. Server validates and indexes document
   - Evidence:
     - Code: server/api/documents.py :: @router.post("/documents/index") ... indexed = store.index_document(...)
   - Notes: Calls LocalRAGStore.index_document()

7. LocalRAGStore chunks text and stores in JSON file
   - Evidence:
     - Code: server/services/rag_store.py :: def index_document(self, title: str, text: str, source: str = "local", document_id: Optional[str] = None) -> dict: ... chunks = self.\_chunk_document(clean_text) ... self.\_persist()
     - Docs: docs/FLOW_ATLAS.md :: RAGStore | `services/rag_store.py` | Document storage
   - Notes: Lexical chunking (120 words, 30 overlap), no embeddings

8. UI updates with success message and refreshes document list
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: contextStatusMessage = "Indexed \(fileURL.lastPathComponent)." ... await fetchContextDocuments(force: true)
   - Notes: Updates contextDocuments array for UI

## Inputs and Outputs

- Inputs: File URL (local filesystem path), file content as text
- Outputs: Indexed document metadata (ID, title, source, indexed_at, preview, chunk_count)
- Side effects (writes, network calls, model loads, UI state changes): HTTP POST to backend, writes to local JSON store file, UI status updates, document list refresh

## Failure Modes

- Failure: File too large (>250k characters)
  - Where detected: indexContextDocumentAsync() size check
  - Current handling (as evidenced): Shows error message, returns early
  - User-visible outcome (if any): Status message "File too large (X chars). Keep context files under 250k chars."
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: if text.count > 250_000 { contextStatusMessage = "File too large..." }

- Failure: Empty or invalid text content
  - Where detected: LocalRAGStore.index_document() validation
  - Current handling (as evidenced): Raises ValueError, caught as HTTP 400
  - User-visible outcome (if any): Status message "Indexing failed: Bad Request"
  - Evidence: server/services/rag_store.py :: if not clean_text: raise ValueError("Document text is empty")

- Failure: File read error (permissions, encoding, etc.)
  - Where detected: loadTextFile() throws error
  - Current handling (as evidenced): Caught in do/catch, shows error message
  - User-visible outcome (if any): Status message "Indexing failed: [error description]"
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: } catch { contextStatusMessage = "Indexing failed: \(error.localizedDescription)" }

- Failure: Backend API error (auth, network, server error)
  - Where detected: URLSession.data() throws or HTTP status check fails
  - Current handling (as evidenced): Caught in do/catch, shows error message
  - User-visible outcome (if any): Status message "Indexing failed: [error description]"
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: try ensureHTTPStatus(response, data: data) ... } catch { contextStatusMessage = "Indexing failed..." }

## Data and Storage

- What data is produced/consumed: Document metadata + chunked text with lexical tokens
- Where it is stored (DB/files/userData/etc.): Local JSON file (default: ~/.echopanel/documents.json)
- Retention / deletion controls (if documented): Documents persist until explicitly deleted via API

## Observability

- Logs/events emitted: None specific (API calls logged via FastAPI, file operations not logged)
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
  Evidence required: No specific logging identified in evidence sweep

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: How is document store path configured?
- Documentation gaps to fill: Store path environment variable usage
- Test gaps to add (note only, no implementation): File size limit edge cases, encoding error handling</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-015.md
