# STO-009 JSON/Markdown Export

## Summary

- Origin: Code-only
- Status: Implemented
- Export of session data as JSON or Markdown files using macOS save panel, including transcript, entities, actions, decisions, risks, and final summary.
- Boundaries crossed: UI / Storage
- Primary components (coarse list): AppState, NSSavePanel, exportPayload, renderLiveMarkdown

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): User clicks "Export JSON" or "Export Markdown" buttons in UI
- Preconditions (permissions, settings flags, availability, model cached, etc.): Session data available (transcript segments, entities, etc.)

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User clicks Export JSON or Export Markdown button
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SidePanelTranscriptSurfaces.swift :: Button("Export JSON") { appState.exportJSON() }
     - Code: macapp/MeetingListenerApp/Sources/SidePanelTranscriptSurfaces.swift :: Button("Export Markdown") { appState.exportMarkdown() }
   - Notes: Available in side panel and summary view

1. App displays macOS save panel with appropriate file type and default name
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportJSON() :: panel.allowedContentTypes = [UTType.json]
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportMarkdown() :: panel.allowedContentTypes = [UTType.plainText]
   - Notes: JSON: "echopanel-session.json", Markdown: "echopanel-notes.md"

1. User selects save location and confirms
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: panel.begin { response in guard response == .OK
   - Notes: Asynchronous completion handler

1. For JSON export: Generate structured payload with session metadata and all data
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportJSON() :: let payload = self.exportPayload()
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportPayload() :: return ["session": [...], "transcript": [...], ...]
   - Notes: Includes transcript segments, entities, actions, decisions, risks, final summary

1. For Markdown export: Render formatted markdown from live data or final summary
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportMarkdown() :: let markdown = self.finalSummaryMarkdown.isEmpty ? self.renderLiveMarkdown() : self.finalSummaryMarkdown
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: renderLiveMarkdown() :: var lines: [String] = []; lines.append("# Live Notes")
   - Notes: Uses final summary if available, otherwise renders live transcript with entities

1. Serialize data and write to user-selected file
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportJSON() :: let data = try JSONSerialization.data(withJSONObject: payload, options: [.prettyPrinted, .sortedKeys])
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: exportMarkdown() :: try markdown.write(to: url, atomically: true, encoding: .utf8)
   - Notes: JSON pretty-printed with sorted keys

## Inputs and Outputs

- Inputs: Export type (JSON/Markdown), user-selected file URL
- Outputs: JSON or Markdown file written to disk
- Side effects (writes, network calls, model loads, UI state changes): File system writes, NSSavePanel UI display

## Failure Modes

List 5â€“10 realistic failures:

- Failure: User cancels save panel
  - Where detected: NSSavePanel response check
  - Current handling (as evidenced): Returns early, no export
  - User-visible outcome (if any): None, export cancelled
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: response == .OK

- Failure: JSON serialization fails
  - Where detected: exportJSON()
  - Current handling (as evidenced): Throws error, caught in completion
  - User-visible outcome (if any): Error logged to console
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: try JSONSerialization.data

- Failure: File write fails (permissions, disk full)
  - Where detected: data.write(to: url) or markdown.write(to: url)
  - Current handling (as evidenced): Throws error, logged to console
  - User-visible outcome (if any): Export fails silently
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: catch { NSLog("Export failed: %@", error.localizedDescription) }

- Failure: No session data available
  - Where detected: exportPayload() or renderLiveMarkdown()
  - Current handling (as evidenced): Exports empty/partial data
  - User-visible outcome (if any): Empty file created
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: transcriptSegments.map, actions.map, etc.

- Failure: Final summary data corrupted
  - Where detected: finalSummaryMarkdown.isEmpty check
  - Current handling (as evidenced): Falls back to live rendering
  - User-visible outcome (if any): Live data exported instead
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: finalSummaryMarkdown.isEmpty ? renderLiveMarkdown() : finalSummaryMarkdown

## Data and Storage

- What data is produced/consumed: Session transcript, entities, actions, decisions, risks, final summary in JSON or Markdown format
- Where it is stored (DB/files/userData/etc.): User-selected file location (anywhere user chooses)
- Retention / deletion controls (if documented): Files persist until user deletes, no automatic cleanup

## Observability

- Logs/events emitted: Error logs on failure ("Export failed: %@")
- Correlation IDs / session IDs (if any): None in logs
- Metrics/traces (if any): None
  Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: NSLog("Export failed: %@", error.localizedDescription)

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Is there success feedback to user? Are exports logged for analytics?
- Documentation gaps to fill: Export file format specifications
- Test gaps to add (note only, no implementation): Export with empty data, export cancellation, file permission errors</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/STO-009.md
