# EXT-012 Backend Server Start

## Summary

- Origin: Code-only
- Status: Implemented
- Launches Python FastAPI server process via uvicorn, sets environment variables, redirects output to log file, starts health checks, handles existing backend detection.
- Boundaries crossed: Process (spawn Python process) / Network (health check HTTP requests) / Storage (log file creation)
- Primary components (coarse list): BackendManager, Process, URLSession

## Triggers and Preconditions

- Triggers: App launch, manual restart from settings, crash recovery
- Preconditions: Python executable available, server directory found, port not in use by incompatible service

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. BackendManager.startServer() called, checks for existing backend on configured host/port
   - Evidence:
     - Code: BackendManager :: startServer() :: switch probeExistingBackend(timeout: 0.25)
     - Docs: flow-atlas-20260211.md :: EXT-012 Backend Server Start

1. If healthy existing backend found, adopts it without starting new process
   - Evidence:
     - Code: BackendManager :: startServer() :: case .healthy(let detail): usingExternalBackend = true; isServerReady = true
     - Code: BackendManager :: startServer() :: serverStatus = .running

1. Locates server directory and Python executable
   - Evidence:
     - Code: BackendManager :: startServer() :: guard let serverPath = findServerPath()
     - Code: BackendManager :: startServer() :: guard let pythonPath = findPythonPath(serverDir: serverPath)

1. Creates Process with uvicorn command, sets environment variables (model, tokens)
   - Evidence:
     - Code: BackendManager :: startServer() :: process.arguments = ["-m", "uvicorn", "server.main:app", "--host", serverHost, "--port", "\(serverPort)"]
     - Code: BackendManager :: startServer() :: env["ECHOPANEL_WHISPER_MODEL"] = sanitizeWhisperModel(...)

1. Creates log file in temp directory, redirects stdout/stderr
   - Evidence:
     - Code: BackendManager :: startServer() :: let logURL = FileManager.default.temporaryDirectory.appendingPathComponent("echopanel_server.log")
     - Code: BackendManager :: startServer() :: process.standardOutput = fileHandle

1. Launches process, starts 1Hz health check timer
   - Evidence:
     - Code: BackendManager :: startServer() :: try process.run(); startHealthCheck()
     - Code: BackendManager :: startHealthCheck() :: healthCheckTimer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true)

1. Health check polls /health endpoint until 200 OK with status "ok"
   - Evidence:
     - Code: BackendManager :: checkHealth() :: URLSession.shared.dataTask(with: healthCheckURL)
     - Code: BackendManager :: checkHealth() :: if statusCode == 200 && status == "ok" { isServerReady = true }

1. On health success, updates status to .running, stops health check timer
   - Evidence:
     - Code: BackendManager :: checkHealth() :: self.serverStatus = .running; healthCheckTimer?.invalidate()

## Inputs and Outputs

- Inputs: Host/port configuration, model selection, tokens from Keychain
- Outputs: Running Python process, health status updates
- Side effects (writes, network calls, model loads, UI state changes): Process spawned, log file created, HTTP health requests, status published

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Port already in use by incompatible service
  - Where detected: probeExistingBackend returns .portInUse
  - Current handling (as evidenced): Sets error status, shows "Port X is already in use" message
  - User-visible outcome (if any): Error status in settings, cannot start session
  - Evidence: BackendManager :: case .portInUse: serverStatus = .error

- Failure: Python executable not found
  - Where detected: findPythonPath returns nil
  - Current handling (as evidenced): Sets error status, no restart attempt
  - User-visible outcome (if any): Error status, server marked as failed
  - Evidence: BackendManager :: guard let pythonPath = findPythonPath(...) else { serverStatus = .error }

- Failure: Process launch fails
  - Where detected: process.run() throws
  - Current handling (as evidenced): Logs error, sets error status
  - User-visible outcome (if any): Error status, recovery may attempt restart
  - Evidence: BackendManager :: catch { serverStatus = .error; recoveryPhase = .failed }

- Failure: Health check timeout (server doesn't respond within configured timeout; default 2s)
  - Where detected: URLSession timeout or no response
  - Current handling (as evidenced): Continues polling, healthDetail shows error
  - User-visible outcome (if any): Server shows as starting, not ready for sessions
  - Evidence: BackendManager :: request.timeoutInterval = BackendConfig.healthCheckTimeout

- Failure: Health endpoint returns error status
  - Where detected: HTTP status != 200 or status != "ok"
  - Current handling (as evidenced): Continues polling, shows health detail
  - User-visible outcome (if any): Server not marked ready, sessions blocked
  - Evidence: BackendManager :: if statusCode == 200 && status == "ok"

## Data and Storage

- What data is produced/consumed: Environment variables, log output
- Where it is stored (DB/files/userData/etc.): Temp log file, process environment
- Retention / deletion controls (if documented): Log file persists until app exit

## Observability

- Logs/events emitted: Process start/stop, health check results, errors
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
  Evidence: BackendManager :: NSLog("BackendManager: Starting server")

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: What happens during health check failures? How are external backends validated?
- Documentation gaps to fill: Health check endpoint specification
- Test gaps to add (note only, no implementation): Test port conflict detection, test health check with slow server</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-012.md
