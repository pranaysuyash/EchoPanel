# STO-008 Structured Logging Storage

## Summary

- Origin: Code-only
- Status: Implemented
- Storage of structured JSON logs with PII redaction, correlation IDs, and automatic log rotation for observability and debugging.
- Boundaries crossed: UI / Storage
- Primary components (coarse list): StructuredLogger, FileHandle, DispatchQueue

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Any logging call (debug/info/warning/error/critical) throughout the application
- Preconditions (permissions, settings flags, availability, model cached, etc.): StructuredLogger initialized with enableFileOutput=true, Application Support directory accessible

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Logging method called with message and metadata
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: info/warning/error/critical methods
   - Notes: Includes optional error and metadata parameters

1. Log level checked against minimum threshold
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: level >= configuration.minLevel
   - Notes: Early return if below threshold

1. JSON log entry constructed with timestamp, level, message, component, correlation context
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: var entry: [String: Any] = [...]
   - Notes: Includes redacted message and metadata

1. PII redaction applied to message and metadata strings
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: redact(\_ text: String)
   - Notes: Uses configured redaction patterns

1. Entry written to file asynchronously on utility queue
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: fileQueue.async { ... logFileHandle.write(data) }
   - Notes: JSON data with newline appended

1. File size checked after write for rotation
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: rotateLogsIfNeeded()
   - Notes: Called after each write

1. If size exceeds limit, logs rotated (rename .1 to .2, current to .1, create new)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: rotateLogs()
   - Notes: Keeps up to maxFileCount rotated files

## Inputs and Outputs

- Inputs: Log level, message string, optional error, optional metadata dict, source location (file/function/line)
- Outputs: JSON line written to log file
- Side effects (writes, network calls, model loads, UI state changes): File system writes to Application Support/logs/, file rotation operations

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Application Support directory not accessible
  - Where detected: StructuredLogger.init()
  - Current handling (as evidenced): setupLogFile() fails silently, no file logging
  - User-visible outcome (if any): None, console/OS logging continues
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: FileManager.default.urls(for: .applicationSupportDirectory)

- Failure: Log file creation fails
  - Where detected: setupLogFile()
  - Current handling (as evidenced): try? FileHandle, error logged to console
  - User-visible outcome (if any): None
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try FileHandle(forWritingTo: logFileURL!)

- Failure: File write fails
  - Where detected: writeToFile()
  - Current handling (as evidenced): Silent failure, no error handling
  - User-visible outcome (if any): Log entry lost
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: logFileHandle.write(data)

- Failure: JSON serialization fails
  - Where detected: writeToFile()
  - Current handling (as evidenced): try? JSONSerialization, skips write if fails
  - User-visible outcome (if any): Log entry lost
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? JSONSerialization.data

- Failure: Log rotation fails
  - Where detected: rotateLogs()
  - Current handling (as evidenced): try? operations, continues without rotation
  - User-visible outcome (if any): File grows beyond limit
  - Evidence: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? fileManager.moveItem

## Data and Storage

- What data is produced/consumed: JSON log entries with timestamp, level, message, component, correlation IDs, redacted metadata
- Where it is stored (DB/files/userData/etc.): ~/Library/Application Support/com.echopanel/MeetingListenerApp/logs/echopanel.log and rotated .1, .2, etc.
- Retention / deletion controls (if documented): Automatic rotation when file exceeds 10MB, keeps 5 rotated files, no explicit deletion

## Observability

- Logs/events emitted: None (this is the logging system itself)
- Correlation IDs / session IDs (if any): Included in every log entry via context
- Metrics/traces (if any): None
  Evidence: No self-logging in StructuredLogger

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Are logs included in session bundles? What happens on disk full?
- Documentation gaps to fill: Log format specification, redaction patterns
- Test gaps to add (note only, no implementation): File rotation, redaction effectiveness, concurrent logging</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/STO-008.md
