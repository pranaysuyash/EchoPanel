# STO-001 Session Lifecycle Storage

## Summary

- Origin: Mixed
- Status: Implemented
- Local filesystem storage for session data including metadata, transcript, snapshots, and crash recovery markers, with auto-save and session history management.
- Boundaries crossed: Storage / UI
- Primary components (coarse list): SessionStore class, JSON/JSONL files, auto-save timer, recovery marker

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Session start, auto-save timer (30s), session end, app launch (recovery check)
- Preconditions (permissions, settings flags, availability, model cached, etc.): Application Support directory accessible, session ID generated

## Sequence (Happy Path)

1. Setup sessions directory in Application Support on init
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:32-47
     - Docs: docs/STORAGE_AND_EXPORTS.md:5-6
2. Start session: create directory, write metadata.json, create transcript.jsonl, mark recoverable, start auto-save timer
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:52-88
     - Docs: docs/STORAGE_AND_EXPORTS.md:7-11
3. Append transcript segments to JSONL file during session
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:104-113
     - Docs: docs/STORAGE_AND_EXPORTS.md:9
4. Auto-save snapshot.json every 30 seconds
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:115-131, 133-142
     - Docs: docs/STORAGE_AND_EXPORTS.md:11, docs/DECISIONS.md:14
5. End session: write final_snapshot.json, close files, clear recovery marker, stop timer
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:94-107
     - Docs: docs/STORAGE_AND_EXPORTS.md:12-13
6. Check for recoverable session on app launch
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:167-185
     - Docs: docs/STORAGE_AND_EXPORTS.md:15-16

## Inputs and Outputs

- Inputs: Session ID, audio source, transcript segments, session data snapshots
- Outputs: Stored files (metadata.json, transcript.jsonl, snapshot.json, final_snapshot.json, recovery.json)
- Side effects (writes, network calls, model loads, UI state changes): File writes, directory creation, recovery notifications

## Failure Modes

- Failure: Application Support directory inaccessible
  - Where detected: setupDirectory()
  - Current handling (as evidenced): Log error, disable storage
  - User-visible outcome (if any): No session persistence
  - Evidence: SessionStore.swift:33-35
- Failure: Session directory creation fails
  - Where detected: startSession()
  - Current handling (as evidenced): Log error, continue without storage
  - User-visible outcome (if any): Session not saved
  - Evidence: SessionStore.swift:56-58
- Failure: Metadata write fails
  - Where detected: JSON serialization
  - Current handling (as evidenced): Log error
  - User-visible outcome (if any): Missing metadata
  - Evidence: SessionStore.swift:59-67
- Failure: Transcript append fails
  - Where detected: FileHandle write
  - Current handling (as evidenced): Log error, continue
  - User-visible outcome (if any): Missing transcript segments
  - Evidence: SessionStore.swift:107-112
- Failure: Snapshot save fails
  - Where detected: JSON write
  - Current handling (as evidenced): Log error
  - User-visible outcome (if any): No auto-save
  - Evidence: SessionStore.swift:122-129
- Failure: Recovery marker write fails
  - Where detected: JSON write
  - Current handling (as evidenced): Log error
  - User-visible outcome (if any): No crash recovery
  - Evidence: SessionStore.swift:152-159
- Failure: Recovery check fails
  - Where detected: File read/parse
  - Current handling (as evidenced): Log error, no recovery prompt
  - User-visible outcome (if any): Lost recoverable session
  - Evidence: SessionStore.swift:170-185

## Data and Storage

- What data is produced/consumed: Session metadata, transcript events, periodic snapshots, recovery markers
- Where it is stored (DB/files/userData/etc.): Local filesystem JSON/JSONL files in ~/Library/Application Support/
- Retention / deletion controls (if documented): Manual deletion via UI, no auto-cleanup

## Observability

- Logs/events emitted: Session start/end, save operations, errors
- Correlation IDs / session IDs (if any): Session ID in logs
- Metrics/traces (if any): None specific
- Evidence: SessionStore.swift NSLog statements

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Are there storage quotas or size limits?
- Documentation gaps: Storage encryption, backup procedures
- Test gaps to add (note only, no implementation): Test storage under disk full, permission denied</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/STO-001.md
