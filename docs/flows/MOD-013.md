# MOD-013 Fallback Provider Switching

## Summary
- Origin: Code-only
- Status: Implemented
- Automatic switching to fallback ASR provider when current provider fails, triggered by error reporting in degrade ladder system.
- Boundaries crossed: Process, Model
- Primary components (coarse list): DegradeLadder, ASRProvider

## Triggers and Preconditions
- Triggers (user action, event, schedule, startup, etc.): report_provider_error() called on DegradeLadder with Exception
- Preconditions (permissions, settings flags, availability, model cached, etc.): Fallback provider configured, current degrade level < FAILOVER

## Sequence (Happy Path)
Use numbered sequence. Each step must include evidence.
For each step:
1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. report_provider_error() logs error and checks for fallback availability
   - Evidence:
     - Code: server/services/degrade_ladder.py :: logger.error(f"Provider error: {error}"); if self.fallback_provider and self.state.level < DegradeLevel.FAILOVER

2. _degrade_to(FAILOVER) transitions state to FAILOVER level
   - Evidence:
     - Code: server/services/degrade_ladder.py :: return await self._degrade_to(DegradeLevel.FAILOVER)

3. DegradeAction.apply() calls _action_failover()
   - Evidence:
     - Code: server/services/degrade_ladder.py :: apply=self._action_failover

4. _action_failover() switches self.provider to self.fallback_provider
   - Evidence:
     - Code: server/services/degrade_ladder.py :: self.provider = self.fallback_provider

5. Logs FAILOVER warning with new provider name
   - Evidence:
     - Code: server/services/degrade_ladder.py :: logger.warning(f"FAILOVER: Switching to {self.fallback_provider.name}")

## Inputs and Outputs
- Inputs: Exception object from failed provider
- Outputs: Tuple of (DegradeLevel.FAILOVER, DegradeAction for failover)
- Side effects (writes, network calls, model loads, UI state changes): Provider reference switched, subsequent ASR calls use fallback provider

## Failure Modes
List 5â€“10 realistic failures:
- Failure: No fallback provider configured
  - Where detected: report_provider_error()
  - Current handling (as evidenced): Returns current level, None action
  - User-visible outcome (if any): No provider switch, continues with failed provider
  - Evidence: server/services/degrade_ladder.py :: if self.fallback_provider and self.state.level < DegradeLevel.FAILOVER

- Failure: Already at FAILOVER level
  - Where detected: report_provider_error()
  - Current handling (as evidenced): No action taken
  - User-visible outcome (if any): No further degradation possible
  - Evidence: server/services/degrade_ladder.py :: self.state.level < DegradeLevel.FAILOVER

- Failure: Fallback provider also fails
  - Where detected: Subsequent ASR operations
  - Current handling (as evidenced): Further errors reported, but no additional fallback
  - User-visible outcome (if any): Continued transcription failures
  - Evidence: server/services/degrade_ladder.py :: Only one fallback level supported

- Failure: Provider switch during active transcription
  - Where detected: ASR loop continuation
  - Current handling (as evidenced): Switch happens immediately, may cause brief interruption
  - User-visible outcome (if any): Potential transcription gap during switch
  - Evidence: server/services/degrade_ladder.py :: self.provider = self.fallback_provider (immediate assignment)

## Data and Storage
- What data is produced/consumed: Provider error exceptions, degrade level transitions
- Where it is stored (DB/files/userData/etc.): In-memory DegradeState (level, actions_applied)
- Retention / deletion controls (if documented): State retained during session, reset on session end

## Observability
- Logs/events emitted: Error log on provider failure, warning log on failover switch
- Correlation IDs / session IDs (if any): None evidenced
- Metrics/traces (if any): Degrade level changes tracked in state
Evidence required: server/services/degrade_ladder.py :: logger.error/logger.warning calls

## Open Questions and Follow-up Tasks
- Questions that cannot be answered from current evidence: How does UI indicate provider switch?
- Documentation gaps to fill: Fallback provider configuration and prioritization
- Test gaps to add (note only, no implementation): Multi-level fallback chains, switch timing impact</content>
<parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/MOD-013.md