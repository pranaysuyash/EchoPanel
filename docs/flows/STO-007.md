# STO-007 Session Bundle Export

## Summary

- Origin: Code-only
- Status: Implemented
- Export of session debugging bundle containing logs, metrics, events, transcripts, and optionally audio for support and troubleshooting purposes.
- Boundaries crossed: UI / Storage / Process
- Primary components (coarse list): SessionBundle, SessionBundleManager, AppState, NSSavePanel

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): User clicks "Export Debug Bundle" in onboarding or menu
- Preconditions (permissions, settings flags, availability, model cached, etc.): Active session with sessionID, session bundle exists in SessionBundleManager

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User initiates export via UI button
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/OnboardingView.swift :: appState.exportDebugBundle()
     - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: appState.exportDebugBundle()
   - Notes: Available in onboarding and main menu

1. AppState retrieves session bundle from SessionBundleManager
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: SessionBundleManager.shared.bundle(for: sessionId)
   - Notes: Checks if bundle exists for current session

1. NSSavePanel prompts user for destination
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: NSSavePanel() :: savePanel.allowedContentTypes = [UTType.zip]
   - Notes: Pre-fills filename with session ID prefix

1. SessionBundle generates bundle files asynchronously
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: generateBundle()
   - Notes: Creates receipt.json, events.ndjson, metrics.ndjson, etc.

1. Bundle is zipped using system zip command
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: Process() :: /usr/bin/zip
   - Notes: Recursive zip of bundle directory

1. Zipped bundle copied to user-selected destination
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: FileManager.default.copyItem(at: zipURL, to: destinationURL)
   - Notes: Overwrites if file exists

1. Temporary files cleaned up
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: FileManager.default.removeItem(at: bundleURL)
   - Notes: Removes unzipped bundle and zip temp files

1. Success logged with session ID and destination
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger.shared.info("Debug bundle exported", metadata: [...])
   - Notes: Includes session_id and destination path

## Inputs and Outputs

- Inputs: Session ID, user-selected destination URL
- Outputs: Zipped bundle file at destination, success/failure
- Side effects (writes, network calls, model loads, UI state changes): File system writes, temporary directory usage, system zip process execution

## Failure Modes

List 5â€“10 realistic failures:

- Failure: No session bundle available
  - Where detected: AppState.exportDebugBundle()
  - Current handling (as evidenced): Falls back to legacy export
  - User-visible outcome (if any): Legacy bundle exported instead
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: exportLegacyDebugBundle()

- Failure: User cancels save panel
  - Where detected: NSSavePanel response check
  - Current handling (as evidenced): Returns early and records info notice
  - User-visible outcome (if any): "Debug bundle export cancelled."
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: recordExportCancelled(format:)

- Failure: Bundle generation fails
  - Where detected: SessionBundle.exportBundle()
  - Current handling (as evidenced): Throws error, caught in Task
  - User-visible outcome (if any): Error notice shown + structured error log
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: recordExportFailure(format:error:)

- Failure: Zip process fails
  - Where detected: Process.waitUntilExit()
  - Current handling (as evidenced): Non-zero zip exit converted to explicit export error
  - User-visible outcome (if any): Error notice shown + structured error log
  - Evidence: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: ExportError.zipFailed(exitCode:)

- Failure: File copy fails (permissions, disk full)
  - Where detected: FileManager.copyItem()
  - Current handling (as evidenced): Throws error
  - User-visible outcome (if any): Error notice shown + structured error log
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: recordExportFailure(format:error:)

## Data and Storage

- What data is produced/consumed: Session bundle containing receipt.json, events.ndjson, metrics.ndjson, transcripts, logs, optionally audio
- Where it is stored (DB/files/userData/etc.): Temporary directory during generation, user-selected location for final zip
- Retention / deletion controls (if documented): Temporary files deleted after export, final bundle persists until user deletes

## Observability

- Logs/events emitted: "Debug bundle exported" success, "Debug export failed" error
- Correlation IDs / session IDs (if any): session_id in metadata
- Metrics/traces (if any): None
  Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger.shared.info/error

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Is there progress indication during export? What happens if bundle is very large?
- Documentation gaps to fill: Bundle contents specification, privacy controls
- Test gaps to add (note only, no implementation): Export with audio enabled, export cancellation, disk full scenarios
