# OBS-022 Watchdog Timer Flow (Health Check Timer)

## Summary

- Origin: Code-only
- Status: Implemented
- Periodic health check timer that monitors backend server readiness via HTTP requests, updating UI status until server is fully operational.
- Boundaries crossed: Network, Process
- Primary components (coarse list): BackendManager, Timer

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Server process successfully started
- Preconditions (permissions, settings flags, availability, model cached, etc.): Server subprocess running, health check URL configured

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. startHealthCheck() schedules Timer with 1.0 second interval
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: healthCheckTimer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true)

1. Timer fires, calls checkHealth() which makes HTTP GET to /health endpoint
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: URLSession.shared.dataTask(with: request)

1. Parses JSON response for status, provider, model information
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: JSONSerialization.jsonObject, extracts status/provider/model

1. If status 200 and status=="ok", marks server ready and stops timer
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: if statusCode == 200 && status == "ok" { ... healthCheckTimer?.invalidate() }

1. Updates UI with health detail (ASR provider and model info)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendManager.swift :: self.healthDetail = "ASR: \(provider.isEmpty ? "ready" : provider) \(model.isEmpty ? "" : "(\(model))")"

## Inputs and Outputs

- Inputs: BackendConfig.healthURL, BackendConfig.healthCheckTimeout (2.0s default)
- Outputs: Updated isServerReady, serverStatus, healthDetail published properties
- Side effects (writes, network calls, model loads, UI state changes): HTTP GET requests to localhost health endpoint, UI updates via @Published properties

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Network request times out
  - Where detected: URLSession dataTask completion
  - Current handling (as evidenced): Sets healthDetail to error.localizedDescription
  - User-visible outcome (if any): UI shows error message in health detail
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: if let error { self.healthDetail = error.localizedDescription }

- Failure: HTTP response not 200 or status != "ok"
  - Where detected: checkHealth() response parsing
  - Current handling (as evidenced): Sets isServerReady=false, updates status and detail
  - User-visible outcome (if any): UI shows "Backend not ready" or specific error
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: if statusCode == 503 { ... self.healthDetail = reason }

- Failure: JSON parsing fails
  - Where detected: JSONSerialization.jsonObject
  - Current handling (as evidenced): Uses empty dict fallback, continues with empty status/provider/model
  - User-visible outcome (if any): Health detail shows incomplete information
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: (data.flatMap { try? JSONSerialization.jsonObject }) ?? [:]

- Failure: Server process crashes between checks
  - Where detected: HTTP request fails with connection refused
  - Current handling (as evidenced): Error handling sets healthDetail, timer continues running
  - User-visible outcome (if any): UI shows connection error
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: error handling in dataTask completion

- Failure: Timer scheduling fails
  - Where detected: Timer.scheduledTimer
  - Current handling (as evidenced): No error handling, timer may be nil
  - User-visible outcome (if any): Health checks don't run, server status doesn't update
  - Evidence: macapp/MeetingListenerApp/Sources/BackendManager.swift :: healthCheckTimer = Timer.scheduledTimer (no error checking)

## Data and Storage

- What data is produced/consumed: Health check JSON response with status, provider, model fields
- Where it is stored (DB/files/userData/etc.): In-memory @Published properties (isServerReady, serverStatus, healthDetail)
- Retention / deletion controls (if documented): Data retained in memory until server stops or app exits

## Observability

- Logs/events emitted: NSLog("BackendManager: Server is ready") when server becomes ready
- Correlation IDs / session IDs (if any): None evidenced
- Metrics/traces (if any): None evidenced
  Evidence required: macapp/MeetingListenerApp/Sources/BackendManager.swift :: NSLog("BackendManager: Server is ready")

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: What happens if timer fires after server stops?
- Documentation gaps to fill: Timer cleanup on server stop
- Test gaps to add (note only, no implementation): Timer behavior during server restart, malformed health responses</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/OBS-022.md
