# NET-008 WebSocket Health Monitoring

## Summary

- Origin: Code-only
- Status: Implemented
- Client sends periodic ping frames to monitor WebSocket connection health and detect failures early.
- Boundaries crossed: Network
- Primary components (coarse list): WebSocketStreamer, URLSessionWebSocketTask

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): WebSocket connection established
- Preconditions (permissions, settings flags, availability, model cached, etc.): WebSocket task active

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Connection established, ping timer scheduled
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: connect() calls schedulePing()
     - Docs: docs/audit/STREAMING_ASR_AUDIT_2026-02.md :: WebSocket Ping: 10 seconds (client-side only)
   - Notes: 10-second interval for health checks

1. Timer fires, ping frame sent to server
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: pingTimer fires, calls task?.sendPing()
   - Notes: WebSocket protocol ping/pong for connection validation

1. Server automatically responds with pong frame
   - Evidence:
     - Code: URLSession handles pong automatically (no explicit code)
   - Notes: WebSocket protocol requirement

1. Ping completion callback succeeds
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: sendPing completion handler with no error
   - Notes: Connection healthy, timer continues

1. Process repeats every 10 seconds
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: Timer.scheduledTimer repeats: true
   - Notes: Continuous monitoring during connection lifetime

1. Connection closed, ping timer stopped
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: disconnect() calls stopPing()
   - Notes: Cleanup on intentional disconnect

## Inputs and Outputs

- Inputs:
  - Active WebSocket connection
  - Timer interval (10 seconds)
- Outputs:
  - Ping frames sent
  - Pong frames received (automatic)
- Side effects (writes, network calls, model loads, UI state changes): Network ping/pong frames exchanged

## Failure Modes

List 5–10 realistic failures:

- Failure: Ping times out or fails
  - Where detected: sendPing completion handler receives error
  - Current handling (as evidenced): handleError() called, triggers reconnection
  - User-visible outcome (if any): Status changes to reconnecting
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: sendPing { error in handleError(error) }

- Failure: Network temporarily partitions
  - Where detected: Ping fails during temporary outage
  - Current handling (as evidenced): Single ping failure triggers full reconnection
  - User-visible outcome (if any): Brief interruption then reconnect
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: handleError() always calls reconnect()

- Failure: Server doesn't respond to ping
  - Where detected: WebSocket task reports error on ping
  - Current handling (as evidenced): Treated as connection failure
  - User-visible outcome (if any): Reconnection attempt
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: URLSessionWebSocketTask error handling

- Failure: Ping timer not scheduled
  - Where detected: Connection established but no pings sent
  - Current handling (as evidenced): schedulePing() called in connect()
  - User-visible outcome (if any): Silent failure, no health monitoring
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: connect() → schedulePing()

- Failure: Ping timer fires after disconnect
  - Where detected: Timer callback executes on invalidated timer
  - Current handling (as evidenced): weak self guard prevents execution
  - User-visible outcome (if any): No crash, ping ignored
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: [weak self] in timer closure

## Data and Storage

- What data is produced/consumed: Ping/pong frames, timer state
- Where it is stored (DB/files/userData/etc.): In-memory Timer object in WebSocketStreamer
- Retention / deletion controls (if documented): Timer invalidated on disconnect

## Observability

- Logs/events emitted: None (ping/pong is silent protocol-level)
- Correlation IDs / session IDs (if any): None for ping/pong
- Metrics/traces (if any): None (not tracked as metrics)
  Evidence: Code inspection - no logging in ping/pong handlers

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: What is the ping timeout duration?
- Documentation gaps to fill: Ping failure thresholds and timeout behavior
- Test gaps to add (note only, no implementation): Test ping failure triggers reconnection

