# OBS-008 Session Lifecycle Event Logging

## Summary

- Origin: Code-only
- Status: Implemented
- Logs key session lifecycle events (start, stop, final summary) with correlation IDs for observability and debugging.
- Boundaries crossed: Process (logging)
- Primary components (coarse list): StructuredLogger, AppState, ws_live_listener.py

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Session start/stop actions, WebSocket messages
- Preconditions (permissions, settings flags, availability, model cached, etc.): Logger initialized, session active

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User initiates session start
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: startSession() called
   - Notes: Triggers client-side logging

1. Client logs "Session starting" with metadata
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger.shared.info("Session starting", metadata: ["audio_source": ..., "session_id": ...])
   - Notes: Includes audio source and session ID

1. Server receives start message, initializes session
   - Evidence:
     - Code: server/api/ws_live_listener.py :: msg_type == "start"
   - Notes: Sets up session state

1. Server logs "Session started" with provider/model details
   - Evidence:
     - Code: server/api/ws_live_listener.py :: logger.info(f"Session started: session_id={state.session_id}, attempt_id={state.attempt_id}, ...")
   - Notes: Includes correlation IDs and ASR config

1. User initiates session stop
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: stopSession() called
   - Notes: Or timeout/auto-stop

1. Client logs "Session finalizing" with duration
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger.shared.info("Session finalizing", metadata: ["session_id": ..., "duration_seconds": ...])
   - Notes: Includes session duration

1. Server processes stop message, generates final summary
   - Evidence:
     - Code: server/api/ws_live_listener.py :: msg_type == "stop"
   - Notes: Runs final NLP and diarization

1. Server sends "final_summary" message
   - Evidence:
     - Code: server/api/ws_live_listener.py :: await ws_send(state, websocket, {"type": "final_summary", ...})
   - Notes: Includes markdown and JSON data

1. Client receives final summary
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: case "final_summary": onFinalSummary callback
   - Notes: Completes session lifecycle

## Inputs and Outputs

- Inputs:
  - Session start/stop triggers
  - WebSocket messages (start, stop, final_summary)
- Outputs:
  - Structured log entries with correlation IDs
- Side effects (writes, network calls, model loads, UI state changes): Log file writes, session bundle updates

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Logger not initialized
  - Where detected: StructuredLogger.shared call
  - Current handling (as evidenced): Silent failure (no crash)
  - User-visible outcome (if any): Missing logs
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: @MainActor class

- Failure: Session start fails before logging
  - Where detected: startSession() throws
  - Current handling (as evidenced): Exception propagates, no start log
  - User-visible outcome (if any): Error shown, no session log
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: startSession() try/catch

- Failure: WebSocket disconnect before final summary
  - Where detected: stopAndAwaitFinalSummary timeout
  - Current handling (as evidenced): Logs timeout, marks incomplete
  - User-visible outcome (if any): Warning about incomplete finalization
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: finalizationOutcome = .incompleteTimeout

- Failure: Server crash before session started log
  - Where detected: WebSocket disconnect
  - Current handling (as evidenced): Client reconnects, no server log
  - User-visible outcome (if any): Reconnection status
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: handleError() calls reconnect()

- Failure: Log file write fails
  - Where detected: OS log write error
  - Current handling (as evidenced): Logs to console fallback
  - User-visible outcome (if any): Console logs only
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: enableConsoleOutput

## Data and Storage

- What data is produced/consumed: Log entries with session metadata, correlation IDs, timestamps
- Where it is stored (DB/files/userData/etc.): Log files in app data directory, console output
- Retention / deletion controls (if documented): Rotated log files, max 5 files of 10MB each

## Observability

- Logs/events emitted: Session lifecycle events (start, finalizing, started)
- Correlation IDs / session IDs (if any): Included in all log entries
- Metrics/traces (if any): None
- Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: CorrelationContext

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: None
- Documentation gaps to fill: None
- Test gaps to add (note only, no implementation): Verify log entries contain correct correlation IDs
