# AUD-004 Client-to-Server WebSocket Transmission

## Summary

- Origin: Mixed
- Status: Implemented
- Establishes WebSocket connection to backend server, sends audio frames as Base64-encoded PCM16, handles session start/stop messages, and receives ASR results and metrics with bounded send queueing for backpressure.
- Boundaries crossed: Network (localhost WebSocket) / Process (client to server)
- Primary components: WebSocketStreamer, URLSessionWebSocketTask, OperationQueue

## Triggers and Preconditions

- Triggers: Session start in AppState calls streamer.connect()
- Preconditions: Backend server running, valid WebSocket URL configured

## Sequence (Happy Path)

1. Connect called with session and attempt IDs
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: func connect(sessionID: String, attemptID: String? = nil)
     - Docs: docs/audit/security-privacy-boundaries-20260211.md :: Local WebSocket Transmission

2. Create URLSessionWebSocketTask with backend URL
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: task = session.webSocketTask(with: url)
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: private var url: URL { BackendConfig.webSocketURL }

3. Resume task and start receive loop
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: task?.resume(); receiveLoop()

4. Send start message with session metadata
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: private func sendStart()
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: sendJSON(payload) with type: "start"

5. Audio frames received via sendPCMFrame, Base64 encoded
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: func sendPCMFrame(\_ data: Data, source: String = "system")
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: "data": data.base64EncodedString()

6. Frames queued in OperationQueue for ordered sending
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: sendQueue.addOperation
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: private let sendQueue = OperationQueue()

7. Send via WebSocket with semaphore for sync completion
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: task?.send(.string(text)) { error in ... }
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: semaphore.wait(timeout: .now() + 5)

8. Receive ASR partial/final results, metrics, cards, entities
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: private func handle(\_ message: URLSessionWebSocketTask.Message)
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: onASRPartial?, onMetrics?, etc.

9. Send stop message on disconnect
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: private func sendStop()
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: "type": "stop"

## Inputs and Outputs

- Inputs: PCM16 audio frames (Data), session metadata, source tags
- Outputs: ASR transcripts, entities, cards, metrics, final summary
- Side effects: WebSocket connection active, send queue processing, ping timer running

## Failure Modes

- WebSocket connection fails:
  - Where detected: task?.resume() or send failures
  - Current handling: Automatic reconnection with backoff
  - User-visible outcome: Stream status shows reconnecting
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: handleError, reconnect logic

- Send queue overflow:
  - Where detected: sendQueue.operationCount >= maxQueuedSends
  - Current handling: Drop frame, log warning
  - User-visible outcome: Brief audio gap, warning logged
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: guard sendQueue.operationCount < maxQueuedSends

- Send timeout:
  - Where detected: semaphore.wait times out after 5s
  - Current handling: Log warning, continue
  - User-visible outcome: Delayed audio, warning logged
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: if result == .timedOut

- Backend server not responding:
  - Where detected: WebSocket connection fails to establish
  - Current handling: Reconnection attempts
  - User-visible outcome: Stream status error
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: connect method

- Message parsing errors:
  - Where detected: JSON deserialization fails in handle()
  - Current handling: Log error, skip message
  - User-visible outcome: Missing ASR results
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: guard let json = try? JSONSerialization.jsonObject

- Ping/pong failures:
  - Where detected: Ping timer and pong responses
  - Current handling: Connection considered unhealthy
  - User-visible outcome: Reconnection triggered
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: schedulePing, handle pong

- Session ID missing:
  - Where detected: sendStart/sendStop called without sessionID
  - Current handling: Early return, no message sent
  - User-visible outcome: Backend doesn't know session started/stopped
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: guard let sessionID

## Data and Storage

- Send queue: Bounded OperationQueue (max 100 operations)
- No persistent storage
- In-memory message buffers during reconnection

## Observability

- Debug logging for connect/disconnect/send operations
- Structured logging for WebSocket events with correlation IDs
- Metrics reporting via onMetrics callback
- Stream status updates via onStatus callback

## Open Questions and Follow-up Tasks

- Encryption: Uses ws:// (not wss://) for localhost - is this acceptable?
- Queue overflow handling: Dropping frames may cause gaps
- Reconnection logic: Exponential backoff implementation details
- Test gaps: Network interruption scenarios, queue overflow testing</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/AUD-004.md
