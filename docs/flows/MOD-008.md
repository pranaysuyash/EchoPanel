# MOD-008 Comprehensive Health Metrics

## Summary

- Origin: Mixed
- Status: Implemented
- Collection and reporting of comprehensive health metrics for ASR providers and models, including realtime factor, inference times, model state, and session statistics for monitoring and diagnostics.
- Boundaries crossed: Model / Pipeline / Network
- Primary components (coarse list): ASR providers, model preloader, health endpoints, ASRHealth/ModelHealth dataclasses

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Health endpoint requests (/health, /model-status), inference completions, periodic checks
- Preconditions (permissions, settings flags, availability, model cached, etc.): Provider instance exists, model loaded for some metrics

## Sequence (Happy Path)

1. Health endpoint request returns service status, provider info, and model readiness
   - Evidence:
     - Code: server/main.py:101-156
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1492-1520
2. Model health check returns ModelHealth with state, load times, and error info
   - Evidence:
     - Code: server/services/model_preloader.py:311-321
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1522-1532
3. Provider health metrics calculated from inference times, RTF, and session data
   - Evidence:
     - Code: server/services/provider_faster_whisper.py:279-303
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1534-1558
4. Base provider health returns cached health state with session duration
   - Evidence:
     - Code: server/services/asr_providers.py:257-269
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1560-1570
5. Whisper.cpp health returns availability, model loaded status, and performance stats
   - Evidence:
     - Code: server/services/provider_whisper_cpp.py:365-372
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1572-1579
6. Voxtral health returns session status, RTF, and processing metrics
   - Evidence:
     - Code: server/services/provider_voxtral_realtime.py:431-448
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1581-1598
7. Model status endpoint exposes full health and statistics
   - Evidence:
     - Code: server/main.py:177-198
     - Docs: docs/audit/asr-model-lifecycle-20260211.md:1600-1615

## Inputs and Outputs

- Inputs: None (health queries)
- Outputs: Health status dicts with metrics (status, provider, model_ready, realtime_factor, avg_infer_ms, p95/p99, model_resident, errors, session stats)
- Side effects (writes, network calls, model loads, UI state changes): None (read-only health checks)

## Failure Modes

- Failure: Provider not available
  - Where detected: is_available check
  - Current handling (as evidenced): Health returns 503 with reason
  - User-visible outcome (if any): Service unavailable status
  - Evidence: main.py:122-139
- Failure: Model not loaded
  - Where detected: model_resident check
  - Current handling (as evidenced): Health returns 503
  - User-visible outcome (if any): Loading status
  - Evidence: main.py:135-139
- Failure: No inference data
  - Where detected: \_infer_times empty
  - Current handling (as evidenced): RTF = 0.0, metrics = 0
  - User-visible outcome (if any): Zero metrics
  - Evidence: provider_faster_whisper.py:284-287
- Failure: Provider crash
  - Where detected: Process exit code
  - Current handling (as evidenced): Health returns "error" status
  - User-visible outcome (if any): Error status in metrics
  - Evidence: provider_voxtral_realtime.py:443
- Failure: Exception in health method
  - Where detected: Unhandled exception
  - Current handling (as evidenced): Health returns 500
  - User-visible outcome (if any): Internal server error
  - Evidence: main.py:155-156
- Failure: Stale session data
  - Where detected: Session ended but not cleaned
  - Current handling (as evidenced): Session duration continues growing
  - User-visible outcome (if any): Inflated duration metrics
  - Evidence: asr_providers.py:267-269
- Failure: Memory leak
  - Where detected: OOM (not directly monitored)
  - Current handling (as evidenced): System may kill process
  - User-visible outcome (if any): Service crash
  - Evidence: Hypothesized
- Failure: Concurrent health checks
  - Where detected: Multiple simultaneous requests
  - Current handling (as evidenced): No locking, potential race
  - User-visible outcome (if any): Inconsistent metrics
  - Evidence: main.py:101-156 (theoretical)

## Data and Storage

- What data is produced/consumed: Inference times, RTF calculations, session stats, model state
- Where it is stored (DB/files/userData/etc.): In-memory health objects, cached metrics
- Retention / deletion controls (if documented): Session lifetime, rolling averages

## Observability

- Logs/events emitted: Debug messages on health checks
- Correlation IDs / session IDs (if any): None specific
- Metrics/traces (if any): Health endpoints expose all metrics
- Evidence: main.py logger, ASRHealth/ModelHealth dataclasses

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: Are health metrics exposed to WebSocket clients?
- Documentation gaps: Health metric update frequency, retention policies
- Test gaps to add (note only, no implementation): Test health under load, concurrent requests, metric accuracy

