# EXT-008 Export Debug Bundle

## Summary

- Origin: Code-only
- Status: Implemented
- Exports comprehensive session debug bundle as ZIP file containing receipt.json, events.ndjson, metrics.ndjson, transcript.json, audio manifest, logs, and drops summary. Uses SessionBundle system for structured observability data.
- Boundaries crossed: UI (save panel) / Storage (file generation + ZIP creation)
- Primary components (coarse list): AppState, SessionBundle, SessionBundleManager

## Triggers and Preconditions

- Triggers: User clicks "Export Debug Bundle" button in UI
- Preconditions: Active session with sessionID, session bundle exists

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User clicks Export Debug Bundle button
   - Evidence:
     - Code: AppState.swift :: exportDebugBundle() :: Task { do {
     - Docs: flow-atlas-20260211.md :: EXT-008 Export Debug Bundle

1. App retrieves session bundle from SessionBundleManager
   - Evidence:
     - Code: AppState.swift :: exportDebugBundle() :: let bundle = SessionBundleManager.shared.bundle(for: sessionId)
     - Code: SessionBundleManager.swift :: func bundle(for sessionId: String) -> SessionBundle?

1. App displays macOS save panel with ZIP type and session-prefixed name
   - Evidence:
     - Code: AppState.swift :: exportDebugBundle() :: let savePanel = NSSavePanel(); savePanel.allowedContentTypes = [UTType.zip]
     - Code: AppState.swift :: exportDebugBundle() :: savePanel.nameFieldStringValue = "echopanel-session-\(sessionId.prefix(8)).zip"

1. User selects save location and confirms
   - Evidence:
     - Code: AppState.swift :: exportDebugBundle() :: let response = await savePanel.beginSheetModal(...); guard response == .OK

1. SessionBundle generates bundle files (receipt, events, metrics, transcript, etc.)
   - Evidence:
     - Code: SessionBundle.swift :: exportBundle() :: let bundleURL = try await generateBundle()
     - Code: SessionBundle.swift :: generateBundle() :: try await generateReceipt(...); generateEvents(...); etc.

1. App creates ZIP archive from bundle directory using system zip command
   - Evidence:
     - Code: SessionBundle.swift :: exportBundle() :: process.executableURL = URL(fileURLWithPath: "/usr/bin/zip")
     - Code: SessionBundle.swift :: exportBundle() :: process.arguments = ["-r", "-q", zipURL.path, bundleURL.lastPathComponent]

1. App copies ZIP to user-selected destination and cleans up temp files
   - Evidence:
     - Code: SessionBundle.swift :: exportBundle() :: try fm.copyItem(at: zipURL, to: destinationURL)
     - Code: SessionBundle.swift :: exportBundle() :: try? fm.removeItem(at: bundleURL); try? fm.removeItem(at: zipURL)

1. App logs successful export with structured logging
   - Evidence:
     - Code: AppState.swift :: exportDebugBundle() :: StructuredLogger.shared.info("Debug bundle exported", metadata: [...])

## Inputs and Outputs

- Inputs: User save location selection
- Outputs: ZIP file containing debug bundle with multiple JSON/NDJSON files
- Side effects (writes, network calls, model loads, UI state changes): Multiple temp files created and cleaned up, ZIP written to filesystem, save panel displayed

## Failure Modes

List 5â€“10 realistic failures:

- Failure: No session bundle available
  - Where detected: SessionBundleManager.bundle returns nil
  - Current handling (as evidenced): Falls back to legacy export
  - User-visible outcome (if any): Legacy bundle created instead
  - Evidence: AppState.swift :: } else { try await exportLegacyDebugBundle() }

- Failure: User cancels save panel
  - Where detected: savePanel.beginSheetModal response != .OK
  - Current handling (as evidenced): Cancellation is recorded via `recordExportCancelled(format:)`
  - User-visible outcome (if any): In-app notice shown ("Debug bundle export cancelled")
  - Evidence: AppState.swift :: exportDebugBundle(), exportLegacyDebugBundle(), recordExportCancelled(format:)

- Failure: Bundle generation fails (file I/O, JSON serialization)
  - Where detected: generateBundle() throws
  - Current handling (as evidenced): Exception caught, logged as error, and routed to `recordExportFailure(format:error:)`
  - User-visible outcome (if any): In-app error notice shown with failure reason
  - Evidence: AppState.swift :: exportDebugBundle(), recordExportFailure(format:error:)

- Failure: ZIP creation fails
  - Where detected: zip process fails or copy fails
  - Current handling (as evidenced): Exception propagates to AppState catch or legacy copy handler and is recorded through `recordExportFailure(format:error:)`
  - User-visible outcome (if any): In-app error notice shown with failure reason
  - Evidence: SessionBundle.swift :: exportBundle(); AppState.swift :: exportDebugBundle(), exportLegacyDebugBundle()

## Data and Storage

- What data is produced/consumed: Session events, metrics, transcript, audio manifest, logs, drops summary, receipt metadata
- Where it is stored (DB/files/userData/etc.): User-selected ZIP file containing structured debug data
- Retention / deletion controls (if documented): User-managed file, temp files auto-cleaned

## Observability

- Logs/events emitted: "Debug bundle exported" success log, "Debug export failed" error log, plus user-facing notice updates (success/cancel/failure)
- Correlation IDs / session IDs (if any): session_id in metadata and bundle contents
- Metrics/traces (if any): None
  Evidence: AppState.swift :: StructuredLogger.shared.info("Debug bundle exported", metadata: ["session_id": sessionId])

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: What is included in legacy fallback bundle?
- Documentation gaps to fill: Debug bundle file format specification
- Test gaps to add (note only, no implementation): Test bundle generation with missing data, test ZIP creation failures</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-008.md
