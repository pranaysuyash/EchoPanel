# EXT-006 Export JSON

## Summary

- Origin: Code-only
- Status: Implemented
- Exports current session data (transcript, entities, actions, decisions, risks) as formatted JSON file using macOS save panel. Includes session metadata and final summary if available.
- Boundaries crossed: UI (save panel) / Storage (file write)
- Primary components (coarse list): AppState, NSSavePanel

## Triggers and Preconditions

- Triggers: User clicks "Export JSON" button in UI
- Preconditions: Session data available (transcript segments, etc.)

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User clicks Export JSON button in side panel or summary view
   - Evidence:
     - Code: SidePanelTranscriptSurfaces.swift :: Button("Export JSON") { appState.exportJSON() }
     - Docs: flow-atlas-20260211.md :: EXT-006 Export JSON

1. App displays macOS save panel with JSON file type and default name
   - Evidence:
     - Code: AppState.swift :: exportJSON() :: let panel = NSSavePanel(); panel.allowedContentTypes = [UTType.json]
     - Code: AppState.swift :: exportJSON() :: panel.nameFieldStringValue = "echopanel-session.json"

1. User selects save location and confirms
   - Evidence:
     - Code: AppState.swift :: exportJSON() :: panel.begin { response in guard response == .OK, let url = panel.url

1. App generates export payload with session data
   - Evidence:
     - Code: AppState.swift :: exportJSON() :: let payload = self.exportPayload()
     - Code: AppState.swift :: exportPayload() :: return ["session": [...], "transcript": [...], ...]

1. App serializes payload to pretty-printed JSON and writes to file
   - Evidence:
     - Code: AppState.swift :: exportJSON() :: let data = try JSONSerialization.data(withJSONObject: payload, options: [.prettyPrinted, .sortedKeys])
     - Code: AppState.swift :: exportJSON() :: try data.write(to: url)

## Inputs and Outputs

- Inputs: User save location selection
- Outputs: JSON file written to user-selected path
- Side effects (writes, network calls, model loads, UI state changes): File written to filesystem, save panel displayed

## Failure Modes

List 5â€“10 realistic failures:

- Failure: User cancels save panel
  - Where detected: panel.begin response != .OK
  - Current handling (as evidenced): Cancellation is recorded via `recordExportCancelled(format:)`
  - User-visible outcome (if any): In-app notice shown ("JSON export cancelled")
  - Evidence: AppState.swift :: exportJSON(), recordExportCancelled(format:)

- Failure: JSON serialization fails
  - Where detected: JSONSerialization.data throws
  - Current handling (as evidenced): Exception caught, logged, and routed to `recordExportFailure(format:error:)`
  - User-visible outcome (if any): In-app error notice shown with failure reason
  - Evidence: AppState.swift :: exportJSON(), recordExportFailure(format:error:)

- Failure: File write fails (permissions, disk full, etc.)
  - Where detected: data.write(to: url) throws
  - Current handling (as evidenced): Exception caught, logged, and routed to `recordExportFailure(format:error:)`
  - User-visible outcome (if any): In-app error notice shown with failure reason
  - Evidence: AppState.swift :: exportJSON(), recordExportFailure(format:error:)

## Data and Storage

- What data is produced/consumed: Session metadata, transcript segments, entities, actions/decisions/risks, final summary
- Where it is stored (DB/files/userData/etc.): User-selected file path as JSON
- Retention / deletion controls (if documented): User-managed file

## Observability

- Logs/events emitted: Structured error log on failure, plus user-facing notice updates (success/cancel/failure)
- Correlation IDs / session IDs (if any): session_id included in exported data
- Metrics/traces (if any): None
  Evidence: AppState.swift :: recordExportSuccess/recordExportCancelled/recordExportFailure

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: What data is included if export during active session vs after finalization?
- Documentation gaps to fill: JSON schema documentation
- Test gaps to add (note only, no implementation): Test export with various session states, test file write failures

