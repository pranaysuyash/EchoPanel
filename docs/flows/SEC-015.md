# SEC-015 Local Documents Privacy

## Summary
- Origin: Mixed
- Status: Implemented
- Ensures user-selected local documents for RAG context remain private: files selected locally, content processed locally, stored in user's home directory, protected by authentication, never transmitted externally.
- Boundaries crossed: UI / Filesystem / Process (localhost HTTP)
- Primary components (coarse list): NSOpenPanel (Swift), AppState.indexContextDocumentAsync (Swift), documents.py API (Python), LocalRAGStore (Python)

## Triggers and Preconditions
- Triggers: User clicks "Upload Document..." in context panel
- Preconditions: Backend server running, user has configured auth token (optional), user has local text files to index

## Sequence (Happy Path)
1. User initiates document upload via NSOpenPanel file picker
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SidePanel/Full/SidePanelFullViews.swift :: pickContextFileForIndexing() :: NSOpenPanel with allowedContentTypes [.plainText, .json, .commaSeparatedText]
     - Docs: docs/flow-atlas-20260211.md :: SEC-015 Local Documents Privacy

2. User selects local file (text/markdown/json/csv) via macOS file picker
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SidePanel/Full/SidePanelFullViews.swift :: panel.allowedContentTypes = [.plainText, .utf8PlainText, .text, .commaSeparatedText, .json, .sourceCode]
     - Docs: docs/DECISIONS.md :: Privacy story: "Audio never leaves your Mac. Transcript text can optionally be sent to your own LLM provider for enhanced analysis."

3. App reads file content locally using loadTextFile()
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: indexContextDocumentAsync() :: let text = try loadTextFile(fileURL)
     - Docs: docs/audit/security-privacy-boundaries-20260211.md :: SP-011 Config Storage (App â†’ UserDefaults)

4. Content sent to local server via authenticated HTTP POST to /documents/index
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: makeAuthorizedRequest(url: BackendConfig.documentsIndexURL, method: "POST", body: body)
     - Docs: docs/WS_CONTRACT.md :: Local documents API (RAG MVP)

5. Server validates authentication token before processing
   - Evidence:
     - Code: server/api/documents.py :: _require_http_auth(request) :: checks token via hmac.compare_digest
     - Docs: docs/flow-atlas-20260211.md :: SEC-006 Documents API Authentication

6. Document indexed and stored locally in ~/.echopanel/rag_store.json
   - Evidence:
     - Code: server/services/rag_store.py :: _default_store_path() :: Path.home() / ".echopanel" / "rag_store.json"
     - Docs: docs/audit/security-privacy-boundaries-20260211.md :: SP-011 Config Storage

7. Document appears in UI context library for local querying
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: await fetchContextDocuments(force: true)
     - Docs: docs/flow-atlas-20260211.md :: EXT-015 Context Document Indexing (RAG)

## Inputs and Outputs
- Inputs: User-selected local file path, file content (text), auth token
- Outputs: Indexed document metadata, updated context document list in UI
- Side effects (writes, network calls, model loads, UI state changes): Document chunks stored in local JSON file, UI updates with new document

## Failure Modes
- Failure: File read fails (permissions, encoding, size >250k chars)
  - Where detected: loadTextFile() throws error
  - Current handling (as evidenced): UI shows error message "Indexing failed: <error>"
  - User-visible outcome (if any): Status message in context panel
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: contextStatusMessage = "Indexing failed: \(error.localizedDescription)"

- Failure: HTTP request fails (network, auth, server down)
  - Where detected: URLSession.shared.data(for: request) throws
  - Current handling (as evidenced): Error caught and displayed
  - User-visible outcome (if any): Status message shows failure
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: catch { contextStatusMessage = "Indexing failed: \(error.localizedDescription)" }

- Failure: Server auth validation fails
  - Where detected: _require_http_auth() raises HTTPException(401)
  - Current handling (as evidenced): 401 response returned
  - User-visible outcome (if any): HTTP error in client
  - Evidence: server/api/documents.py :: raise HTTPException(status_code=401, detail="Unauthorized")

- Failure: Document indexing fails (empty text, validation error)
  - Where detected: store.index_document() raises ValueError
  - Current handling (as evidenced): 400 response with error message
  - User-visible outcome (if any): Client shows indexing failed
  - Evidence: server/api/documents.py :: raise HTTPException(status_code=400, detail=str(exc))

- Failure: File too large (>250k chars)
  - Where detected: text.count > 250_000 check
  - Current handling (as evidenced): Early return with status message
  - User-visible outcome (if any): UI shows "File too large" message
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: if text.count > 250_000 { contextStatusMessage = "File too large..." }

## Data and Storage
- What data is produced/consumed: Document text content, metadata (title, source path, chunks)
- Where it is stored (DB/files/userData/etc.): Local JSON file at ~/.echopanel/rag_store.json
- Retention / deletion controls (if documented): Documents persist until explicitly deleted via API, no automatic cleanup

## Observability
- Logs/events emitted: Status messages in UI, no server-side logging found
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
Evidence: No logging in document indexing code paths

## Open Questions and Follow-up Tasks
- Questions that cannot be answered from current evidence: Are there any size limits on total stored documents? Is there compression or encryption of stored documents?
- Documentation gaps to fill: User guide for document privacy guarantees, file format support details
- Test gaps to add (note only, no implementation): Privacy verification (documents don't leave localhost), file permission edge cases, large document handling</content>
<parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/SEC-015.md