# SEC-011 Session Bundle Privacy Controls

## Summary
- Origin: Code-only
- Status: Implemented
- 1â€“2 sentence description: Applies privacy controls during session bundle creation and export, excluding sensitive data like audio by default and hashing identifiers.
- Boundaries crossed: Process (bundle creation), Storage (file export), UI (export dialog)
- Primary components (coarse list): SessionBundle.swift, AppState.swift

## Triggers and Preconditions
- Triggers: User initiates debug bundle export from Settings
- Preconditions: Active session with session bundle created, export dialog approved

## Sequence (Happy Path)
1. User clicks "Export Debug Bundle" in Settings
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/MeetingListenerApp.swift :: exportDebugBundle() (line 565)
2. Retrieve session bundle with privacy-safe configuration
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: configuration: .privacySafe (line 568)
3. Apply privacy controls: exclude audio, hash machine ID, include metadata flags
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: Configuration struct (lines 35-44)
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: getHashedMachineId() (line 512)
4. Generate bundle files respecting include flags (transcript, metrics, logs included; audio excluded)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: generateAudioManifest() (line 407)
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: guard configuration.includeLogs else { return } (line 416)
5. Create zip archive and save to user-selected location
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: exportBundle() (lines 244-267)
6. Record export success in session history
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: recordExportSuccess() (line 922)

## Inputs and Outputs
- Inputs: Session bundle data (events, metrics, transcripts), user-selected export path
- Outputs: Privacy-controlled zip file with manifest indicating excluded content
- Side effects (writes, network calls, model loads, UI state changes): File write to user filesystem, export success/failure recorded

## Failure Modes
- Failure: Bundle generation fails (file I/O error)
  - Where detected: exportBundle() throws
  - Current handling: Catch and log error, show user failure message
  - User-visible outcome: Alert dialog with error message
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: catch block (lines 924-930)
- Failure: Zip creation fails
  - Where detected: Process termination status check
  - Current handling: Throw ExportError.zipFailed
  - User-visible outcome: Export fails with specific error message
  - Evidence: macapp/MeetingListenerApp/Sources/SessionBundle.swift :: ExportError enum (lines 22-28)
- Failure: User cancels save dialog
  - Where detected: NSSavePanel response check
  - Current handling: Return early, record cancellation
  - User-visible outcome: No export, no error
  - Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: response == .OK check (line 914)

## Data and Storage
- What data is produced/consumed: Sanitized session artifacts (no audio, hashed IDs)
- Where it is stored (DB/files/userData/etc.): Exported to user-selected filesystem location as zip
- Retention / deletion controls: User-managed, no automatic cleanup

## Observability
- Logs/events emitted: Export success/failure, bundle metadata
- Correlation IDs / session IDs: Session ID in bundle and logs
- Metrics/traces: Export events recorded in session history
- Evidence: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger calls (lines 923, 927)

## Open Questions and Follow-up Tasks
- Questions: How to implement user opt-in for audio inclusion? What other PII needs hashing?
- Documentation gaps: User guide for debug bundle privacy settings
- Test gaps: Privacy control validation, PII leakage testing