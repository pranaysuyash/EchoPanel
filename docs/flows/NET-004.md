# NET-004 ASR Results Reception

## Summary

- Origin: Code-only
- Status: Implemented
- WebSocket ASR/status/events are parsed and propagated to app state + side panel rendering.
- Boundaries crossed: Network -> UI state
- Primary components (coarse list): WebSocketStreamer, AppState, SidePanelView

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): backend emits websocket events (`status`, `asr_partial`, `asr_final`, etc.)
- Preconditions (permissions, settings flags, availability, model cached, etc.): active websocket receive loop

## Sequence (Happy Path)

1. Receive loop gets message and dispatches handler.
   - Evidence:
     - Code: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `receiveLoop()` -> `handle(_:)`
2. JSON envelope is parsed and switched by `type`.
   - Evidence:
     - Code: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `handleJSON(_:)`
3. `asr_partial` and `asr_final` invoke app callbacks on main queue.
   - Evidence:
     - Code: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `onASRPartial?`, `onASRFinal?`
4. App state updates transcript, deduplicates/filters, and bumps revision.
   - Evidence:
     - Code: `macapp/MeetingListenerApp/Sources/AppState.swift` :: `handlePartial(...)`, `handleFinal(...)`, `bumpTranscriptRevision()`
5. Side panel reacts to transcript count/revision changes, updates focus/scroll behavior.
   - Evidence:
     - Code: `macapp/MeetingListenerApp/Sources/SidePanelView.swift` :: `.onChange(of: appState.transcriptSegments.count)` and `.onChange(of: appState.transcriptRevision)`

## Inputs and Outputs

- Inputs: websocket ASR/status/event JSON
- Outputs: updated transcript segments + derived UI surfaces
- Side effects (writes, network calls, model loads, UI state changes): transcript list mutation, focus/follow-live updates, summary notification path on `final_summary`

## Failure Modes

- Failure: Malformed/non-JSON message
  - Where detected: JSON parse guard
  - Current handling (as evidenced): message ignored
  - User-visible outcome (if any): missed update
  - Evidence: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `guard let object = try? ... else { return }`

- Failure: Missing fields in ASR payload
  - Where detected: typed field extraction
  - Current handling (as evidenced): defaults (`""`, `0`, fallback confidence) used
  - User-visible outcome (if any): degraded segment fidelity
  - Evidence: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `as? ... ?? ...` patterns

- Failure: Duplicate/low-quality finals
  - Where detected: `handleFinal`
  - Current handling (as evidenced): skips duplicates and very low-confidence short finals
  - User-visible outcome (if any): reduced transcript noise
  - Evidence: `macapp/MeetingListenerApp/Sources/AppState.swift` :: duplicate + hallucination guards in `handleFinal`

- Failure: Receive error
  - Where detected: receive loop failure branch
  - Current handling (as evidenced): reconnect path via `handleError`
  - User-visible outcome (if any): reconnecting status
  - Evidence: `macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift` :: `case .failure(let error): self.handleError(error)`

## Data and Storage

- What data is produced/consumed: transcript segments, source timestamps, summary payload
- Where it is stored (DB/files/userData/etc.): in-memory `AppState` collections; appended to session store for finals
- Retention / deletion controls (if documented): cleared/reset on session reset/end

## Observability

- Logs/events emitted: stream status changes; structured warnings/errors on network failures
- Correlation IDs / session IDs (if any): carried in websocket context + session state
- Metrics/traces (if any): per-source last-seen timestamps and ASR event counts in app state

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: none
- Documentation gaps to fill: none
- Test gaps to add (note only, no implementation): malformed message and partial/final edge-case regression tests
