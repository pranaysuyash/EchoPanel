# SEC-001 Screen Recording Permission Flow

## Summary

- Origin: Code-only
- Status: Implemented
- App requests macOS Screen Recording permission required for system audio capture, handling TCC (Transparency, Consent, Control) framework integration.
- Boundaries crossed: OS (macOS TCC permissions)
- Primary components (coarse list): AudioCaptureManager, CGRequestScreenCaptureAccess

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Session start requiring system audio
- Preconditions (permissions, settings flags, availability, model cached, etc.): macOS 13+, permission not already granted

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Check current permission status
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AudioCaptureManager.swift :: CGPreflightScreenCaptureAccess()
   - Notes: Preflight check before requesting

1. If not granted, request permission via macOS dialog
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AudioCaptureManager.swift :: CGRequestScreenCaptureAccess()
   - Notes: Shows system permission dialog

1. User grants permission in system dialog
   - Evidence:
     - Code: macOS TCC framework (no code)
   - Notes: User interaction required

1. Verify permission was effectively granted
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: CGPreflightScreenCaptureAccess() post-request
   - Notes: Double-check after grant

1. Update app state with permission status
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: screenRecordingPermission = .authorized
   - Notes: Enables system audio capture

1. Handle restart requirement for permission activation
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/AppState.swift :: screenRecordingRequiresRelaunch message
   - Notes: macOS requires app restart after grant

## Inputs and Outputs

- Inputs:
  - User intent to capture system audio
  - Current TCC permission state
- Outputs:
  - Updated permission state in app
  - System permission grant (persistent)
- Side effects (writes, network calls, model loads, UI state changes): TCC database updated, permission persisted across launches

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Permission request fails
  - Where detected: CGRequestScreenCaptureAccess returns false
  - Current handling (as evidenced): Set permission to .denied
  - User-visible outcome (if any): Error message shown
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: screenRecordingPermission = .denied

- Failure: User denies permission
  - Where detected: Post-request check fails
  - Current handling (as evidenced): Block system audio capture
  - User-visible outcome (if any): "Screen Recording permission required" error
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: setSessionError(.screenRecordingPermissionRequired)

- Failure: Permission granted but requires restart
  - Where detected: Preflight true but effective false
  - Current handling (as evidenced): Show restart message
  - User-visible outcome (if any): "Permission granted, but requires relaunch" warning
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: screenRecordingRequiresRelaunch

- Failure: macOS version too old
  - Where detected: ScreenCaptureKit unavailable
  - Current handling (as evidenced): Fallback to microphone only
  - User-visible outcome (if any): System audio disabled
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AudioCaptureManager.swift :: #available(macOS 13.0)

- Failure: TCC database corrupted
  - Where detected: CGPreflightScreenCaptureAccess inconsistent
  - Current handling (as evidenced): Retry request
  - User-visible outcome (if any): Permission dialog shown again
  - Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: preflightGranted vs effective

## Data and Storage

- What data is produced/consumed: Permission grant state
- Where it is stored (DB/files/userData/etc.): macOS TCC database (/Library/Application Support/com.apple.TCC)
- Retention / deletion controls (if documented): Persistent until user revokes in System Settings

## Observability

- Logs/events emitted: Permission state changes logged
- Correlation IDs / session IDs (if any): None
- Metrics/traces (if any): None
- Evidence: Code: macapp/MeetingListenerApp/Sources/AppState.swift :: StructuredLogger in startSession

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: None
- Documentation gaps to fill: None
- Test gaps to add (note only, no implementation): Test permission flow on clean macOS install
