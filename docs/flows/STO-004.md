# STO-004 Crash Recovery Marker

## Summary

- Origin: Code-only
- Status: Implemented
- Creation and management of recovery.json marker file to track unfinished sessions for crash recovery prompts on app restart.
- Boundaries crossed: Storage / UI
- Primary components (coarse list): recovery.json, markSessionRecoverable(), clearRecoveryMarker(), checkForRecoverableSession()

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Session start, session end (normal), app launch
- Preconditions (permissions, settings flags, availability, model cached, etc.): Sessions directory exists, session ID available

## Sequence (Happy Path)

1. Mark session recoverable on session start by writing recovery.json
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:154-167
     - Docs: docs/STORAGE_AND_EXPORTS.md:15-16
2. Check for recoverable session on app init
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:167-185
     - Docs: docs/STORAGE_AND_EXPORTS.md:15-16
3. Set recoverable session properties if marker found
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:175-183
     - Docs: docs/STORAGE_AND_EXPORTS.md:15-16
4. Clear recovery marker on normal session end
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:101-102
     - Docs: docs/STORAGE_AND_EXPORTS.md:15-16
5. Load recoverable session data from snapshot on user choice
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/SessionStore.swift:187-201
     - Docs: Assumed from recovery flow

## Inputs and Outputs

- Inputs: Session ID, timestamp
- Outputs: recovery.json file with session_id and timestamp
- Side effects (writes, network calls, model loads, UI state changes): Recovery prompt UI, file writes/deletes

## Failure Modes

- Failure: Recovery marker write fails
  - Where detected: JSON write
  - Current handling (as evidenced): Log error
  - User-visible outcome (if any): No crash recovery available
  - Evidence: SessionStore.swift:160-167
- Failure: Recovery marker read fails on launch
  - Where detected: File read/parse
  - Current handling (as evidenced): Log error, no recovery prompt
  - User-visible outcome (if any): Lost recoverable session
  - Evidence: SessionStore.swift:170-185
- Failure: Recovery marker clear fails
  - Where detected: removeItem()
  - Current handling (as evidenced): Try? ignores error
  - User-visible outcome (if any): Marker persists (harmless)
  - Evidence: SessionStore.swift:101-102
- Failure: Invalid recovery JSON
  - Where detected: JSON parsing
  - Current handling (as evidenced): Exception caught, no recovery
  - User-visible outcome (if any): No recovery prompt
  - Evidence: SessionStore.swift:173-183
- Failure: Recoverable session load fails
  - Where detected: Snapshot read
  - Current handling (as evidenced): Log error, return nil
  - User-visible outcome (if any): Cannot recover session
  - Evidence: SessionStore.swift:193-201

## Data and Storage

- What data is produced/consumed: Session ID and timestamp for recovery
- Where it is stored (DB/files/userData/etc.): JSON file in sessions directory
- Retention / deletion controls (if documented): Exists during session, deleted on normal end

## Observability

- Logs/events emitted: Recovery check results, errors
- Correlation IDs / session IDs (if any): Session ID in marker and logs
- Metrics/traces (if any): None specific
- Evidence: SessionStore.swift NSLog statements

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: How is the recovery UI triggered?
- Documentation gaps: Recovery marker format, multiple recoverable sessions handling
- Test gaps to add (note only, no implementation): Test marker persistence across app restarts

