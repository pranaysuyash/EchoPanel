# AUD-006 Server-Side ASR Processing (faster-whisper)

## Summary
- Origin: Mixed
- Status: Implemented
- Consumes queued PCM16 audio chunks, buffers into 2-second chunks, runs faster-whisper inference with threading lock, emits final transcript segments with timestamps and confidence, handles end-of-stream processing with silence filtering.
- Boundaries crossed: Process (ASR inference) / Model (faster-whisper)
- Primary components: FasterWhisperProvider, WhisperModel, asyncio.to_thread

## Triggers and Preconditions
- Triggers: WebSocket session start, audio chunks available in queue
- Preconditions: faster-whisper available, model loaded, PCM16 stream at 16kHz

## Sequence (Happy Path)
1. ASR stream starts with config from environment
   - Evidence:
     - Code: server/services/asr_stream.py :: def _get_default_config() -> ASRConfig
     - Code: server/services/asr_stream.py :: config = _get_default_config()

2. Get available provider from registry
   - Evidence:
     - Code: server/services/asr_stream.py :: provider = ASRProviderRegistry.get_provider(config=config)
     - Code: server/services/asr_providers.py :: class ASRProviderRegistry

3. If provider unavailable, emit status and drain stream
   - Evidence:
     - Code: server/services/asr_stream.py :: if provider is None or not provider.is_available
     - Code: server/services/asr_stream.py :: yield {"type": "status", "state": "no_asr_provider"}

4. Convert source string to AudioSource enum
   - Evidence:
     - Code: server/services/asr_stream.py :: if source == "system": audio_source = AudioSource.SYSTEM

5. Call provider.transcribe_stream with PCM iterator
   - Evidence:
     - Code: server/services/asr_stream.py :: async for segment in provider.transcribe_stream(pcm_stream, sample_rate, audio_source)
     - Code: server/services/provider_faster_whisper.py :: async def transcribe_stream

6. Buffer incoming PCM16 bytes into chunk_bytes (2s * 16000 * 2)
   - Evidence:
     - Code: server/services/provider_faster_whisper.py :: chunk_bytes = int(sample_rate * chunk_seconds * bytes_per_sample)
     - Code: server/services/provider_faster_whisper.py :: buffer.extend(chunk)

7. When buffer has full chunk, extract and convert to float32
   - Evidence:
     - Code: server/services/provider_faster_whisper.py :: audio = np.frombuffer(audio_bytes, dtype=np.int16).astype(np.float32) / 32768.0

8. Run inference in thread with lock to serialize
   - Evidence:
     - Code: server/services/provider_faster_whisper.py :: segments, info = await asyncio.to_thread(_transcribe)
     - Code: server/services/provider_faster_whisper.py :: with self._infer_lock

9. Process segments, compute confidence from avg_logprob
   - Evidence:
     - Code: server/services/provider_faster_whisper.py :: confidence = max(0.0, min(1.0, 1.0 + avg_logprob / 2.0))

10. Yield ASRSegment with adjusted timestamps
    - Evidence:
      - Code: server/services/provider_faster_whisper.py :: yield ASRSegment(text=text, t0=t0 + segment.start, ...)
      - Code: server/services/asr_stream.py :: event = {"type": event_type, "t0": segment.t0, ...}

11. At end of stream, process remaining buffer if large enough
    - Evidence:
      - Code: server/services/provider_faster_whisper.py :: if len(audio_bytes) < min_final_bytes: return

## Inputs and Outputs
- Inputs: AsyncIterator[bytes] of PCM16 chunks, sample_rate, source tag
- Outputs: AsyncIterator[dict] of ASR events (partial/final)
- Side effects: Model inference in thread, inference time tracking, chunk counting

## Failure Modes
- Provider unavailable:
  - Where detected: ASRProviderRegistry.get_provider returns None or not is_available
  - Current handling: Emit status event, drain stream
  - User-visible outcome: "ASR provider unavailable" status
  - Evidence: Code: server/services/asr_stream.py :: if provider is None or not provider.is_available

- Model loading failure:
  - Where detected: WhisperModel() init throws
  - Current handling: Exception logged, health updated, re-raised
  - User-visible outcome: ASR fails for session
  - Evidence: Code: server/services/provider_faster_whisper.py :: except Exception as e: self._health.last_error = str(e)

- Inference failure:
  - Where detected: model.transcribe() throws
  - Current handling: Exception propagates, stream ends
  - User-visible outcome: ASR stops working
  - Evidence: Code: server/services/provider_faster_whisper.py :: segments, info = await asyncio.to_thread(_transcribe)

- Empty segments:
  - Where detected: segment.text.strip() is empty
  - Current handling: Skip segment
  - User-visible outcome: No transcript for that chunk
  - Evidence: Code: server/services/provider_faster_whisper.py :: if not text: continue

- Final chunk too small:
  - Where detected: len(audio_bytes) < min_final_bytes
  - Current handling: Skip processing
  - User-visible outcome: Final audio not transcribed
  - Evidence: Code: server/services/provider_faster_whisper.py :: if len(audio_bytes) < min_final_bytes: return

- Low energy final chunk:
  - Where detected: audio_energy < 0.01
  - Current handling: Skip processing
  - User-visible outcome: Silence not transcribed
  - Evidence: Code: server/services/provider_faster_whisper.py :: if audio_energy < 0.01: return

- Threading issues:
  - Where detected: asyncio.to_thread fails
  - Current handling: Exception propagates
  - User-visible outcome: ASR processing stops
  - Evidence: Assumed - no explicit handling

## Data and Storage
- Byte buffer for chunking (grows until chunk_bytes)
- Inference lock (threading.Lock)
- Inference time history (last 100 measurements)
- No persistent storage

## Observability
- Debug logging: Chunk processing, inference times, language detection
- Health metrics: Model resident, load time, error counts
- Inference performance tracking
- No direct metrics emission

## Open Questions and Follow-up Tasks
- Partial results: Only finals emitted, no streaming partials
- VAD filtering: Applied per chunk, may miss cross-chunk speech
- Confidence calculation: Heuristic from avg_logprob
- Test gaps: Model loading failures, threading concurrency</content>
<parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/AUD-006.md