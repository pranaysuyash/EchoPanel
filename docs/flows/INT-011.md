# INT-011 Citation/Grounding Flow

## Summary

- Origin: Code-only
- Status: Implemented (basic only)
- 1â€“2 sentence description: Extracts entities and action/decision/risk cards from transcript segments, attaching grounding quotes and evidence pointers to source transcript for verifiability.
- Boundaries crossed: Process (analysis service), Pipeline (ASR output to analysis)
- Primary components (coarse list): analysis_stream.py, ws_live_listener.py

## Triggers and Preconditions

- Triggers: Real-time analysis loop (entities every 12s, cards every 28s), Session-end finalization
- Preconditions: Transcript segments available in session state, analysis tasks running

## Sequence (Happy Path)

1. Analysis loop triggers periodically or at session end
   - Evidence:
     - Code: server/api/ws_live_listener.py :: \_analysis_loop (lines 518-560)
     - Code: server/api/ws_live_listener.py :: session finalization (lines 910-914)
2. Create snapshot of current transcript segments
   - Evidence:
     - Code: server/api/ws_live_listener.py :: snapshot = list(state.transcript)
3. Extract entities from snapshot using sliding window (10min)
   - Evidence:
     - Code: server/services/analysis_stream.py :: extract_entities (lines 165-358)
4. For each detected entity, collect up to 3 grounding quotes from source segments
   - Evidence:
     - Code: server/services/analysis_stream.py :: entity.grounding_quotes.append(text[:100]) (multiple locations)
5. Extract cards (actions/decisions/risks) from snapshot using sliding window
   - Evidence:
     - Code: server/services/analysis_stream.py :: extract_cards (lines 101-163)
6. For each detected card, attach evidence with t0/t1/quote from source segment
   - Evidence:
     - Code: server/services/analysis_stream.py :: evidence=[{"t0": t0, "t1": t1, "quote": text}] (lines 125-145)
7. Send entity/card updates to client or include in final summary JSON
   - Evidence:
     - Code: server/api/ws_live_listener.py :: ws_send entities_update/cards_update (lines 530, 548)
     - Code: server/api/ws_live_listener.py :: final_summary includes entities/cards (lines 918-925)

## Inputs and Outputs

- Inputs: Transcript segments (list[dict] with "text", "t0", "t1", "confidence" fields)
- Outputs: Entities dict with grounding quotes, Cards dict with evidence pointers
- Side effects (writes, network calls, model loads, UI state changes): WebSocket messages sent to client with analysis updates

## Failure Modes

- Failure: Entity/card extraction times out (>10-15s)
  - Where detected: asyncio.wait_for timeout in \_analysis_loop
  - Current handling: Skip cycle, log warning, send status message
  - User-visible outcome: "Analysis delayed" status, missing updates
  - Evidence: server/api/ws_live_listener.py :: TimeoutError handling (lines 527-532, 541-546)
- Failure: Invalid transcript data (missing fields)
  - Where detected: extract_entities/extract_cards functions
  - Current handling: Functions use .get() with defaults, continue processing
  - User-visible outcome: Incomplete analysis results
  - Evidence: server/services/analysis_stream.py :: segment.get("text", "") etc.
- Failure: Analysis tasks cancelled during shutdown
  - Where detected: Session finalization
  - Current handling: Timeout on gather, log warning
  - User-visible outcome: None (session ending)
  - Evidence: server/api/ws_live_listener.py :: timeout on analysis_tasks gather (lines 884-890)

## Data and Storage

- What data is produced/consumed: Grounding quotes (strings), evidence pointers (t0/t1 dicts)
- Where it is stored (DB/files/userData/etc.): In-memory during session, included in final JSON export to filesystem
- Retention / deletion controls: Session-scoped, deleted on session end unless exported

## Observability

- Logs/events emitted: Timeout warnings, processing delays
- Correlation IDs / session IDs: Session ID in final summary
- Metrics/traces: Processing time tracking (asr_processing_times), but not specifically for grounding
- Evidence: server/api/ws_live_listener.py :: logger.warning calls, state.asr_processing_times

## Open Questions and Follow-up Tasks

- Questions: How to validate grounding accuracy? What if transcript changes after grounding?
- Documentation gaps: No user-facing docs on grounding feature
- Test gaps: No unit tests for grounding quote collection, no integration tests for evidence pointers
