# OBS-001 Structured Logging Flow (Swift Client)

## Summary

- Origin: Code-only
- Status: Implemented
- Client captures structured JSON logs with correlation IDs, PII redaction, and multi-sink output (console, file, OSLog) for observability.
- Boundaries crossed: Storage (file system), OS (OSLog)
- Primary components (coarse list): StructuredLogger, CorrelationContext

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): Any log call (debug, info, warning, error, critical)
- Preconditions (permissions, settings flags, availability, model cached, etc.): StructuredLogger initialized

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. Logging method called with message and metadata
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: debug/info/warning/error/critical methods
     - Docs: docs/OBSERVABILITY_IMPLEMENTATION.md :: Structured logging with correlation IDs
   - Notes: Methods include file, function, line for context

1. Level check performed against minimum threshold
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: guard level >= configuration.minLevel
   - Notes: Early return for filtered messages

1. Correlation context retrieved from current context
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: currentContext.toDictionary()
     - Docs: docs/OBSERVABILITY_IMPLEMENTATION.md :: Correlation IDs automatically included
   - Notes: Session, attempt, connection IDs

1. Log entry built as JSON structure
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: var entry: [String: Any] with timestamp, level, message, etc.
   - Notes: Includes component, function, line from caller

1. PII redaction applied to message and metadata
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: redact() method with patterns for tokens
     - Docs: docs/flow-atlas-20260211.md :: Structured logging with redaction
   - Notes: API keys, tokens replaced with \*\*\*

1. Entry written to all enabled sinks (OSLog, console, file)
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: writeToOSLog, writeToConsole, writeToFile
   - Notes: Multi-sink output for different consumers

## Inputs and Outputs

- Inputs:
  - Log level, message, optional error, metadata
  - Current correlation context
- Outputs:
  - JSON log entry to multiple sinks
  - Redacted sensitive information
- Side effects (writes, network calls, model loads, UI state changes): File writes for log rotation, OSLog entries

## Failure Modes

List 5â€“10 realistic failures:

- Failure: File write fails due to disk full
  - Where detected: writeToFile error handling
  - Current handling (as evidenced): Continues with other sinks
  - User-visible outcome (if any): Logs still go to console/OSLog
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? fileHandle.write() (optional)

- Failure: Redaction regex fails
  - Where detected: NSRegularExpression creation
  - Current handling (as evidenced): try? optional, continues without redaction
  - User-visible outcome (if any): Unredacted sensitive data in logs
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: try? NSRegularExpression

- Failure: JSON serialization fails
  - Where detected: JSONSerialization.jsonObject creation
  - Current handling (as evidenced): No explicit error handling for serialization
  - User-visible outcome (if any): Log entry may be malformed
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: JSONSerialization not used for output

- Failure: Log level filtering too restrictive
  - Where detected: Configuration minLevel too high
  - Current handling (as evidenced): Messages filtered out silently
  - User-visible outcome (if any): Missing debug information
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: guard level >= configuration.minLevel

- Failure: Correlation context not set
  - Where detected: currentContext.isEmpty check
  - Current handling (as evidenced): Context omitted from log entry
  - User-visible outcome (if any): Logs lack correlation IDs
  - Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: if !currentContext.isEmpty

## Data and Storage

- What data is produced/consumed: Log entries with timestamps, correlation IDs, metadata
- Where it is stored (DB/files/userData/etc.): Rotating log files in app data directory
- Retention / deletion controls (if documented): Max file size 10MB, max 5 files, automatic rotation

## Observability

- Logs/events emitted: Self-logging not implemented (to avoid recursion)
- Correlation IDs / session IDs (if any): Included in every log entry context
- Metrics/traces (if any): None (logging itself not metered)
  Evidence: Code: macapp/MeetingListenerApp/Sources/StructuredLogger.swift :: No self-logging calls

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: How are logs shipped to external systems?
- Documentation gaps to fill: Log aggregation and monitoring setup
- Test gaps to add (note only, no implementation): Test log redaction patterns work correctly</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/OBS-001.md
