# EXT-003 Microphone Permission Request

## Summary

- Origin: Code-only
- Status: Implemented
- User-triggered permission request for macOS Microphone access required for microphone audio capture via AVAudioEngine. Displays native macOS permission dialog.
- Boundaries crossed: UI (permission dialog) / OS (macOS TCC permissions)
- Primary components (coarse list): AppState, MicrophoneCaptureManager

## Triggers and Preconditions

- Triggers: Session start when audioSource includes .microphone (microphone audio capture needed)
- Preconditions: macOS AVFoundation available, app not already having permission

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. User initiates session start with microphone audio source
   - Evidence:
     - Code: AppState.swift :: startSession() :: if audioSource == .microphone || audioSource == .both
     - Docs: flow-atlas-20260211.md :: EXT-003 Microphone Permission Request

1. App requests microphone permission via AVCaptureDevice.requestAccess(for: .audio)
   - Evidence:
     - Code: AppState.swift :: startSession() :: let micGranted = await micCapture.requestPermission()
     - Code: MicrophoneCaptureManager.swift :: requestPermission() :: AVCaptureDevice.requestAccess(for: .audio)

1. Update permission state in AppState based on grant result
   - Evidence:
     - Code: AppState.swift :: startSession() :: microphonePermission = micGranted ? .authorized : .denied

1. Proceed with session if permission granted, abort if denied
   - Evidence:
     - Code: AppState.swift :: startSession() :: guard micGranted else { setSessionError(.microphonePermissionRequired) }

## Inputs and Outputs

- Inputs: audioSource configuration (.microphone or .both)
- Outputs: Updated microphonePermission state (.authorized or .denied)
- Side effects (writes, network calls, model loads, UI state changes): macOS permission dialog displayed, permission status published via @Published property

## Failure Modes

List 5â€“10 realistic failures:

- Failure: User denies permission in macOS dialog
  - Where detected: AVCaptureDevice.requestAccess returns false
  - Current handling (as evidenced): Set session error .microphonePermissionRequired, abort session start
  - User-visible outcome (if any): Error message "Microphone permission required for Microphone audio"
  - Evidence: AppState.swift :: setSessionError(.microphonePermissionRequired)

- Failure: AVFoundation system unavailable or malfunctioning
  - Where detected: AVCaptureDevice.requestAccess throws or callback not invoked
  - Current handling (as evidenced): Continuation may hang or return false, session fails
  - User-visible outcome (if any): Generic session start failure
  - Evidence: MicrophoneCaptureManager.swift :: withCheckedContinuation

## Data and Storage

- What data is produced/consumed: Permission boolean state (authorized/denied)
- Where it is stored (DB/files/userData/etc.): In-memory AppState.microphonePermission, persisted via macOS TCC database
- Retention / deletion controls (if documented): macOS system-managed, user can revoke in System Settings

## Observability

- Logs/events emitted: StructuredLogger warnings for permission issues
- Correlation IDs / session IDs (if any): Session ID logged in permission check context
- Metrics/traces (if any): None specific to permissions
  Evidence: AppState.swift :: StructuredLogger.shared.info("Session starting", metadata: ["audio_source": ...])

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: How does permission state persist across app restarts? What happens if user grants permission mid-session?
- Documentation gaps to fill: Detailed AVFoundation permission behavior documentation
- Test gaps to add (note only, no implementation): Test permission revocation during active session</content>
  <parameter name="filePath">/Users/pranay/Projects/EchoPanel/docs/flows/EXT-003.md
