# NET-009 TLS Connection Establishment

## Summary

- Origin: Code-only
- Status: Implemented
- Client automatically selects secure WebSocket scheme (WSS) for remote backends, falling back to unencrypted (WS) for localhost development.
- Boundaries crossed: Network
- Primary components (coarse list): BackendConfig, URLSessionWebSocketTask

## Triggers and Preconditions

- Triggers (user action, event, schedule, startup, etc.): WebSocket connection attempt
- Preconditions (permissions, settings flags, availability, model cached, etc.): Backend host configured, network available

## Sequence (Happy Path)

Use numbered sequence. Each step must include evidence.
For each step:

1. <what happens>
   - Evidence:
     - Code: path :: symbol/event/string
     - Docs: path :: heading/snippet
   - Notes: (only if needed)

1. BackendConfig determines if host is localhost
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: isLocalHost checks for 127.0.0.1, localhost, ::1
     - Docs: docs/FEATURES.md :: Non-local backend defaults to secure schemes (wss/https)
   - Notes: Security boundary: localhost unencrypted, remote encrypted

1. Selects appropriate WebSocket scheme
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: webSocketScheme = isLocalHost ? "ws" : "wss"
   - Notes: WSS for remote, WS for local development

1. URL constructed with selected scheme
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: buildURL() sets components.scheme
   - Notes: URLComponents handles scheme selection

1. URLSessionWebSocketTask created with URL
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: session.webSocketTask(with: url)
   - Notes: URLSession handles TLS negotiation automatically

1. TLS handshake occurs for WSS connections
   - Evidence:
     - Code: URLSession automatic TLS handling (no explicit code)
     - Docs: docs/SECURITY.md :: Production must use wss:// with valid TLS
   - Notes: System trust store used for certificate validation

1. Connection proceeds with appropriate security level
   - Evidence:
     - Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: task?.resume()
   - Notes: Secure for remote, fast for local development

## Inputs and Outputs

- Inputs:
  - Backend host configuration
  - Localhost detection result
- Outputs:
  - WebSocket URL with correct scheme
  - Established secure/unsecure connection
- Side effects (writes, network calls, model loads, UI state changes): TLS handshake for remote connections

## Failure Modes

List 5â€“10 realistic failures:

- Failure: Invalid TLS certificate on remote backend
  - Where detected: URLSession TLS handshake fails
  - Current handling (as evidenced): Connection fails with error
  - User-visible outcome (if any): WebSocket connection error, reconnection attempts
  - Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: handleError() on connection failure

- Failure: TLS required but backend serves WS only
  - Where detected: Client expects WSS but server provides WS
  - Current handling (as evidenced): Connection fails immediately
  - User-visible outcome (if any): "Cannot connect to backend" error
  - Evidence: Code: URLSession enforces scheme matching

- Failure: Localhost misclassified as remote
  - Where detected: isLocalHost returns false for 127.0.0.1
  - Current handling (as evidenced): Attempts WSS to localhost
  - User-visible outcome (if any): Connection fails (no TLS on localhost server)
  - Evidence: Code: macapp/MeetingListenerApp/Sources/BackendConfig.swift :: isLocalHost logic

- Failure: Remote host configured but no TLS support
  - Where detected: Backend doesn't support WSS
  - Current handling (as evidenced): Connection fails
  - User-visible outcome (if any): Persistent connection failures
  - Evidence: Code: BackendConfig always uses WSS for non-localhost

- Failure: Certificate expired or revoked
  - Where detected: TLS validation fails
  - Current handling (as evidenced): Connection rejected
  - User-visible outcome (if any): "Secure connection failed" error
  - Evidence: Code: URLSession default TLS validation

## Data and Storage

- What data is produced/consumed: Host configuration, scheme selection
- Where it is stored (DB/files/userData/etc.): UserDefaults for backend host/port
- Retention / deletion controls (if documented): Persisted in user preferences

## Observability

- Logs/events emitted: URL scheme logged in connection metadata
- Correlation IDs / session IDs (if any): None for TLS establishment
- Metrics/traces (if any): None (not tracked as metrics)
  Evidence: Code: macapp/MeetingListenerApp/Sources/WebSocketStreamer.swift :: StructuredLogger.shared.info("WebSocket connecting", metadata: ["url_scheme": ...])

## Open Questions and Follow-up Tasks

- Questions that cannot be answered from current evidence: What TLS versions are supported?
- Documentation gaps to fill: Server TLS configuration requirements
- Test gaps to add (note only, no implementation): Test TLS certificate validation behavior

